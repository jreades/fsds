<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Practical 11: Dimensions in Data – Foundations of Spatial Data Science</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="..//img/favicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-fb446d74831b8ff67c69632cb314b545.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-c734b2b4d74e7e594e143a63449c09f7.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<meta property="og:title" content="Practical 11: Dimensions in Data – Foundations of Spatial Data Science">
<meta property="og:description" content="Transformation &amp; Dimensionality Reduction">
<meta property="og:image" content="img/logo/full_sm.png">
<meta property="og:site_name" content="Foundations">
<meta property="og:locale" content="en_GB">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-md " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../img/logo/logo_only_sm.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Foundations of Spatial Data Science</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../setup/index.html"> 
<span class="menu-text">Setup</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-week-by-week" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Week-by-Week</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-week-by-week">    
        <li>
    <a class="dropdown-item" href="../sessions/index.html">
 <span class="dropdown-text">Overview</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">Part 1: Foundations</li>
        <li>
    <a class="dropdown-item" href="../sessions/week1.html">
 <span class="dropdown-text">1. Setting Up</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../sessions/week2.html">
 <span class="dropdown-text">2. Foundations (Pt.1)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../sessions/week3.html">
 <span class="dropdown-text">3. Foundations (Pt.2)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../sessions/week4.html">
 <span class="dropdown-text">4. Efficient Code</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../sessions/week5.html">
 <span class="dropdown-text">5. Objects</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../sessions/reading_week.html">
 <span class="dropdown-text">Reading Week</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">Part 2: Process</li>
        <li>
    <a class="dropdown-item" href="../sessions/week6.html">
 <span class="dropdown-text">6. Numeric Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../sessions/week7.html">
 <span class="dropdown-text">7. Spatial Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../sessions/week8.html">
 <span class="dropdown-text">8. Textual Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../sessions/week9.html">
 <span class="dropdown-text">9. Selecting Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../sessions/week10.html">
 <span class="dropdown-text">10. Presenting Data</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">Part 3: Bonus</li>
        <li>
    <a class="dropdown-item" href="../sessions/week11.html">
 <span class="dropdown-text">11. Dimensions in Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../sessions/week12.html">
 <span class="dropdown-text">12. Grouping Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../references.html">
 <span class="dropdown-text">Bibliography</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-assessments" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Assessments</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-assessments">    
        <li>
    <a class="dropdown-item" href="../assessments/index.html">
 <span class="dropdown-text">Overview</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">Elements</li>
        <li>
    <a class="dropdown-item" href="../assessments/exam.html">
 <span class="dropdown-text">Timed Open Book Exam</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../assessments/group.html">
 <span class="dropdown-text">Group Work</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../assessments/peer.html">
 <span class="dropdown-text">Group Self-Evaluation</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../help.html"> 
<span class="menu-text">Getting Help</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#preamble" id="toc-preamble" class="nav-link active" data-scroll-target="#preamble">Preamble</a></li>
  <li><a href="#loading-msoa-census-data" id="toc-loading-msoa-census-data" class="nav-link" data-scroll-target="#loading-msoa-census-data">Loading MSOA Census Data</a></li>
  <li><a href="#splitting-into-test-train" id="toc-splitting-into-test-train" class="nav-link" data-scroll-target="#splitting-into-test-train">Splitting into Test &amp; Train</a></li>
  <li><a href="#normalisation" id="toc-normalisation" class="nav-link" data-scroll-target="#normalisation">Normalisation</a></li>
  <li><a href="#standardisation" id="toc-standardisation" class="nav-link" data-scroll-target="#standardisation">Standardisation</a></li>
  <li><a href="#non-linear-transformations" id="toc-non-linear-transformations" class="nav-link" data-scroll-target="#non-linear-transformations">Non-Linear Transformations</a></li>
  <li><a href="#principal-components-analysis" id="toc-principal-components-analysis" class="nav-link" data-scroll-target="#principal-components-analysis">Principal Components Analysis</a></li>
  <li><a href="#umap" id="toc-umap" class="nav-link" data-scroll-target="#umap">UMAP</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/jreades/fsds/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div><div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="Practical-11-Dimensions_in_Data.ipynb" download="Practical-11-Dimensions_in_Data.ipynb"><i class="bi bi-journal-code"></i>Jupyter</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Practical 11: Dimensions in Data</h1>
<p class="subtitle lead">Transformation &amp; Dimensionality Reduction</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<style type="text/css">
.longform {
    max-height: 300px;
    overflow-y: scroll;
}
</style>
<p>In this session the focus is on MSOA-level Census data from 2011. We’re going to explore this as a <em>possible</em> complement to the InsideAirbnb data. Although it’s not ideal to use 2011 data with scraped from Airbnb this year, we:</p>
<ol type="1">
<li>Have little choice as the 2021 data is only just starting to come through from the Census and the London Data Store hasn’t been updated (still!); and</li>
<li>Could usefully do a bit of thinking about whether the situation in 2011 might in some way help us to ‘predict’ the situation now…</li>
</ol>
<p>Ultimately, however, you don’t <em>need</em> to use this for your analysis, this practical is intended as a demonstration of how transformation and dimensionality reduction work in practice and the kinds of issues that come up.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
🔗 Connections
</div>
</div>
<div class="callout-body-container callout-body">
<p>There are a <em>lot</em> of links across sessions now, as well as some <em>forward links</em> to stuff we’ve not yet covered (see: <code>pandas.merge</code>). We’ll pick these up as we move through the notebook.</p>
</div>
</div>
<section id="preamble" class="level1">
<h1>Preamble</h1>
<p>Let’s start with the usual bits of code to ensure plotting works, to import packages and load the data into memory.</p>
<div id="5c5ee843" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="im">import</span> os</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="im">import</span> re</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-7"><a href="#cb1-7"></a></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="im">import</span> matplotlib.cm <span class="im">as</span> cm</span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-10"><a href="#cb1-10"></a></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> RobustScaler</span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> PowerTransformer</span>
<span id="cb1-14"><a href="#cb1-14"></a></span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="im">import</span> umap</span>
<span id="cb1-16"><a href="#cb1-16"></a><span class="im">from</span> kneed <span class="im">import</span> knee_locator</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice here that we’ve moved the function from last week’s notebook to a separate file <code>cache.py</code> from which we import the <code>cache_data</code> function. This should give you some ideas about how to work from script -&gt; function -&gt; library effectively.</p>
<div id="6e49a14c" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a><span class="im">from</span> cache <span class="im">import</span> cache_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="loading-msoa-census-data" class="level1">
<h1>Loading MSOA Census Data</h1>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
🔗 Connections
</div>
</div>
<div class="callout-body-container callout-body">
<p>By this point you should be fairly familiar with the UK’s census geographies as you’ll have encountered them in your GIS module. But in case you need a refresher, here’s what the <a href="https://www.ons.gov.uk/methodology/geography/ukgeographies/censusgeographies/census2021geographies">Office for National Statistics</a> says.</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>We’re going to mix in the London’s MSOA ‘Atlas’ from the <a href="https://data.london.gov.uk/dataset">London Data Store</a>. I would <em>strongly</em> suggest that you have a look around the London Data Store as you develop your thinking for the group assessment – you will likely find useful additional data there!</p>
</div>
</div>
<p>Once you see how we deal with this MSOA Atlas data you will be in a position to work with any other similarly complex (in terms of the headings and indexes) data set. If you’re feeling particularly ambitious you can actually do this <em>same</em> work at the LSOA scale using the <a href="https://data.london.gov.uk/dataset/lsoa-atlas">LSOA Atlas</a> and LSOA boundaries… the process should be the same, though you will have smaller samples in each LSOA than you do in the MSOAs and calculations will take a bit longer to complete. You could also search on the ONS Census web site for data from 2021.</p>
<p>There is a CSV file for the MSOA Atlas that would be easier to work with; however, the Excel file is useful for demonstrating how to work with multi-level indexes (an extension of last week’s work). Notice that below we do two new things when reading the XLS file:</p>
<ol type="1">
<li>We have to specify a sheet name because the file contains multiple sheets.</li>
<li>We have to specify not just <em>one</em> header, we actually have to specify three of them which generates a multi-level index (row 0 is the top-level, row 1 is the second-level, etc.).</li>
</ol>
<section id="load-msoa-excel-file" class="level2">
<h2 class="anchored" data-anchor-id="load-msoa-excel-file">Load MSOA Excel File</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Difficulty level: Low.
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">

</div>
</div>
</div>
<p>You might like to load the cached copy of the file into Excel so that you can see how the next bit works. You can find the rest of the MSOA Atlas <a href="https://data.london.gov.uk/dataset/msoa-atlas">here</a>.</p>
<div id="18e5e68e" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a>src_url   <span class="op">=</span> <span class="st">'https://data.london.gov.uk/download/msoa-atlas/39fdd8eb-e977-4d32-85a4-f65b92f29dcb/msoa-data.xls'</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>dest_path <span class="op">=</span> os.path.join(<span class="st">'data'</span>,<span class="st">'msoa'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">Question</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Answer</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a>excel_atlas <span class="op">=</span> pd.read_excel(</span>
<span id="cb4-2"><a href="#cb4-2"></a>    cache_data(src_url, dest_path), </span>
<span id="cb4-3"><a href="#cb4-3"></a>    ???, <span class="co"># Which sheet is the data in?</span></span>
<span id="cb4-4"><a href="#cb4-4"></a>    header<span class="op">=</span>[<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>])            <span class="co"># Where are the column names... there's three of them!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div id="7ddaf469" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a>excel_atlas <span class="op">=</span> pd.read_excel(</span>
<span id="cb5-2"><a href="#cb5-2"></a>    cache_data(src_url, dest_path),</span>
<span id="cb5-3"><a href="#cb5-3"></a>    sheet_name<span class="op">=</span><span class="st">'iadatasheet1'</span>, <span class="co"># Which sheet is the data in?</span></span>
<span id="cb5-4"><a href="#cb5-4"></a>    header<span class="op">=</span>[<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>])            <span class="co"># Where are the column names... there's three of them!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Found data/msoa/msoa-data.xls locally!
    Size is 2 MB (1,979,904 bytes)</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Notice the format of the output and notice that all of the empty cells in the Excel sheet have come through as <code>Unnamed: &lt;col_no&gt;_level_&lt;level_no&gt;</code>:</p>
<div id="af07cb6f" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a>excel_atlas.head(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Unnamed: 0_level_0</th>
<th data-quarto-table-cell-role="th">Unnamed: 1_level_0</th>
<th colspan="7" data-quarto-table-cell-role="th" data-halign="left">Age Structure (2011 Census)</th>
<th data-quarto-table-cell-role="th">Mid-year Estimate totals</th>
<th data-quarto-table-cell-role="th">...</th>
<th colspan="10" data-quarto-table-cell-role="th" data-halign="left">Road Casualties</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Unnamed: 0_level_1</th>
<th data-quarto-table-cell-role="th">Unnamed: 1_level_1</th>
<th data-quarto-table-cell-role="th">All Ages</th>
<th data-quarto-table-cell-role="th">0-15</th>
<th data-quarto-table-cell-role="th">16-29</th>
<th data-quarto-table-cell-role="th">30-44</th>
<th data-quarto-table-cell-role="th">45-64</th>
<th data-quarto-table-cell-role="th">65+</th>
<th data-quarto-table-cell-role="th">Working-age</th>
<th data-quarto-table-cell-role="th">All Ages</th>
<th data-quarto-table-cell-role="th">...</th>
<th colspan="2" data-quarto-table-cell-role="th" data-halign="left">2010</th>
<th colspan="4" data-quarto-table-cell-role="th" data-halign="left">2011</th>
<th colspan="4" data-quarto-table-cell-role="th" data-halign="left">2012</th>
</tr>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">MSOA Code</th>
<th data-quarto-table-cell-role="th">MSOA Name</th>
<th data-quarto-table-cell-role="th">Unnamed: 2_level_2</th>
<th data-quarto-table-cell-role="th">Unnamed: 3_level_2</th>
<th data-quarto-table-cell-role="th">Unnamed: 4_level_2</th>
<th data-quarto-table-cell-role="th">Unnamed: 5_level_2</th>
<th data-quarto-table-cell-role="th">Unnamed: 6_level_2</th>
<th data-quarto-table-cell-role="th">Unnamed: 7_level_2</th>
<th data-quarto-table-cell-role="th">Unnamed: 8_level_2</th>
<th data-quarto-table-cell-role="th">2002</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">Slight</th>
<th data-quarto-table-cell-role="th">2010 Total</th>
<th data-quarto-table-cell-role="th">Fatal</th>
<th data-quarto-table-cell-role="th">Serious</th>
<th data-quarto-table-cell-role="th">Slight</th>
<th data-quarto-table-cell-role="th">2011 Total</th>
<th data-quarto-table-cell-role="th">Fatal</th>
<th data-quarto-table-cell-role="th">Serious</th>
<th data-quarto-table-cell-role="th">Slight</th>
<th data-quarto-table-cell-role="th">2012 Total</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>E02000001</td>
<td>City of London 001</td>
<td>7375.0</td>
<td>620.0</td>
<td>1665.0</td>
<td>2045.0</td>
<td>2010.0</td>
<td>1035.0</td>
<td>5720.0</td>
<td>7280.0</td>
<td>...</td>
<td>334.0</td>
<td>374.0</td>
<td>0.0</td>
<td>46.0</td>
<td>359.0</td>
<td>405.0</td>
<td>2.0</td>
<td>51.0</td>
<td>361.0</td>
<td>414.0</td>
</tr>
</tbody>
</table>

<p>1 rows × 207 columns</p>
</div>
</div>
</div>
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1"></a><span class="bu">print</span>(<span class="ss">f"Shape of the MSOA Atlas data frame is: </span><span class="sc">{</span>excel_atlas<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss"> x </span><span class="sc">{</span>excel_atlas<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">:,}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You should get: <code>Shape of the MSOA Atlas data frame is: 984 x 207</code>, but how on earth are you going to access the data?</p>
</section>
<section id="accessing-multiindexes" class="level2">
<h2 class="anchored" data-anchor-id="accessing-multiindexes">Accessing MultiIndexes</h2>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Difficulty: Moderate.
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The difficulty is conceptual, not technical.</p>
</div>
</div>
</div>
<p>Until now we have understood the pandas index as a single column-like ‘thing’ in a data frame, but pandas also supports hierarchical and grouped indexes that allow us to interact with data in more complex ways… should we need it. Generally:</p>
<ul>
<li>MultiIndex == hierarchical index on <em>columns</em></li>
<li>DataFrameGroupBy == iterable pseudo-hierarchical index on <em>rows</em></li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
🔗 Connections
</div>
</div>
<div class="callout-body-container callout-body">
<p>We’ll be looking at <strong>Grouping Data</strong> in much more detail in <a href="https://jreades.github.io/fsds/sessions/week9.html#lectures">next week</a>, so the main thing to remember is that grouping is for rows, multi-indexing is about columns.</p>
</div>
</div>
<section id="direct-access" class="level3">
<h3 class="anchored" data-anchor-id="direct-access">Direct Access</h3>
<p>Of course, one way to get at the data is to use <code>.iloc[...]</code> since that refers to columns by <em>position</em> and ignores the complexity of the index. Try printing out the the first five rows of the first column using <code>iloc</code>:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1"></a>excel_atlas.iloc[???]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You should get:</p>
<div id="113a04bd" class="cell" data-execution_count="6">
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>0    E02000001
1    E02000002
2    E02000003
3    E02000004
4    E02000005
Name: (Unnamed: 0_level_0, Unnamed: 0_level_1, MSOA Code), dtype: object</code></pre>
</div>
</div>
</section>
<section id="named-access" class="level3">
<h3 class="anchored" data-anchor-id="named-access">Named Access</h3>
<p>But to do it by name is a little trickier:</p>
<div id="471ac046" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1"></a>excel_atlas.columns.tolist()[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>[('Unnamed: 0_level_0', 'Unnamed: 0_level_1', 'MSOA Code'),
 ('Unnamed: 1_level_0', 'Unnamed: 1_level_1', 'MSOA Name'),
 ('Age Structure (2011 Census)', 'All Ages', 'Unnamed: 2_level_2'),
 ('Age Structure (2011 Census)', '0-15', 'Unnamed: 3_level_2'),
 ('Age Structure (2011 Census)', '16-29', 'Unnamed: 4_level_2')]</code></pre>
</div>
</div>
<p>Notice how asking for the first five columns has given us a list of… what exactly?</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true">Question</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false">Answer</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<p>So to get the <strong>same output</strong> by column <em>name</em> what do you need to copy from above:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1"></a>excel_atlas.loc[<span class="dv">0</span>:<span class="dv">5</span>, ???]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<div id="3df8c8da" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1"></a>excel_atlas.loc[<span class="dv">0</span>:<span class="dv">5</span>, (<span class="st">'Unnamed: 0_level_0'</span>,<span class="st">'Unnamed: 0_level_1'</span>,<span class="st">'MSOA Code'</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>0    E02000001
1    E02000002
2    E02000003
3    E02000004
4    E02000005
5    E02000007
Name: (Unnamed: 0_level_0, Unnamed: 0_level_1, MSOA Code), dtype: object</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>The answer is <em>really</em> awkward, so we’re going to look for a better way…</p>
</section>
<section id="grouped-access" class="level3">
<h3 class="anchored" data-anchor-id="grouped-access">Grouped Access</h3>
<p>Despite this, <em>one</em> way that MultiIndexes can be useful is for accessing column-slices from a ‘wide’ dataframe. We can, for instance, select all of the Age Structure columns in one go and it will be <em>simpler</em> than what we did above.</p>
<div id="1039b2a3" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1"></a>excel_atlas.loc[<span class="dv">0</span>:<span class="dv">5</span>, (<span class="st">'Age Structure (2011 Census)'</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">All Ages</th>
<th data-quarto-table-cell-role="th">0-15</th>
<th data-quarto-table-cell-role="th">16-29</th>
<th data-quarto-table-cell-role="th">30-44</th>
<th data-quarto-table-cell-role="th">45-64</th>
<th data-quarto-table-cell-role="th">65+</th>
<th data-quarto-table-cell-role="th">Working-age</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Unnamed: 2_level_2</th>
<th data-quarto-table-cell-role="th">Unnamed: 3_level_2</th>
<th data-quarto-table-cell-role="th">Unnamed: 4_level_2</th>
<th data-quarto-table-cell-role="th">Unnamed: 5_level_2</th>
<th data-quarto-table-cell-role="th">Unnamed: 6_level_2</th>
<th data-quarto-table-cell-role="th">Unnamed: 7_level_2</th>
<th data-quarto-table-cell-role="th">Unnamed: 8_level_2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>7375.0</td>
<td>620.0</td>
<td>1665.0</td>
<td>2045.0</td>
<td>2010.0</td>
<td>1035.0</td>
<td>5720.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>6775.0</td>
<td>1751.0</td>
<td>1277.0</td>
<td>1388.0</td>
<td>1258.0</td>
<td>1101.0</td>
<td>3923.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>10045.0</td>
<td>2247.0</td>
<td>1959.0</td>
<td>2300.0</td>
<td>2259.0</td>
<td>1280.0</td>
<td>6518.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>6182.0</td>
<td>1196.0</td>
<td>1277.0</td>
<td>1154.0</td>
<td>1543.0</td>
<td>1012.0</td>
<td>3974.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>8562.0</td>
<td>2200.0</td>
<td>1592.0</td>
<td>1995.0</td>
<td>1829.0</td>
<td>946.0</td>
<td>5416.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>8791.0</td>
<td>2388.0</td>
<td>1765.0</td>
<td>1867.0</td>
<td>1736.0</td>
<td>1035.0</td>
<td>5368.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="understanding-levels" class="level3">
<h3 class="anchored" data-anchor-id="understanding-levels">Understanding Levels</h3>
<p>This works because the MultiIndex tracks the columns using <em>levels</em>, with level 0 at the ‘top’ and level 2 (in our case) at the bottom. These are the unique <em>values</em> for the top level (‘row 0’):</p>
<div id="79a6080a" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1"></a>excel_atlas.columns.levels[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>Index(['Adults in Employment (2011 Census)', 'Age Structure (2011 Census)',
       'Car or van availability (2011 Census)',
       'Central Heating (2011 Census)', 'Country of Birth (2011)',
       'Dwelling type (2011)', 'Economic Activity (2011 Census)',
       'Ethnic Group (2011 Census)', 'Health (2011 Census)', 'House Prices',
       'Household Composition (2011)', 'Household Income Estimates (2011/12)',
       'Household Language (2011)', 'Households (2011)', 'Incidence of Cancer',
       'Income Deprivation (2010)', 'Land Area', 'Life Expectancy',
       'Lone Parents (2011 Census)', 'Low Birth Weight Births (2007-2011)',
       'Mid-year Estimate totals', 'Mid-year Estimates 2012, by age',
       'Obesity', 'Population Density', 'Qualifications (2011 Census)',
       'Religion (2011)', 'Road Casualties', 'Tenure (2011)',
       'Unnamed: 0_level_0', 'Unnamed: 1_level_0'],
      dtype='object')</code></pre>
</div>
</div>
<p>These are the <em>values</em> for those levels across the actual columns in the data frame, notice the repeated ‘Age Structure (2011 Census)’:</p>
<div id="27b5ee46" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1"></a>excel_atlas.columns.get_level_values(<span class="dv">0</span>)[:<span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>Index(['Unnamed: 0_level_0', 'Unnamed: 1_level_0',
       'Age Structure (2011 Census)', 'Age Structure (2011 Census)',
       'Age Structure (2011 Census)', 'Age Structure (2011 Census)',
       'Age Structure (2011 Census)', 'Age Structure (2011 Census)',
       'Age Structure (2011 Census)', 'Mid-year Estimate totals'],
      dtype='object')</code></pre>
</div>
</div>
<p>And here are the <em>values</em> for the second level of the index (‘row 1’ in the Excel file):</p>
<div id="21873728" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1"></a>excel_atlas.columns.get_level_values(<span class="dv">1</span>)[:<span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>Index(['Unnamed: 0_level_1', 'Unnamed: 1_level_1', 'All Ages', '0-15', '16-29',
       '30-44', '45-64', '65+', 'Working-age', 'All Ages'],
      dtype='object')</code></pre>
</div>
</div>
<p>By extension, if we drop a level 0 index then <em>all</em> of the columns that it supports at levels 1 and 2 are <em>also</em> dropped: so when we drop <code>Mid-year Estimate totals</code> from level 0 then all 11 of the ‘Mid-year Estimate totals (2002…2012)’ columns are dropped in one go.</p>
<div id="25c18372" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1"></a>excel_atlas[[<span class="st">'Mid-year Estimate totals'</span>]].head(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th colspan="11" data-quarto-table-cell-role="th" data-halign="left">Mid-year Estimate totals</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th"></th>
<th colspan="11" data-quarto-table-cell-role="th" data-halign="left">All Ages</th>
</tr>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">2002</th>
<th data-quarto-table-cell-role="th">2003</th>
<th data-quarto-table-cell-role="th">2004</th>
<th data-quarto-table-cell-role="th">2005</th>
<th data-quarto-table-cell-role="th">2006</th>
<th data-quarto-table-cell-role="th">2007</th>
<th data-quarto-table-cell-role="th">2008</th>
<th data-quarto-table-cell-role="th">2009</th>
<th data-quarto-table-cell-role="th">2010</th>
<th data-quarto-table-cell-role="th">2011</th>
<th data-quarto-table-cell-role="th">2012</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>7280.0</td>
<td>7115.0</td>
<td>7118.0</td>
<td>7131.0</td>
<td>7254.0</td>
<td>7607.0</td>
<td>7429.0</td>
<td>7472.0</td>
<td>7338.0</td>
<td>7412.0</td>
<td>7604.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>6333.0</td>
<td>6312.0</td>
<td>6329.0</td>
<td>6341.0</td>
<td>6330.0</td>
<td>6323.0</td>
<td>6369.0</td>
<td>6570.0</td>
<td>6636.0</td>
<td>6783.0</td>
<td>6853.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>9236.0</td>
<td>9252.0</td>
<td>9155.0</td>
<td>9072.0</td>
<td>9144.0</td>
<td>9227.0</td>
<td>9564.0</td>
<td>9914.0</td>
<td>10042.0</td>
<td>10088.0</td>
<td>10218.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="b1d906d5" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1"></a>test <span class="op">=</span> excel_atlas.drop(columns<span class="op">=</span>[<span class="st">'Mid-year Estimate totals'</span>], axis<span class="op">=</span><span class="dv">1</span>, level<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb24-2"><a href="#cb24-2"></a></span>
<span id="cb24-3"><a href="#cb24-3"></a><span class="bu">print</span>(<span class="ss">f"Excel source had </span><span class="sc">{</span>excel_atlas<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss"> columns."</span>)</span>
<span id="cb24-4"><a href="#cb24-4"></a><span class="bu">print</span>(<span class="ss">f"Test now has </span><span class="sc">{</span>test<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss"> columns."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Excel source had 207 columns.
Test now has 196 columns.</code></pre>
</div>
</div>
<div id="7f32da7f" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1"></a><span class="co"># Tidy up if the variable exists</span></span>
<span id="cb26-2"><a href="#cb26-2"></a><span class="cf">if</span> <span class="st">'test'</span> <span class="kw">in</span> <span class="bu">locals</span>():</span>
<span id="cb26-3"><a href="#cb26-3"></a>    <span class="kw">del</span>(test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="questions" class="level3">
<h3 class="anchored" data-anchor-id="questions">Questions</h3>
<ul>
<li>What data type is used for storing/accessing MultiIndexes?</li>
<li><em>Why</em> is this is the appropriate data type?</li>
<li>How (conceptually) are the header rows in Excel are mapped on to levels in pandas?</li>
</ul>
</section>
</section>
<section id="tidying-up" class="level2">
<h2 class="anchored" data-anchor-id="tidying-up">Tidying Up</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Difficulty level: Low
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Although there’s a lot of dealing with column names.</p>
</div>
</div>
</div>
<section id="dropping-named-levels" class="level3">
<h3 class="anchored" data-anchor-id="dropping-named-levels">Dropping Named Levels</h3>
<p>There’s a <em>lot</em> of data in the data frame that we don’t need for our Airbnb work, so let’s go a bit further with the dropping of column-groups using the MultiIndex.</p>
<div id="e5a015f9" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1"></a>to_drop <span class="op">=</span> [<span class="st">'Mid-year Estimate totals'</span>,<span class="st">'Mid-year Estimates 2012, by age'</span>,<span class="st">'Religion (2011)'</span>,</span>
<span id="cb27-2"><a href="#cb27-2"></a>           <span class="st">'Land Area'</span>,<span class="st">'Lone Parents (2011 Census)'</span>,<span class="st">'Central Heating (2011 Census)'</span>,<span class="st">'Health (2011 Census)'</span>,</span>
<span id="cb27-3"><a href="#cb27-3"></a>           <span class="st">'Low Birth Weight Births (2007-2011)'</span>,<span class="st">'Obesity'</span>,<span class="st">'Incidence of Cancer'</span>,<span class="st">'Life Expectancy'</span>,</span>
<span id="cb27-4"><a href="#cb27-4"></a>           <span class="st">'Road Casualties'</span>]</span>
<span id="cb27-5"><a href="#cb27-5"></a>tidy <span class="op">=</span> excel_atlas.drop(to_drop, axis<span class="op">=</span><span class="dv">1</span>, level<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb27-6"><a href="#cb27-6"></a><span class="bu">print</span>(<span class="ss">f"Shape of the MSOA Atlas data frame is now: </span><span class="sc">{</span>tidy<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> x </span><span class="sc">{</span>tidy<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Shape of the MSOA Atlas data frame is now: 984 x 111</code></pre>
</div>
</div>
<p>This should drop you down to 984 x 111. Notice below that the multi-level <em>index</em> has not changed but the multi-level <em>values</em> remaining have!</p>
<div id="a9af5be3" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1"></a><span class="bu">print</span>(<span class="ss">f"There are </span><span class="sc">{</span><span class="bu">len</span>(tidy.columns.levels[<span class="dv">0</span>].unique())<span class="sc">}</span><span class="ss"> categories."</span>) <span class="co"># The categories</span></span>
<span id="cb29-2"><a href="#cb29-2"></a><span class="bu">print</span>(<span class="ss">f"But only </span><span class="sc">{</span><span class="bu">len</span>(tidy.columns.get_level_values(<span class="dv">0</span>).unique())<span class="sc">}</span><span class="ss"> values."</span>) <span class="co">#&nbsp;The actual values</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>There are 30 categories.
But only 18 values.</code></pre>
</div>
</div>
</section>
<section id="selecting-columns-using-a-list-comprehension" class="level3">
<h3 class="anchored" data-anchor-id="selecting-columns-using-a-list-comprehension">Selecting Columns using a List Comprehension</h3>
<p>Now we need to drop all of the percentages from the data set. These can be found at level 1, though they are specified in a number of different ways so you’ll need to come up with a way to find them in the level 1 values using a list comprehension…</p>
<p>I’d suggest looking for: “(%)”, “%”, and “Percentages”. You may need to check both start and end of the string. You could also use a regular expression here instead of multiple tests. Either way <em>works</em>, but have a think about the tradeoffs between intelligibility, speed, and what <em>you</em> understand…</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" role="tab" aria-controls="tabset-3-1" aria-selected="true">Question</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" role="tab" aria-controls="tabset-3-2" aria-selected="false">Answer</a></li></ul>
<div class="tab-content">
<div id="tabset-3-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-3-1-tab">
<p>Selection using multiple logical tests:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1"></a>to_drop <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> tidy.columns.get_level_values(<span class="dv">1</span>) <span class="cf">if</span> (???)]</span>
<span id="cb31-2"><a href="#cb31-2"></a><span class="bu">print</span>(to_drop)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Selection using a regular expression:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1"></a><span class="bu">print</span>([x <span class="cf">for</span> x <span class="kw">in</span> tidy.columns.get_level_values(<span class="dv">1</span>) <span class="cf">if</span> re.search(???, x)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="tabset-3-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-2-tab">
<div id="76e54443" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1"></a>to_drop <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> tidy.columns.get_level_values(<span class="dv">1</span>) <span class="cf">if</span> (</span>
<span id="cb33-2"><a href="#cb33-2"></a>    x.endswith(<span class="st">"(%)"</span>) <span class="kw">or</span> x.startswith(<span class="st">"%"</span>) <span class="kw">or</span> x.endswith(<span class="st">"Percentages"</span>) <span class="kw">or</span> x.endswith(<span class="st">"%"</span>))]</span>
<span id="cb33-3"><a href="#cb33-3"></a><span class="bu">print</span>(to_drop)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['Percentages', 'Percentages', 'Percentages', 'Percentages', 'Percentages', 'White (%)', 'Mixed/multiple ethnic groups (%)', 'Asian/Asian British (%)', 'Black/African/Caribbean/Black British (%)', 'Other ethnic group (%)', 'BAME (%)', 'United Kingdom (%)', 'Not United Kingdom (%)', '% of people aged 16 and over in household have English as a main language', '% of households where no people in household have English as a main language', 'Owned: Owned outright (%)', 'Owned: Owned with a mortgage or loan (%)', 'Social rented (%)', 'Private rented (%)', 'Household spaces with at least one usual resident (%)', 'Household spaces with no usual residents (%)', 'Whole house or bungalow: Detached (%)', 'Whole house or bungalow: Semi-detached (%)', 'Whole house or bungalow: Terraced (including end-terrace) (%)', 'Flat, maisonette or apartment (%)', 'Economically active %', 'Economically inactive %', '% of households with no adults in employment: With dependent children', '% living in income deprived households reliant on means tested benefit', '% of people aged over 60 who live in pension credit households', 'No cars or vans in household (%)', '1 car or van in household (%)', '2 cars or vans in household (%)', '3 cars or vans in household (%)', '4 or more cars or vans in household (%)']</code></pre>
</div>
</div>
<div id="7598dedd" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1"></a><span class="bu">print</span>([x <span class="cf">for</span> x <span class="kw">in</span> tidy.columns.get_level_values(<span class="dv">1</span>) <span class="cf">if</span> re.search(<span class="st">"(?:%|Percentages)"</span>, x)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['Percentages', 'Percentages', 'Percentages', 'Percentages', 'Percentages', 'White (%)', 'Mixed/multiple ethnic groups (%)', 'Asian/Asian British (%)', 'Black/African/Caribbean/Black British (%)', 'Other ethnic group (%)', 'BAME (%)', 'United Kingdom (%)', 'Not United Kingdom (%)', '% of people aged 16 and over in household have English as a main language', '% of households where no people in household have English as a main language', 'Owned: Owned outright (%)', 'Owned: Owned with a mortgage or loan (%)', 'Social rented (%)', 'Private rented (%)', 'Household spaces with at least one usual resident (%)', 'Household spaces with no usual residents (%)', 'Whole house or bungalow: Detached (%)', 'Whole house or bungalow: Semi-detached (%)', 'Whole house or bungalow: Terraced (including end-terrace) (%)', 'Flat, maisonette or apartment (%)', 'Economically active %', 'Economically inactive %', '% of households with no adults in employment: With dependent children', '% living in income deprived households reliant on means tested benefit', '% of people aged over 60 who live in pension credit households', 'No cars or vans in household (%)', '1 car or van in household (%)', '2 cars or vans in household (%)', '3 cars or vans in household (%)', '4 or more cars or vans in household (%)']</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>With both you should get:</p>
<div class="longform">
<div id="3d2fa281" class="cell" data-execution_count="20">
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>['Percentages',
 'Percentages',
 'Percentages',
 'Percentages',
 'Percentages',
 'White (%)',
 'Mixed/multiple ethnic groups (%)',
 'Asian/Asian British (%)',
 'Black/African/Caribbean/Black British (%)',
 'Other ethnic group (%)',
 'BAME (%)',
 'United Kingdom (%)',
 'Not United Kingdom (%)',
 '% of people aged 16 and over in household have English as a main language',
 '% of households where no people in household have English as a main language',
 'Owned: Owned outright (%)',
 'Owned: Owned with a mortgage or loan (%)',
 'Social rented (%)',
 'Private rented (%)',
 'Household spaces with at least one usual resident (%)',
 'Household spaces with no usual residents (%)',
 'Whole house or bungalow: Detached (%)',
 'Whole house or bungalow: Semi-detached (%)',
 'Whole house or bungalow: Terraced (including end-terrace) (%)',
 'Flat, maisonette or apartment (%)',
 'Economically active %',
 'Economically inactive %',
 '% of households with no adults in employment: With dependent children',
 '% living in income deprived households reliant on means tested benefit',
 '% of people aged over 60 who live in pension credit households',
 'No cars or vans in household (%)',
 '1 car or van in household (%)',
 '2 cars or vans in household (%)',
 '3 cars or vans in household (%)',
 '4 or more cars or vans in household (%)']</code></pre>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
🔗 Connections
</div>
</div>
<div class="callout-body-container callout-body">
<p>See how regular expressions keep coming <a href="https://jreades.github.io/fsds/sessions/week7.html#lectures">baaaaaaaaack</a>? That said, you can also often make use of simple string functions like <code>startswith</code> and <code>endswith</code> for this problem.</p>
</div>
</div>
</section>
<section id="drop-by-level" class="level3">
<h3 class="anchored" data-anchor-id="drop-by-level">Drop by Level</h3>
<p>You now need to drop these columns using the <code>level</code> keyword as part of your drop command. You have plenty of examples of how to drop values in place, but I’d suggest <em>first</em> getting the command correct (maybe duplicate the cell below and change the code so that the result is saved to a dataframe called <code>test</code> before overwriting <code>tidy</code>?) and <em>then</em> saving the change.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-4-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-1" role="tab" aria-controls="tabset-4-1" aria-selected="true">Question</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-2" role="tab" aria-controls="tabset-4-2" aria-selected="false">Answer</a></li></ul>
<div class="tab-content">
<div id="tabset-4-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-4-1-tab">
<div class="sourceCode" id="cb38"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1"></a>tidy <span class="op">=</span> tidy.drop(to_drop, axis<span class="op">=</span><span class="dv">1</span>, level<span class="op">=</span>???)</span>
<span id="cb38-2"><a href="#cb38-2"></a><span class="bu">print</span>(<span class="ss">f"Shape of the MSOA Atlas data frame is now: </span><span class="sc">{</span>tidy<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> x </span><span class="sc">{</span>tidy<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="tabset-4-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-2-tab">
<div id="5ea737ce" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1"></a>tidy.drop(to_drop, axis<span class="op">=</span><span class="dv">1</span>, level<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb39-2"><a href="#cb39-2"></a><span class="bu">print</span>(<span class="ss">f"Shape of the MSOA Atlas data frame is now: </span><span class="sc">{</span>tidy<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> x </span><span class="sc">{</span>tidy<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Shape of the MSOA Atlas data frame is now: 984 x 76</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>The data frame should now be <code>984 x 76</code>. This is a <em>bit</em> more manageable though still a <em>lot</em> of data columns. Depending on what you decide to do for your final project you might want to revisit some of the columns that we dropped above…</p>
</section>
<section id="flattening-the-index" class="level3">
<h3 class="anchored" data-anchor-id="flattening-the-index">Flattening the Index</h3>
<p>Although this ia big improvement, you’ll have trouble saving or linking this data to other inputs. The problem is that Level 2 of the multi-index is mainly composed of ‘Unnamed’ values and so we need to merge it with Level 1 to simplify our data frame, and then merge <em>that</em> with level 0…</p>
<div id="28e4e1a6" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1"></a>tidy.columns.values[:<span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>array([('Unnamed: 0_level_0', 'Unnamed: 0_level_1', 'MSOA Code'),
       ('Unnamed: 1_level_0', 'Unnamed: 1_level_1', 'MSOA Name'),
       ('Age Structure (2011 Census)', 'All Ages', 'Unnamed: 2_level_2')],
      dtype=object)</code></pre>
</div>
</div>
<p>Let’s use code to sort this out!</p>
<div id="1e7306bb" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1"></a>new_cols <span class="op">=</span> []</span>
<span id="cb43-2"><a href="#cb43-2"></a><span class="cf">for</span> c <span class="kw">in</span> tidy.columns.values:</span>
<span id="cb43-3"><a href="#cb43-3"></a>    </span>
<span id="cb43-4"><a href="#cb43-4"></a>    <span class="co">#print(f"Column label: {c}")</span></span>
<span id="cb43-5"><a href="#cb43-5"></a>    l1 <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>c[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb43-6"><a href="#cb43-6"></a>    l2 <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>c[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb43-7"><a href="#cb43-7"></a>    l3 <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>c[<span class="dv">2</span>]<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb43-8"><a href="#cb43-8"></a>    </span>
<span id="cb43-9"><a href="#cb43-9"></a>    <span class="co"># The new column label</span></span>
<span id="cb43-10"><a href="#cb43-10"></a>    clabel <span class="op">=</span> <span class="st">''</span></span>
<span id="cb43-11"><a href="#cb43-11"></a>    </span>
<span id="cb43-12"><a href="#cb43-12"></a>    <span class="co"># Assemble new label from the levels</span></span>
<span id="cb43-13"><a href="#cb43-13"></a>    <span class="cf">if</span> <span class="kw">not</span> l1.startswith(<span class="st">"Unnamed"</span>):</span>
<span id="cb43-14"><a href="#cb43-14"></a>        l1 <span class="op">=</span> l1.replace(<span class="st">" (2011 Census)"</span>,<span class="st">''</span>).replace(<span class="st">" (2011)"</span>,<span class="st">''</span>).replace(<span class="st">"Household "</span>,<span class="st">''</span>).replace(<span class="st">"House Prices"</span>,<span class="st">''</span>).replace(<span class="st">"Car or van availability"</span>,<span class="st">'Vehicles'</span>).replace(<span class="st">' (2011/12)'</span>,<span class="st">''</span>)</span>
<span id="cb43-15"><a href="#cb43-15"></a>        l1 <span class="op">=</span> l1.replace(<span class="st">'Age Structure'</span>,<span class="st">'Age'</span>).replace(<span class="st">"Ethnic Group"</span>,<span class="st">''</span>).replace(<span class="st">'Dwelling type'</span>,<span class="st">''</span>).replace(<span class="st">'Income Estimates'</span>,<span class="st">''</span>)</span>
<span id="cb43-16"><a href="#cb43-16"></a>        clabel <span class="op">+=</span> l1</span>
<span id="cb43-17"><a href="#cb43-17"></a>    <span class="cf">if</span> <span class="kw">not</span> l2.startswith(<span class="st">"Unnamed"</span>):</span>
<span id="cb43-18"><a href="#cb43-18"></a>        l2 <span class="op">=</span> l2.replace(<span class="st">"Numbers"</span>,<span class="st">''</span>).replace(<span class="st">" House Price (£)"</span>,<span class="st">''</span>).replace(<span class="st">"Highest level of qualification: "</span>,<span class="st">''</span>).replace(<span class="st">"Annual Household Income (£)"</span>,<span class="st">'hh Income'</span>).replace(<span class="st">'Whole house or bungalow: '</span>,<span class="st">''</span>).replace(<span class="st">' qualifications'</span>,<span class="st">''</span>)</span>
<span id="cb43-19"><a href="#cb43-19"></a>        l2 <span class="op">=</span> l2.replace(<span class="st">'At least one person aged 16 and over in household has English as a main language'</span>,<span class="st">"1+ English as a main language"</span>).replace(<span class="st">"No people in household have English as a main language"</span>,<span class="st">"None have English as main language"</span>)</span>
<span id="cb43-20"><a href="#cb43-20"></a>        clabel <span class="op">+=</span> (<span class="st">'-'</span> <span class="cf">if</span> clabel <span class="op">!=</span> <span class="st">''</span> <span class="cf">else</span> <span class="st">''</span>) <span class="op">+</span> l2</span>
<span id="cb43-21"><a href="#cb43-21"></a>    <span class="cf">if</span> <span class="kw">not</span> l3.startswith(<span class="st">"Unnamed"</span>):</span>
<span id="cb43-22"><a href="#cb43-22"></a>        clabel <span class="op">+=</span> (<span class="st">'-'</span> <span class="cf">if</span> clabel <span class="op">!=</span> <span class="st">''</span> <span class="cf">else</span> <span class="st">''</span>) <span class="op">+</span> l3</span>
<span id="cb43-23"><a href="#cb43-23"></a>    </span>
<span id="cb43-24"><a href="#cb43-24"></a>    <span class="co"># Replace other commonly-occuring verbiage that inflates column name width</span></span>
<span id="cb43-25"><a href="#cb43-25"></a>    clabel <span class="op">=</span> clabel.replace(<span class="st">'--'</span>,<span class="st">'-'</span>).replace(<span class="st">" household"</span>,<span class="st">' hh'</span>).replace(<span class="st">'Owned: '</span>,<span class="st">''</span>)</span>
<span id="cb43-26"><a href="#cb43-26"></a>    </span>
<span id="cb43-27"><a href="#cb43-27"></a>    <span class="co">#clabel = clabel.replace(' (2011 Census)','').replace(' (2011)','').replace('Sales - 2011.1','Sales - 2012')</span></span>
<span id="cb43-28"><a href="#cb43-28"></a>    <span class="co">#clabel = clabel.replace('Numbers - ','').replace(' (£)','').replace('Car or van availability','Vehicles')</span></span>
<span id="cb43-29"><a href="#cb43-29"></a>    <span class="co">#clabel = clabel.replace('Household Income Estimates (2011/12) - ','').replace('Age Structure','Age')</span></span>
<span id="cb43-30"><a href="#cb43-30"></a>    </span>
<span id="cb43-31"><a href="#cb43-31"></a>    new_cols.append(clabel)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="longform">
<div id="e26f890c" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1"></a>new_cols</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>['MSOA Code',
 'MSOA Name',
 'Age-All Ages',
 'Age-0-15',
 'Age-16-29',
 'Age-30-44',
 'Age-45-64',
 'Age-65+',
 'Age-Working-age',
 'Households-All Households',
 'Composition-Couple hh with dependent children',
 'Composition-Couple hh without dependent children',
 'Composition-Lone parent hh',
 'Composition-One person hh',
 'Composition-Other hh Types',
 'White',
 'Mixed/multiple ethnic groups',
 'Asian/Asian British',
 'Black/African/Caribbean/Black British',
 'Other ethnic group',
 'BAME',
 'Country of Birth-United Kingdom',
 'Country of Birth-Not United Kingdom',
 'Language-1+ English as a main language',
 'Language-None have English as main language',
 'Tenure-Owned outright',
 'Tenure-Owned with a mortgage or loan',
 'Tenure-Social rented',
 'Tenure-Private rented',
 'Household spaces with at least one usual resident',
 'Household spaces with no usual residents',
 'Detached',
 'Semi-detached',
 'Terraced (including end-terrace)',
 'Flat, maisonette or apartment',
 'Population Density-Persons per hectare (2012)',
 'Median-2005',
 'Median-2006',
 'Median-2007',
 'Median-2008',
 'Median-2009',
 'Median-2010',
 'Median-2011',
 'Median-2012',
 'Median-2013 (p)',
 'Sales-2005',
 'Sales-2006',
 'Sales-2007',
 'Sales-2008',
 'Sales-2009',
 'Sales-2010',
 'Sales-2011',
 'Sales-2011.1',
 'Sales-2013(p)',
 'Qualifications-No',
 'Qualifications-Level 1',
 'Qualifications-Level 2',
 'Qualifications-Apprenticeship',
 'Qualifications-Level 3',
 'Qualifications-Level 4 and above',
 'Qualifications-Other',
 'Qualifications-Schoolchildren and full-time students: Age 18 and over',
 'Economic Activity-Economically active: Total',
 'Economic Activity-Economically active: Unemployed',
 'Economic Activity-Economically inactive: Total',
 'Economic Activity-Unemployment Rate',
 'Adults in Employment-No adults in employment in hh: With dependent children',
 'Total Mean hh Income',
 'Total Median hh Income',
 'Vehicles-No cars or vans in hh',
 'Vehicles-1 car or van in hh',
 'Vehicles-2 cars or vans in hh',
 'Vehicles-3 cars or vans in hh',
 'Vehicles-4 or more cars or vans in hh',
 'Vehicles-Sum of all cars or vans in the area',
 'Vehicles-Cars per hh']</code></pre>
</div>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Stop
</div>
</div>
<div class="callout-body-container callout-body">
<p>Make sure you understand what is happening here before just moving on to the next thing. Try adding <code>print()</code> statements if it will help it to make sense. This sort of code comes up a <em>lot</em> in the real world.</p>
</div>
</div>
<div id="24e75579" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1"></a>tidy.columns <span class="op">=</span> new_cols  <span class="co"># &lt;- Blow away complex index, replace with simple</span></span>
<span id="cb46-2"><a href="#cb46-2"></a>tidy.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">MSOA Code</th>
<th data-quarto-table-cell-role="th">MSOA Name</th>
<th data-quarto-table-cell-role="th">Age-All Ages</th>
<th data-quarto-table-cell-role="th">Age-0-15</th>
<th data-quarto-table-cell-role="th">Age-16-29</th>
<th data-quarto-table-cell-role="th">Age-30-44</th>
<th data-quarto-table-cell-role="th">Age-45-64</th>
<th data-quarto-table-cell-role="th">Age-65+</th>
<th data-quarto-table-cell-role="th">Age-Working-age</th>
<th data-quarto-table-cell-role="th">Households-All Households</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">Adults in Employment-No adults in employment in hh: With dependent children</th>
<th data-quarto-table-cell-role="th">Total Mean hh Income</th>
<th data-quarto-table-cell-role="th">Total Median hh Income</th>
<th data-quarto-table-cell-role="th">Vehicles-No cars or vans in hh</th>
<th data-quarto-table-cell-role="th">Vehicles-1 car or van in hh</th>
<th data-quarto-table-cell-role="th">Vehicles-2 cars or vans in hh</th>
<th data-quarto-table-cell-role="th">Vehicles-3 cars or vans in hh</th>
<th data-quarto-table-cell-role="th">Vehicles-4 or more cars or vans in hh</th>
<th data-quarto-table-cell-role="th">Vehicles-Sum of all cars or vans in the area</th>
<th data-quarto-table-cell-role="th">Vehicles-Cars per hh</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>E02000001</td>
<td>City of London 001</td>
<td>7375.0</td>
<td>620.0</td>
<td>1665.0</td>
<td>2045.0</td>
<td>2010.0</td>
<td>1035.0</td>
<td>5720.0</td>
<td>4385.0</td>
<td>...</td>
<td>38.0</td>
<td>59728.481886</td>
<td>46788.295472</td>
<td>3043.0</td>
<td>1100.0</td>
<td>173.0</td>
<td>51.0</td>
<td>18.0</td>
<td>1692.0</td>
<td>0.385861</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>E02000002</td>
<td>Barking and Dagenham 001</td>
<td>6775.0</td>
<td>1751.0</td>
<td>1277.0</td>
<td>1388.0</td>
<td>1258.0</td>
<td>1101.0</td>
<td>3923.0</td>
<td>2713.0</td>
<td>...</td>
<td>319.0</td>
<td>31788.185996</td>
<td>27058.703760</td>
<td>1020.0</td>
<td>1186.0</td>
<td>424.0</td>
<td>66.0</td>
<td>17.0</td>
<td>2305.0</td>
<td>0.849613</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>E02000003</td>
<td>Barking and Dagenham 002</td>
<td>10045.0</td>
<td>2247.0</td>
<td>1959.0</td>
<td>2300.0</td>
<td>2259.0</td>
<td>1280.0</td>
<td>6518.0</td>
<td>3834.0</td>
<td>...</td>
<td>268.0</td>
<td>43356.931547</td>
<td>36834.528738</td>
<td>1196.0</td>
<td>1753.0</td>
<td>691.0</td>
<td>155.0</td>
<td>39.0</td>
<td>3766.0</td>
<td>0.982264</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>E02000004</td>
<td>Barking and Dagenham 003</td>
<td>6182.0</td>
<td>1196.0</td>
<td>1277.0</td>
<td>1154.0</td>
<td>1543.0</td>
<td>1012.0</td>
<td>3974.0</td>
<td>2318.0</td>
<td>...</td>
<td>122.0</td>
<td>46701.436554</td>
<td>39668.206433</td>
<td>556.0</td>
<td>1085.0</td>
<td>515.0</td>
<td>128.0</td>
<td>34.0</td>
<td>2650.0</td>
<td>1.143227</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>E02000005</td>
<td>Barking and Dagenham 004</td>
<td>8562.0</td>
<td>2200.0</td>
<td>1592.0</td>
<td>1995.0</td>
<td>1829.0</td>
<td>946.0</td>
<td>5416.0</td>
<td>3183.0</td>
<td>...</td>
<td>307.0</td>
<td>34293.820288</td>
<td>29155.683536</td>
<td>1080.0</td>
<td>1423.0</td>
<td>551.0</td>
<td>109.0</td>
<td>20.0</td>
<td>2937.0</td>
<td>0.922714</td>
</tr>
</tbody>
</table>

<p>5 rows × 76 columns</p>
</div>
</div>
</div>
<p>You might want to have a look at <em>what</em> the code below drops first before just running it… remember that you can pull apart any complex code into pieces:</p>
<div id="f698ee9f" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1"></a>tidy[<span class="st">'MSOA Code'</span>].isna()</span>
<span id="cb47-2"><a href="#cb47-2"></a>tidy[tidy[<span class="st">'MSOA Code'</span>].isna()].index</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>Index([983], dtype='int64')</code></pre>
</div>
</div>
<div id="58807be8" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1"></a>tidy.drop(index<span class="op">=</span>tidy[tidy[<span class="st">'MSOA Code'</span>].isna()].index, inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="add-innerouter-london-mapping" class="level2">
<h2 class="anchored" data-anchor-id="add-innerouter-london-mapping">Add Inner/Outer London Mapping</h2>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-10-contents" aria-controls="callout-10" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Difficulty: Moderate, since I’m not giving you many clues.
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-10" class="callout-10-contents callout-collapse collapse">
<div class="callout-body-container callout-body">

</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
🔗 Connections
</div>
</div>
<div class="callout-body-container callout-body">
<p>We touched on <code>lambda</code> functions last week; it’s a ‘trivial’ function that we don’t even want to bother defining with <code>def</code>. We also used the lambda function in the context of <code>apply</code> so this is just another chance to remind yourself how this works. This is quite advanced Python, so don’t panic if you don’t get it right away and have to do some Googling…</p>
</div>
</div>
<p>We want to add the borough name and a ‘subregion’ name. We already have the borough name buried in a <em>separate</em> column, so step 1 is to extract that from the MSOA Name. Step 2 is to use the borough name as a lookup to the subregion name using a <strong>lambda</strong> function. The format for a lambda function is usually <code>lambda x: &lt;code that does something with x and returns a value&gt;</code>. Hint: you’ve got a dictionary and you know how to use it!</p>
<section id="add-boroughs" class="level3">
<h3 class="anchored" data-anchor-id="add-boroughs">Add Boroughs</h3>
<p>We first need to extract the borough names from one of the existing fields in the data frame… a <em>regex</em> that does <em>replacement</em> would be fastest and easiest: focus on what you <em>don’t</em> need from the MSOA Name <strong>string</strong> and <strong>replacing</strong> that using a <strong>regex</strong>…</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-5-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-1" role="tab" aria-controls="tabset-5-1" aria-selected="true">Question</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-5-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-2" role="tab" aria-controls="tabset-5-2" aria-selected="false">Answer</a></li></ul>
<div class="tab-content">
<div id="tabset-5-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-5-1-tab">
<div class="sourceCode" id="cb50"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1"></a>tidy[<span class="st">'Borough'</span>] <span class="op">=</span> tidy[<span class="st">'MSOA Name'</span>].???</span>
<span id="cb50-2"><a href="#cb50-2"></a>tidy.Borough.unique()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="tabset-5-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-5-2-tab">
<div id="aab5daba" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1"></a>tidy[<span class="st">'Borough'</span>] <span class="op">=</span> tidy[<span class="st">'MSOA Name'</span>].<span class="bu">str</span>.replace(<span class="vs">r' \d+$'</span>,<span class="st">''</span>,regex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb51-2"><a href="#cb51-2"></a>tidy.Borough.unique()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>array(['City of London', 'Barking and Dagenham', 'Barnet', 'Bexley',
       'Brent', 'Bromley', 'Camden', 'Croydon', 'Ealing', 'Enfield',
       'Greenwich', 'Hackney', 'Hammersmith and Fulham', 'Haringey',
       'Harrow', 'Havering', 'Hillingdon', 'Hounslow', 'Islington',
       'Kensington and Chelsea', 'Kingston upon Thames', 'Lambeth',
       'Lewisham', 'Merton', 'Newham', 'Redbridge',
       'Richmond upon Thames', 'Southwark', 'Sutton', 'Tower Hamlets',
       'Waltham Forest', 'Wandsworth', 'Westminster'], dtype=object)</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>You should get:</p>
<div id="3769c338" class="cell" data-execution_count="29">
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>array(['City of London', 'Barking and Dagenham', 'Barnet', 'Bexley',
       'Brent', 'Bromley', 'Camden', 'Croydon', 'Ealing', 'Enfield',
       'Greenwich', 'Hackney', 'Hammersmith and Fulham', 'Haringey',
       'Harrow', 'Havering', 'Hillingdon', 'Hounslow', 'Islington',
       'Kensington and Chelsea', 'Kingston upon Thames', 'Lambeth',
       'Lewisham', 'Merton', 'Newham', 'Redbridge',
       'Richmond upon Thames', 'Southwark', 'Sutton', 'Tower Hamlets',
       'Waltham Forest', 'Wandsworth', 'Westminster'], dtype=object)</code></pre>
</div>
</div>
</section>
<section id="map-boroughs-to-subregions" class="level3">
<h3 class="anchored" data-anchor-id="map-boroughs-to-subregions">Map Boroughs to Subregions</h3>
<p>And now you need to understand how to <em>apply</em> the mapping ot the Borough field using a <code>lambda</code> function. It’s fairly straightforward once you know the syntax: just a dictionary lookup. But as usual, you might want to first create a new cell and experiment with the output from the apply function before using it to write the <code>Subregion</code> field of the data frame…</p>
<div id="f87ac805" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1"></a>mapping <span class="op">=</span> {}</span>
<span id="cb54-2"><a href="#cb54-2"></a><span class="cf">for</span> b <span class="kw">in</span> [<span class="st">'Enfield'</span>,<span class="st">'Waltham Forest'</span>,<span class="st">'Redbridge'</span>,<span class="st">'Barking and Dagenham'</span>,<span class="st">'Havering'</span>,<span class="st">'Greenwich'</span>,<span class="st">'Bexley'</span>]:</span>
<span id="cb54-3"><a href="#cb54-3"></a>    mapping[b]<span class="op">=</span><span class="st">'Outer East and North East'</span></span>
<span id="cb54-4"><a href="#cb54-4"></a><span class="cf">for</span> b <span class="kw">in</span> [<span class="st">'Haringey'</span>,<span class="st">'Islington'</span>,<span class="st">'Hackney'</span>,<span class="st">'Tower Hamlets'</span>,<span class="st">'Newham'</span>,<span class="st">'Lambeth'</span>,<span class="st">'Southwark'</span>,<span class="st">'Lewisham'</span>]:</span>
<span id="cb54-5"><a href="#cb54-5"></a>    mapping[b]<span class="op">=</span><span class="st">'Inner East'</span></span>
<span id="cb54-6"><a href="#cb54-6"></a><span class="cf">for</span> b <span class="kw">in</span> [<span class="st">'Bromley'</span>,<span class="st">'Croydon'</span>,<span class="st">'Sutton'</span>,<span class="st">'Merton'</span>,<span class="st">'Kingston upon Thames'</span>]:</span>
<span id="cb54-7"><a href="#cb54-7"></a>    mapping[b]<span class="op">=</span><span class="st">'Outer South'</span></span>
<span id="cb54-8"><a href="#cb54-8"></a><span class="cf">for</span> b <span class="kw">in</span> [<span class="st">'Wandsworth'</span>,<span class="st">'Kensington and Chelsea'</span>,<span class="st">'Hammersmith and Fulham'</span>,<span class="st">'Westminster'</span>,<span class="st">'Camden'</span>,<span class="st">'City of London'</span>]:</span>
<span id="cb54-9"><a href="#cb54-9"></a>    mapping[b]<span class="op">=</span><span class="st">'Inner West'</span></span>
<span id="cb54-10"><a href="#cb54-10"></a><span class="cf">for</span> b <span class="kw">in</span> [<span class="st">'Richmond upon Thames'</span>,<span class="st">'Hounslow'</span>,<span class="st">'Ealing'</span>,<span class="st">'Hillingdon'</span>,<span class="st">'Brent'</span>,<span class="st">'Harrow'</span>,<span class="st">'Barnet'</span>]:</span>
<span id="cb54-11"><a href="#cb54-11"></a>    mapping[b]<span class="op">=</span><span class="st">'Outer West and North West'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-6-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-1" role="tab" aria-controls="tabset-6-1" aria-selected="true">Question</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-6-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-2" role="tab" aria-controls="tabset-6-2" aria-selected="false">Answer</a></li></ul>
<div class="tab-content">
<div id="tabset-6-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-6-1-tab">
<div class="sourceCode" id="cb55"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1"></a>tidy[<span class="st">'Subregion'</span>] <span class="op">=</span> tidy.Borough.<span class="bu">apply</span>(???)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="tabset-6-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-6-2-tab">
<div id="1724dc43" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1"></a>tidy[<span class="st">'Subregion'</span>] <span class="op">=</span> tidy.Borough.<span class="bu">apply</span>(<span class="kw">lambda</span> x: mapping[x])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="and-save" class="level3">
<h3 class="anchored" data-anchor-id="and-save">And Save</h3>
<p>There’s a little snipped of useful code to work out here: we need to check if the <code>clean</code> directory exists in the <code>data</code> directory; if we don’t then the <code>tidy.to_parquet()</code> call will fail.</p>
<div id="b60bbae3" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(os.path.join(<span class="st">'data'</span>,<span class="st">'clean'</span>)):</span>
<span id="cb57-2"><a href="#cb57-2"></a>    os.makedirs(os.path.join(<span class="st">'data'</span>,<span class="st">'clean'</span>))</span>
<span id="cb57-3"><a href="#cb57-3"></a>tidy.to_parquet(os.path.join(<span class="st">'data'</span>,<span class="st">'clean'</span>,<span class="st">'MSOA_Atlas.parquet'</span>))</span>
<span id="cb57-4"><a href="#cb57-4"></a><span class="bu">print</span>(<span class="st">"Done."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Done.</code></pre>
</div>
</div>
</section>
<section id="questions-1" class="level3">
<h3 class="anchored" data-anchor-id="questions-1">Questions</h3>
<ul>
<li>What are the advantages to <code>apply</code> and <code>lambda</code> functions over looping and named functions?</li>
<li>When might you choose a named function over a lambda function?</li>
</ul>
</section>
</section>
<section id="merge-data-geography" class="level2">
<h2 class="anchored" data-anchor-id="merge-data-geography">Merge Data &amp; Geography</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-12-contents" aria-controls="callout-12" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Difficulty: Low, except for plotting.
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-12" class="callout-12-contents callout-collapse collapse">
<div class="callout-body-container callout-body">

</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
🔗 Connections
</div>
</div>
<div class="callout-body-container callout-body">
<p>We’ll cover joins (of which a <code>merge</code> is just one type) in the <a href="https://jreades.github.io/fsds/sessions/week10.html#lectures">final week’s lectures</a>, but between what you’d done in GIS and what we have here there should be enough here for you to start being able to make sense of how they work so that you don’t have to wait until Week 10 to think about how this could help you with your Group Assessment.</p>
</div>
</div>
<p>First, we need to download the MSOA source file, which is a zipped archive of a Shapefile:</p>
<div id="f0052cf7" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1"></a><span class="co"># Oh look, we can read a Shapefile without needing to unzip it!</span></span>
<span id="cb59-2"><a href="#cb59-2"></a>msoas <span class="op">=</span> gpd.read_file(</span>
<span id="cb59-3"><a href="#cb59-3"></a>    cache_data(<span class="st">'https://github.com/jreades/fsds/blob/master/data/src/Middle_Layer_Super_Output_Areas__December_2011__EW_BGC_V2-shp.zip?raw=true'</span>, </span>
<span id="cb59-4"><a href="#cb59-4"></a>               os.path.join(<span class="st">'data'</span>,<span class="st">'geo'</span>)), driver<span class="op">=</span><span class="st">'ESRI Shapefile'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Found data/geo/Middle_Layer_Super_Output_Areas__December_2011__EW_BGC_V2-shp.zip locally!
    Size is 7 MB (7,381,177 bytes)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/jreades/anaconda3/envs/sds/lib/python3.12/site-packages/pyogrio/raw.py:198: RuntimeWarning:

driver ESRI Shapefile does not support open option DRIVER
</code></pre>
</div>
</div>
<section id="identifying-matching-columns" class="level3">
<h3 class="anchored" data-anchor-id="identifying-matching-columns">Identifying Matching Columns</h3>
<p>Looking at the first few columns of each data frame, which one might allow us to link the two files together? You’ve done this in GIS. <em>Remember</em>: the column <em>names</em> don’t need to match for us to use them in a join, it’s the <em>values</em> that matter.</p>
<div id="0d9bbe33" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1"></a><span class="bu">print</span>(<span class="ss">f"Column names: </span><span class="sc">{</span><span class="st">', '</span><span class="sc">.</span>join(tidy.columns.tolist()[:<span class="dv">5</span>])<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb62-2"><a href="#cb62-2"></a>tidy.iloc[:<span class="dv">3</span>,:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Column names: MSOA Code, MSOA Name, Age-All Ages, Age-0-15, Age-16-29</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="34">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">MSOA Code</th>
<th data-quarto-table-cell-role="th">MSOA Name</th>
<th data-quarto-table-cell-role="th">Age-All Ages</th>
<th data-quarto-table-cell-role="th">Age-0-15</th>
<th data-quarto-table-cell-role="th">Age-16-29</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>E02000001</td>
<td>City of London 001</td>
<td>7375.0</td>
<td>620.0</td>
<td>1665.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>E02000002</td>
<td>Barking and Dagenham 001</td>
<td>6775.0</td>
<td>1751.0</td>
<td>1277.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>E02000003</td>
<td>Barking and Dagenham 002</td>
<td>10045.0</td>
<td>2247.0</td>
<td>1959.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="merge" class="level3">
<h3 class="anchored" data-anchor-id="merge">Merge</h3>
<p>One more thing: if you’ve got more than one choice I’d <em>always</em> go with a code over a name because one is intended for matching and other is not…</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-7-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-7-1" role="tab" aria-controls="tabset-7-1" aria-selected="true">Question</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-7-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-7-2" role="tab" aria-controls="tabset-7-2" aria-selected="false">Answer</a></li></ul>
<div class="tab-content">
<div id="tabset-7-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-7-1-tab">
<div class="sourceCode" id="cb64"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1"></a>gdf <span class="op">=</span> pd.merge(msoas, tidy, left_on<span class="op">=</span>???, right_on<span class="op">=</span>???, how<span class="op">=</span><span class="st">'inner'</span>)</span>
<span id="cb64-2"><a href="#cb64-2"></a>gdf <span class="op">=</span> gdf.drop(columns<span class="op">=</span>[<span class="st">'MSOA11CD'</span>,<span class="st">'MSOA11NM'</span>,<span class="st">'OBJECTID'</span>])</span>
<span id="cb64-3"><a href="#cb64-3"></a></span>
<span id="cb64-4"><a href="#cb64-4"></a><span class="bu">print</span>(<span class="ss">f"Final MSOA Atlas data frame has shape </span><span class="sc">{</span>gdf<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss"> x </span><span class="sc">{</span>gdf<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="tabset-7-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-7-2-tab">
<div id="9dba57cb" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1"></a>gdf <span class="op">=</span> pd.merge(msoas, tidy, left_on<span class="op">=</span><span class="st">'MSOA11CD'</span>, right_on<span class="op">=</span><span class="st">'MSOA Code'</span>, how<span class="op">=</span><span class="st">'inner'</span>)</span>
<span id="cb65-2"><a href="#cb65-2"></a>gdf <span class="op">=</span> gdf.drop(columns<span class="op">=</span>[<span class="st">'MSOA11CD'</span>,<span class="st">'MSOA11NM'</span>,<span class="st">'OBJECTID'</span>])</span>
<span id="cb65-3"><a href="#cb65-3"></a></span>
<span id="cb65-4"><a href="#cb65-4"></a><span class="bu">print</span>(<span class="ss">f"Final MSOA Atlas data frame has shape </span><span class="sc">{</span>gdf<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss"> x </span><span class="sc">{</span>gdf<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Final MSOA Atlas data frame has shape 983 x 86</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>You should get <code>Final data frame has shape 983 x 86</code>.</p>
</section>
<section id="plot-choropleth" class="level3">
<h3 class="anchored" data-anchor-id="plot-choropleth">Plot Choropleth</h3>
<p>Let’s plot the median income in 2011 column using the <code>plasma</code> colour ramp… The rest is to show you how to customise a legend.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1"></a>col <span class="op">=</span> <span class="st">'Median-2011'</span></span>
<span id="cb67-2"><a href="#cb67-2"></a>fig <span class="op">=</span> gdf.plot(column<span class="op">=</span>???, cmap<span class="op">=</span><span class="st">'???'</span>, </span>
<span id="cb67-3"><a href="#cb67-3"></a>         scheme<span class="op">=</span><span class="st">'FisherJenks'</span>, k<span class="op">=</span><span class="dv">7</span>, edgecolor<span class="op">=</span><span class="st">'None'</span>, </span>
<span id="cb67-4"><a href="#cb67-4"></a>         legend<span class="op">=</span><span class="va">True</span>, legend_kwds<span class="op">=</span>{<span class="st">'frameon'</span>:<span class="va">False</span>, <span class="st">'fontsize'</span>:<span class="dv">8</span>},</span>
<span id="cb67-5"><a href="#cb67-5"></a>         figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">7</span>))<span class="op">;</span></span>
<span id="cb67-6"><a href="#cb67-6"></a>plt.title(col.replace(<span class="st">'-'</span>,<span class="st">' '</span>))<span class="op">;</span></span>
<span id="cb67-7"><a href="#cb67-7"></a></span>
<span id="cb67-8"><a href="#cb67-8"></a><span class="co"># Now to modify the legend: googling "geopandas format legend"</span></span>
<span id="cb67-9"><a href="#cb67-9"></a><span class="co"># brings me to: https://stackoverflow.com/a/56591102/4041902</span></span>
<span id="cb67-10"><a href="#cb67-10"></a>leg <span class="op">=</span> fig.get_legend()</span>
<span id="cb67-11"><a href="#cb67-11"></a>leg._loc <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb67-12"><a href="#cb67-12"></a></span>
<span id="cb67-13"><a href="#cb67-13"></a><span class="cf">for</span> lbl <span class="kw">in</span> leg.get_texts():</span>
<span id="cb67-14"><a href="#cb67-14"></a>    label_text <span class="op">=</span> lbl.get_text()</span>
<span id="cb67-15"><a href="#cb67-15"></a>    [low, hi] <span class="op">=</span> label_text.split(<span class="st">', '</span>)</span>
<span id="cb67-16"><a href="#cb67-16"></a>    new_text <span class="op">=</span> <span class="ss">f'£</span><span class="sc">{</span><span class="bu">float</span>(low)<span class="sc">:,.0f}</span><span class="ss"> - £</span><span class="sc">{</span><span class="bu">float</span>(hi)<span class="sc">:,.0f}</span><span class="ss">'</span></span>
<span id="cb67-17"><a href="#cb67-17"></a>    lbl.set_text(new_text)</span>
<span id="cb67-18"><a href="#cb67-18"></a></span>
<span id="cb67-19"><a href="#cb67-19"></a>plt.show()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="save" class="level3">
<h3 class="anchored" data-anchor-id="save">Save</h3>
<div class="sourceCode" id="cb68"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1"></a>gdf.to_geoparquet(os.path.join(<span class="st">'data'</span>,<span class="st">'geo'</span>,<span class="st">'MSOA_Atlas.geoparquet'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="questions-2" class="level3">
<h3 class="anchored" data-anchor-id="questions-2">Questions</h3>
<ul>
<li>Try changing the colour scheme, classification scheme, and number of classes to see if you feel there’s a <em>better</em> opeion than the one shown above… Copy the cell (click on anywhere outside the code and then hit <code>C</code> to copy. Then click on this cell <em>once</em>, and hit <code>V</code> to paste.</li>
</ul>
</section>
</section>
</section>
<section id="splitting-into-test-train" class="level1">
<h1>Splitting into Test &amp; Train</h1>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>**&amp;#128279; Connections**: Here you will be using a standard approach in Machine Learningknown as _test/train  split_, although we _won't_ be doing any actual ML (&amp;#128517;). Here we are just going to use it to explore some issues raised by normalisation and standardisation in [this week's lectures](https://jreades.github.io/fsds/sessions/week8.html#lectures).</code></pre>
</div>
</div>
<p>A standard approach to Machine Learning, and something that is becoming more widely used elsewhere, is the splitting of a large data into set into testing and training components. Typically, you would take 80-90% of your data to ‘train’ your algorithm and withold between 10-20% for validation (‘testing’). An even ‘stricter’ approach, in the sense of trying to ensure the robustness of your model against outlier effects, is <a href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.cross_validate.html">cross validation</a> such as <a href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.KFold.html">k-folds cross-validation</a>.</p>
<p>Sci-Kit Learn is probably <em>the</em> most important reason Python has become the <em>de fact</em> language of data science. Test/train-split is used when to avoid over-fitting when we are trying to <strong>predict</strong> something; so here Sci-Kit Learn <em>expects</em> that you’ll have an <code>X</code> which is your <strong>predictors</strong> (the inputs to your model) and a <code>y</code> which is the thing you’re <strong>trying to predict</strong> (because: <span class="math inline">\(y = \beta X + \epsilon\)</span>).</p>
<p>We’re not building a model here (that’s for Term 2!) so we’ll just ‘pretend’ that we’re trying to predict the price of a listing and will set that up as our <code>y</code> data set <em>so that</em> we can see how the choice of normalisation/standardisation technique affects the robustness of the model against ‘new’ data. Notice too that you can pass a data frame directly to Sci-Kit Learn and it will split it for you.</p>
<section id="reload" class="level2">
<h2 class="anchored" data-anchor-id="reload">Reload</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>In future 'runs' of this notebook you can now just pick up here and skip all of Task 1.</code></pre>
</div>
</div>
<p>On subsequent runs of this notebook you might just want to start here!</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1"></a><span class="co"># Notice this handy code: we check if the data is already</span></span>
<span id="cb71-2"><a href="#cb71-2"></a><span class="co"># in memory. And notice this is just a list comprehension</span></span>
<span id="cb71-3"><a href="#cb71-3"></a><span class="co"># to see what is locally loaded.</span></span>
<span id="cb71-4"><a href="#cb71-4"></a><span class="cf">if</span> <span class="st">'gdf'</span> <span class="kw">not</span> <span class="kw">in</span> <span class="bu">locals</span>():</span>
<span id="cb71-5"><a href="#cb71-5"></a>    gdf <span class="op">=</span> gpd.read_parquet(os.path.join(<span class="st">'data'</span>,<span class="st">'geo'</span>,<span class="st">'MSOA_Atlas.geoparquet'</span>))</span>
<span id="cb71-6"><a href="#cb71-6"></a><span class="bu">print</span>(gdf.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb72"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1"></a>categoricals <span class="op">=</span> [<span class="st">'Borough'</span>,<span class="st">'Subregion'</span>]</span>
<span id="cb72-2"><a href="#cb72-2"></a><span class="cf">for</span> c <span class="kw">in</span> categoricals:</span>
<span id="cb72-3"><a href="#cb72-3"></a>    gdf[c] <span class="op">=</span> gdf[c].astype(<span class="st">'category'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="split" class="level2">
<h2 class="anchored" data-anchor-id="split">Split</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-16-contents" aria-controls="callout-16" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Difficulty: Low!
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-16" class="callout-16-contents callout-collapse collapse">
<div class="callout-body-container callout-body">

</div>
</div>
</div>
<p>For our purposes this is a little bit overkill as you could also use pandas’ <code>sample(frac=0.2)</code> and the indexes, but it’s useful to see how this works. You use test/train split to get <strong>four</strong> data sets out: the training data gives you two (predictors + target as separate data sets) and the testing data gives you two as well (predictors + target as separate data sets). These are sized accoridng to the <code>test_size</code> specfied in the <code>test_train_split</code> parameters.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split </span>
<span id="cb73-2"><a href="#cb73-2"></a></span>
<span id="cb73-3"><a href="#cb73-3"></a>pdf <span class="op">=</span> gdf[<span class="st">'Median-2011'</span>].copy() <span class="co"># pdf for Median *P*rice b/c we need *something*</span></span>
<span id="cb73-4"><a href="#cb73-4"></a></span>
<span id="cb73-5"><a href="#cb73-5"></a><span class="co"># df == *data* frame (a.k.a. predictors or independent variables)</span></span>
<span id="cb73-6"><a href="#cb73-6"></a><span class="co"># pr == *predicted* value (a.k.a. dependent variable)</span></span>
<span id="cb73-7"><a href="#cb73-7"></a><span class="co"># Notice we don't want the median price included in our training data</span></span>
<span id="cb73-8"><a href="#cb73-8"></a>df_train, df_test, pr_train, pr_test <span class="op">=</span> train_test_split(</span>
<span id="cb73-9"><a href="#cb73-9"></a>                gdf.drop(columns<span class="op">=</span>[<span class="st">'Median-2011'</span>]), pdf, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">44</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Below you should see that the data has been split roughly on the basis of the <code>test_size</code> parameter.</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1"></a><span class="bu">print</span>(<span class="ss">f"Original data size: </span><span class="sc">{</span>gdf<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss"> x </span><span class="sc">{</span>gdf<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb74-2"><a href="#cb74-2"></a><span class="bu">print</span>(<span class="ss">f"  Training data size: </span><span class="sc">{</span>df_train<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss"> x </span><span class="sc">{</span>df_train<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>(df_train.shape[<span class="dv">0</span>]<span class="op">/</span>gdf.shape[<span class="dv">0</span>])<span class="op">*</span><span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">%)"</span>)</span>
<span id="cb74-3"><a href="#cb74-3"></a><span class="bu">print</span>(<span class="ss">f"  Testing data size:  </span><span class="sc">{</span>df_test<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss"> x </span><span class="sc">{</span>df_test<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>(df_test.shape[<span class="dv">0</span>]<span class="op">/</span>gdf.shape[<span class="dv">0</span>])<span class="op">*</span><span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">%)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Also notice the indexes of each pair of data sets match:</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1"></a><span class="bu">print</span>(<span class="st">", "</span>.join([<span class="bu">str</span>(x) <span class="cf">for</span> x <span class="kw">in</span> df_train.index[:<span class="dv">10</span>]]))</span>
<span id="cb75-2"><a href="#cb75-2"></a><span class="bu">print</span>(<span class="st">", "</span>.join([<span class="bu">str</span>(x) <span class="cf">for</span> x <span class="kw">in</span> pr_train.index[:<span class="dv">10</span>]]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="plot-testtrain-data" class="level2">
<h2 class="anchored" data-anchor-id="plot-testtrain-data">Plot Test/Train Data</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-17-contents" aria-controls="callout-17" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Difficulty: Low, but important!
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-17" class="callout-17-contents callout-collapse collapse">
<div class="callout-body-container callout-body">

</div>
</div>
</div>
<div class="sourceCode" id="cb76"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1"></a>boros <span class="op">=</span> gpd.read_file(os.path.join(<span class="st">'data'</span>,<span class="st">'geo'</span>,<span class="st">'Boroughs.gpkg'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb77"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1"></a>f,axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>,<span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">5</span>))</span>
<span id="cb77-2"><a href="#cb77-2"></a>df_train.plot(ax<span class="op">=</span>???)</span>
<span id="cb77-3"><a href="#cb77-3"></a>df_test.plot(ax<span class="op">=</span>???)</span>
<span id="cb77-4"><a href="#cb77-4"></a>boros.plot(ax<span class="op">=</span>???, facecolor<span class="op">=</span><span class="st">'none'</span>, edgecolor<span class="op">=</span><span class="st">'r'</span>, linewidth<span class="op">=</span><span class="fl">.5</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb77-5"><a href="#cb77-5"></a>boros.plot(ax<span class="op">=</span>???, facecolor<span class="op">=</span><span class="st">'none'</span>, edgecolor<span class="op">=</span><span class="st">'r'</span>, linewidth<span class="op">=</span><span class="fl">.5</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb77-6"><a href="#cb77-6"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Training Data'</span>)</span>
<span id="cb77-7"><a href="#cb77-7"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'Testing Data'</span>)<span class="op">;</span></span>
<span id="cb77-8"><a href="#cb77-8"></a>axes[<span class="dv">0</span>].set_ylim(<span class="dv">150000</span>,<span class="dv">210000</span>)</span>
<span id="cb77-9"><a href="#cb77-9"></a>axes[<span class="dv">1</span>].set_ylim(<span class="dv">150000</span>,<span class="dv">210000</span>)</span>
<span id="cb77-10"><a href="#cb77-10"></a>axes[<span class="dv">0</span>].set_xlim(<span class="dv">500000</span>,<span class="dv">565000</span>)</span>
<span id="cb77-11"><a href="#cb77-11"></a>axes[<span class="dv">1</span>].set_xlim(<span class="dv">500000</span>,<span class="dv">565000</span>)</span>
<span id="cb77-12"><a href="#cb77-12"></a>axes[<span class="dv">1</span>].set_yticks([])<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="questions-3" class="level3">
<h3 class="anchored" data-anchor-id="questions-3">Questions</h3>
<ul>
<li>Why might it be useful to produce a <em>map</em> of a test/train split?</li>
<li>Why might it matter <em>more</em> if you were dealing with user locations or behaviours?</li>
</ul>
</section>
</section>
</section>
<section id="normalisation" class="level1">
<h1>Normalisation</h1>
<p>The developers of <a href="https://scikit-learn.org/">SciKit-Learn</a> define <a href="https://scikit-learn.org/stable/modules/preprocessing.html#normalization">normalisation</a> as “scaling individual samples to have <strong>unit norm</strong>.” There are a <em>lot</em> of subtleties to this when you start dealing with ‘sparse’ data, but for the most part it’s worthwhile to think of this as a rescaling of the raw data to have similar ranges in order achieve some kind of comparison. This is such a common problem that sklearn offers a range of such (re)scalers including: <code>MinMaxScaler</code>.</p>
<p>Let’s see what effect this has on the data!</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1"></a><span class="co"># Sets some handy 'keywords' to tweak the Seaborn plot</span></span>
<span id="cb78-2"><a href="#cb78-2"></a>kwds <span class="op">=</span> <span class="bu">dict</span>(s<span class="op">=</span><span class="dv">7</span>,alpha<span class="op">=</span><span class="fl">0.95</span>,edgecolor<span class="op">=</span><span class="st">"none"</span>)</span>
<span id="cb78-3"><a href="#cb78-3"></a></span>
<span id="cb78-4"><a href="#cb78-4"></a><span class="co"># Set the *hue order* so that all plots have the *same*</span></span>
<span id="cb78-5"><a href="#cb78-5"></a><span class="co"># colour on the Subregion</span></span>
<span id="cb78-6"><a href="#cb78-6"></a>ho <span class="op">=</span> [<span class="st">'Inner East'</span>,<span class="st">'Inner West'</span>,<span class="st">'Outer West and North West'</span>,<span class="st">'Outer South'</span>,<span class="st">'Outer East and North East'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="select-columns" class="level2">
<h2 class="anchored" data-anchor-id="select-columns">Select Columns</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-18-contents" aria-controls="callout-18" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Difficulty: Low.
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-18" class="callout-18-contents callout-collapse collapse">
<div class="callout-body-container callout-body">

</div>
</div>
</div>
<p>One thing you’ll need to explain is why I keep writing <code>df[cols+['Subregion']</code> and why I don’t just add it to the <code>cols</code> variable at the start? Don’t try to answer this now, get through the rest of Tasks 3 and 4 and see what you think.</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1"></a>cols <span class="op">=</span> [<span class="st">'Tenure-Owned outright'</span>, <span class="st">'Tenure-Owned with a mortgage or loan'</span>,</span>
<span id="cb79-2"><a href="#cb79-2"></a>        <span class="st">'Tenure-Social rented'</span>, <span class="st">'Tenure-Private rented'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><em>Answer</em>: one part of the answer is that it makes it easy to change the columns we select without having to remember to keep <code>Subregion</code>, but the more important reason is that it allows us to re-use <em>this</em> ‘definition’ of <code>cols</code> elsewhere throughout the rest of this practical without needing to remember to <em>remove</em> <code>Subregion</code>.</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1"></a>tr_raw  <span class="op">=</span> df_train[cols<span class="op">+</span>[<span class="st">'Subregion'</span>]].copy() <span class="co"># train raw</span></span>
<span id="cb80-2"><a href="#cb80-2"></a>tst_raw <span class="op">=</span> df_test[cols<span class="op">+</span>[<span class="st">'Subregion'</span>]].copy()  <span class="co"># test raw</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="fit-to-data" class="level2">
<h2 class="anchored" data-anchor-id="fit-to-data">Fit to Data</h2>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-19-contents" aria-controls="callout-19" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Difficulty: Moderate if you want to understand what <code>reshape</code> is doing.
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-19" class="callout-19-contents callout-collapse collapse">
<div class="callout-body-container callout-body">

</div>
</div>
</div>
<p>Fit the training data:</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> MinMaxScaler</span>
<span id="cb81-2"><a href="#cb81-2"></a></span>
<span id="cb81-3"><a href="#cb81-3"></a><span class="co"># Notice what this is doing! See if you can explain it clearly.</span></span>
<span id="cb81-4"><a href="#cb81-4"></a>scalers <span class="op">=</span> [???.fit(???[x].values.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)) <span class="cf">for</span> x <span class="kw">in</span> cols]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="apply-transformations" class="level2">
<h2 class="anchored" data-anchor-id="apply-transformations">Apply Transformations</h2>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-20-contents" aria-controls="callout-20" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Difficulty: Moderate.
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-20" class="callout-20-contents callout-collapse collapse">
<div class="callout-body-container callout-body">

</div>
</div>
</div>
<p>Train:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1"></a>tr_normed <span class="op">=</span> tr_raw.copy()</span>
<span id="cb82-2"><a href="#cb82-2"></a></span>
<span id="cb82-3"><a href="#cb82-3"></a><span class="cf">for</span> i, sc <span class="kw">in</span> <span class="bu">enumerate</span>(scalers):</span>
<span id="cb82-4"><a href="#cb82-4"></a>    <span class="co"># Ditto this -- can you explain what this code is doing</span></span>
<span id="cb82-5"><a href="#cb82-5"></a>    tr_normed[cols[i]] <span class="op">=</span> sc.transform(df_???[cols[i]].values.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Test:</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1"></a>tst_normed <span class="op">=</span> tst_raw.copy()</span>
<span id="cb83-2"><a href="#cb83-2"></a></span>
<span id="cb83-3"><a href="#cb83-3"></a><span class="cf">for</span> i, sc <span class="kw">in</span> <span class="bu">enumerate</span>(scalers):</span>
<span id="cb83-4"><a href="#cb83-4"></a>    tst_normed[cols[i]] <span class="op">=</span> sc.transform(df_???[cols[i]].values.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>**&amp;#128279; Connections**: You don't _have_ to fully understand the next section, but if you are able to get your head around it then this will seriously help you to prepare for the use of more advanced techniques in modelling and programming.</code></pre>
</div>
</div>
<p>Check out the properties of <code>tst_normed</code> below. If you’ve understood what the <code>MinMaxScaler</code> is doing then you should be able to spot something unexpected in the transformed <em>test</em> outputs. If you’ve <em>really</em> understood this, you’ll see why this result is problematic for <em>models</em>. <em>Hint</em>: one way to think of it is an issue of <strong>extrapolation</strong>.</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1"></a><span class="cf">for</span> c <span class="kw">in</span> cols:</span>
<span id="cb85-2"><a href="#cb85-2"></a>    <span class="bu">print</span>(<span class="ss">f"  Minimum: </span><span class="sc">{</span>tst_normed[c]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb85-3"><a href="#cb85-3"></a>    ???</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="plot-distributions" class="level2">
<h2 class="anchored" data-anchor-id="plot-distributions">Plot Distributions</h2>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-22-contents" aria-controls="callout-22" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Difficulty: Moderate.
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-22" class="callout-22-contents callout-collapse collapse">
<div class="callout-body-container callout-body">

</div>
</div>
</div>
<div class="sourceCode" id="cb86"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1"></a>tr_raw.columns     <span class="op">=</span> [re.sub(<span class="st">'(-|/)'</span>,<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>,x) <span class="cf">for</span> x <span class="kw">in</span> tr_raw.columns.values]</span>
<span id="cb86-2"><a href="#cb86-2"></a>tst_raw.columns    <span class="op">=</span> [re.sub(<span class="st">'(-|/)'</span>,<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>,x) <span class="cf">for</span> x <span class="kw">in</span> tst_raw.columns.values]</span>
<span id="cb86-3"><a href="#cb86-3"></a>tr_normed.columns  <span class="op">=</span> [re.sub(<span class="st">'(-|/)'</span>,<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>,x) <span class="cf">for</span> x <span class="kw">in</span> tr_normed.columns.values]</span>
<span id="cb86-4"><a href="#cb86-4"></a>tst_normed.columns <span class="op">=</span> [re.sub(<span class="st">'(-|/)'</span>,<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>,x) <span class="cf">for</span> x <span class="kw">in</span> tst_normed.columns.values]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb87"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1"></a>sns.pairplot(data<span class="op">=</span>tr_raw, hue<span class="op">=</span><span class="st">'Subregion'</span>, diag_kind<span class="op">=</span><span class="st">'kde'</span>, corner<span class="op">=</span><span class="va">True</span>, plot_kws<span class="op">=</span>kwds, hue_order<span class="op">=</span>ho)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb88"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1"></a>sns.pairplot(data<span class="op">=</span>tr_normed, hue<span class="op">=</span><span class="st">'Subregion'</span>, diag_kind<span class="op">=</span><span class="st">'kde'</span>, corner<span class="op">=</span><span class="va">True</span>, plot_kws<span class="op">=</span>kwds, hue_order<span class="op">=</span>ho)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="questions-4" class="level3">
<h3 class="anchored" data-anchor-id="questions-4">Questions</h3>
<ul>
<li>Why do I keep writing <code>df[cols+['Subregion']</code>? Why I don’t just add Subregions to the <code>cols</code> variable at the start?</li>
<li>What has changed between the two plots (of <code>tr_raw</code> and <code>tr_normed</code>)?</li>
<li>What is the <em>potential</em> problem that the use of the transformer fitted on <code>tr_normed</code> to data from <code>tst_normed</code> might cause? <em>Hint</em>: this is why I asked you to investigate the data in the empty code cell above.</li>
<li>Can you explain what this is doing: <code>[MinMaxScaler().fit(df_train[x].values.reshape(-1,1)) for x in cols]</code>?</li>
<li>Can you explain what <em>this</em> is doing: <code>sc.transform(df_test[cols[i]].values.reshape(-1,1))</code>?</li>
</ul>
</section>
</section>
</section>
<section id="standardisation" class="level1">
<h1>Standardisation</h1>
<p>Standardisation is typically focussed on rescaling data to have a mean (or median) of 0 and standard deviation or IQR of 1. That these approaches are conceptually tied to the idea of symmetric, unimodal data such as that encountered in the standard normal distribution. Rather confusingly, many data scientists will use standardisation and normalisation largely interchangeably!</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1"></a>col <span class="op">=</span> <span class="st">'Vehicles-No cars or vans in hh'</span></span>
<span id="cb89-2"><a href="#cb89-2"></a>tr  <span class="op">=</span> df_train[[col]].copy()</span>
<span id="cb89-3"><a href="#cb89-3"></a>tst <span class="op">=</span> df_test[[col]].copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="z-score-standardisation" class="level2">
<h2 class="anchored" data-anchor-id="z-score-standardisation">Z-Score Standardisation</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-23-contents" aria-controls="callout-23" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Difficulty: Low.
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-23" class="callout-23-contents callout-collapse collapse">
<div class="callout-body-container callout-body">

</div>
</div>
</div>
<div class="sourceCode" id="cb90"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1"></a>stsc <span class="op">=</span> StandardScaler().fit(tr[col].values.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb90-2"><a href="#cb90-2"></a></span>
<span id="cb90-3"><a href="#cb90-3"></a>tr[<span class="ss">f"Z. </span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">"</span>]  <span class="op">=</span> stsc.transform(???)</span>
<span id="cb90-4"><a href="#cb90-4"></a>tst[<span class="ss">f"Z. </span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> stsc.transform(???)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="inter-quartile-standardisation" class="level2">
<h2 class="anchored" data-anchor-id="inter-quartile-standardisation">Inter-Quartile Standardisation</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-24-contents" aria-controls="callout-24" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Difficulty: Low.
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-24" class="callout-24-contents callout-collapse collapse">
<div class="callout-body-container callout-body">

</div>
</div>
</div>
<div class="sourceCode" id="cb91"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1"></a>rs <span class="op">=</span> ???(quantile_range<span class="op">=</span>(<span class="fl">25.0</span>, <span class="fl">75.0</span>)).fit(???)</span>
<span id="cb91-2"><a href="#cb91-2"></a></span>
<span id="cb91-3"><a href="#cb91-3"></a>tr[<span class="ss">f"IQR. </span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> rs.transform(???)</span>
<span id="cb91-4"><a href="#cb91-4"></a>tst[<span class="ss">f"IQR. </span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> rs.transform(???)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="plot-distributions-1" class="level2">
<h2 class="anchored" data-anchor-id="plot-distributions-1">Plot Distributions</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>**&amp;#128279; Connections**: The point of these next plots is simply to show that *linear* transformations (which are 'reversible') is about changing things like the magnitude/scale of our data but doesn't fundamentally change relationships *between* observations.</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-26-contents" aria-controls="callout-26" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Difficulty: Low.
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-26" class="callout-26-contents callout-collapse collapse">
<div class="callout-body-container callout-body">

</div>
</div>
</div>
<div class="sourceCode" id="cb93"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1"></a>sns.jointplot(data<span class="op">=</span>tr, x<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">"</span>, y<span class="op">=</span><span class="ss">f"Z. </span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">"</span>, kind<span class="op">=</span><span class="st">'kde'</span>)<span class="op">;</span> <span class="co"># hex probably not the best choice</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb94"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1"></a>sns.jointplot(data<span class="op">=</span>tr, x<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">"</span>, y<span class="op">=</span><span class="ss">f"IQR. </span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">"</span>, kind<span class="op">=</span><span class="st">'kde'</span>)<span class="op">;</span> <span class="co"># hex probably not the best choice</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb95"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1"></a>sns.jointplot(data<span class="op">=</span>tr, x<span class="op">=</span><span class="ss">f"Z. </span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">"</span>, y<span class="op">=</span><span class="ss">f"IQR. </span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">"</span>, kind<span class="op">=</span><span class="st">'hex'</span>)<span class="op">;</span> <span class="co"># hex probably not the best choice</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Perhaps a little more useful…</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1"></a>ax <span class="op">=</span> sns.kdeplot(tr[<span class="ss">f"Z. </span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">"</span>])</span>
<span id="cb96-2"><a href="#cb96-2"></a>sns.kdeplot(tr[<span class="ss">f"IQR. </span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">"</span>], color<span class="op">=</span><span class="st">'r'</span>, ax<span class="op">=</span>ax)</span>
<span id="cb96-3"><a href="#cb96-3"></a>plt.legend(loc<span class="op">=</span><span class="st">'upper right'</span>, labels<span class="op">=</span>[<span class="st">'Standard'</span>, <span class="st">'Robust'</span>]) <span class="co"># title='Foo'</span></span>
<span id="cb96-4"><a href="#cb96-4"></a>ax.ticklabel_format(useOffset<span class="op">=</span><span class="va">False</span>, style<span class="op">=</span><span class="st">'plain'</span>)</span>
<span id="cb96-5"><a href="#cb96-5"></a>ax.set_xlabel(<span class="st">"Standardised Value for No cars or vans in hh"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="questions-5" class="level3">
<h3 class="anchored" data-anchor-id="questions-5">Questions?</h3>
<ul>
<li>Can you see the differences between these two rescalers?</li>
<li>Can you explain why you might want to choose one over the other?</li>
</ul>
</section>
</section>
</section>
<section id="non-linear-transformations" class="level1">
<h1>Non-Linear Transformations</h1>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>**&amp;#128279; Connections**: Now *these* transformations are not directly revsersible because they change the actual relationships between observations in the data. We use these when we need to achieve particular 'behaviours' from our data in order to improve our model's 'predictive' ability. Even a simple regression is doing a kind of prediction ($y = \beta X + \epsilon$). You covered these concepts in [this week's lectures](https://jreades.github.io/fsds/sessions/week8.html#lectures).</code></pre>
</div>
</div>
<p>So transformations are useful when a data series has features that make comparisons or analysis difficult, or that affect our ability to intuit meaningful difference. By manipulating the data using one or more mathematical operations we can sometimes make it more <em>tractable</em> for subsequent analysis. In other words, it’s all about the <em>context</em> of our data.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="http://img.youtube.com/vi/-VjcCr4uM6w/0.jpg" class="img-fluid figure-img"></p>
<figcaption>How tall is tall?</figcaption>
</figure>
</div>
<p>From above, we know the <em>Median Income</em> data are <em>not</em> normally distributed, but can we work out what distribution best represents <em>Median Income</em>? This can be done by comparing the shape of the histogram to the shapes of theoretical distributitions. For example:</p>
<ul>
<li>the <a href="https://en.wikipedia.org/wiki/Log-normal_distribution">log-normal</a> distribution</li>
<li>the <a href="https://en.wikipedia.org/wiki/Exponential_distribution">exponential</a> distribution</li>
<li>the <a href="https://en.wikipedia.org/wiki/Poisson_distribution">Poisson</a> distribution (for non-continuous data)</li>
</ul>
<p>From looking at those theoretical distributions, we might make an initial guess as to the type of distribution. There are actually <em>many</em> other distributions encountered in real life data, but these ones are particuarly common. A wider view of this would be that <a href="https://scikit-learn.org/stable/modules/preprocessing.html#non-linear-transformation">quantile and power transformations</a> are ways of preserving the rank of values but lose many of the other features of the relationships that might be preserved by, for instance, the standard scaler.</p>
<p>In the case of Median Income, taking a log-transform of the data might make it <em>appear</em> more normal: you do <strong>not</strong> say that a transformation <em>makes</em> data more normal, you say either that ‘it allows us to treat the data as normally distributed’ or that ‘the transformed data follows a log-normal distribution’.</p>
<section id="the-normal-distribution" class="level2">
<h2 class="anchored" data-anchor-id="the-normal-distribution">The Normal Distribution</h2>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-28-contents" aria-controls="callout-28" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Difficulty: Moderate.
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-28" class="callout-28-contents callout-collapse collapse">
<div class="callout-body-container callout-body">

</div>
</div>
</div>
<p>Z-scores are often associated with the normal distribution because their interpretation implicitly assumes a normal distribution. Or to put it another way… You can always calculate z-scores for your data (it’s just a formula applied to data points), but their <em>intuitive meaning</em> is lost if your data don’t have something like a normal distribution (or follow the <a href="https://en.wikipedia.org/wiki/68–95–99.7_rule">68-95-99.7 rule</a>).</p>
<p>But… what if our data are non-normal? Well, Just because data are non-normal doesn’t mean z-scores can’t be calculated (we already did that above); we just have to be careful what we do with them… and sometimes we should just avoid them entirely.</p>
<section id="creating-a-normal-distribution" class="level3">
<h3 class="anchored" data-anchor-id="creating-a-normal-distribution">Creating a Normal Distribution</h3>
<p>Below is a function to create that theoretical normal distribution. See if you can understand what’s going and add comments to the code to explain what each line does.</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1"></a><span class="kw">def</span> normal_from_dist(series): </span>
<span id="cb98-2"><a href="#cb98-2"></a>    mu <span class="op">=</span> ???          <span class="co"># mean of our data</span></span>
<span id="cb98-3"><a href="#cb98-3"></a>    sd <span class="op">=</span> ???          <span class="co"># standard deviation of our data</span></span>
<span id="cb98-4"><a href="#cb98-4"></a>    n  <span class="op">=</span> ???          <span class="co"># count how many observations are in our data</span></span>
<span id="cb98-5"><a href="#cb98-5"></a>    s <span class="op">=</span> np.random.normal(???, ???, ???)   <span class="co">#use the parameters of the data just calculated to generate n random numbers, drawn from a normal distributions </span></span>
<span id="cb98-6"><a href="#cb98-6"></a>    <span class="cf">return</span> s                   <span class="co">#return this set of random numbers</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To make it easier to understand what the function above is doing, let’s use it! We’ll use the function to plot both a distribution plot with both histogram and KDE for our data, and then add a <em>second</em> overplot distplot to the same fig showing the theoretical normal distribution (in red). We’ll do this in a loop for each of the three variables we want to examine.</p>
</section>
<section id="visual-comparisons" class="level3">
<h3 class="anchored" data-anchor-id="visual-comparisons">Visual Comparisons</h3>
<p>Looking at the output, which of the variables has a roughly normal distribution? Another way to think about this question is, for which of the variables are the mean and standard deviation <em>most</em> appropriate as measures of centrality and spread?</p>
<p><em>Also</em>, how would you determine the <em>meaning</em> of some of the departures from the normal distribution?</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1"></a>selection <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> df_train.columns.values <span class="cf">if</span> x.startswith(<span class="st">'Composition'</span>)]</span>
<span id="cb99-2"><a href="#cb99-2"></a></span>
<span id="cb99-3"><a href="#cb99-3"></a><span class="cf">for</span> c <span class="kw">in</span> selection:</span>
<span id="cb99-4"><a href="#cb99-4"></a>    ax <span class="op">=</span> sns.kdeplot(df_train[c])</span>
<span id="cb99-5"><a href="#cb99-5"></a>    sns.kdeplot(normal_from_dist(df_train[c]), color<span class="op">=</span><span class="st">'r'</span>, fill<span class="op">=</span><span class="va">True</span>, ax<span class="op">=</span>ax)</span>
<span id="cb99-6"><a href="#cb99-6"></a>    plt.legend(loc<span class="op">=</span><span class="st">'upper right'</span>, labels<span class="op">=</span>[<span class="st">'Observed'</span>, <span class="st">'Normal'</span>]) <span class="co"># title='Foo'</span></span>
<span id="cb99-7"><a href="#cb99-7"></a>    ax.ticklabel_format(useOffset<span class="op">=</span><span class="va">False</span>, style<span class="op">=</span><span class="st">'plain'</span>)</span>
<span id="cb99-8"><a href="#cb99-8"></a>    <span class="cf">if</span> ax.get_xlim()[<span class="dv">1</span>] <span class="op">&gt;</span> <span class="dv">999999</span>:</span>
<span id="cb99-9"><a href="#cb99-9"></a>        plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb99-10"><a href="#cb99-10"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="questions-6" class="level3">
<h3 class="anchored" data-anchor-id="questions-6">Questions</h3>
<ul>
<li>Which, if any, of the variables has a roughly normal distribution? Another way to think about this question is, for which of the variables are the mean and standard deviation <em>most</em> appropriate as measures of centrality and spread?</li>
<li>How might you determine the <em>significance</em> of some of the departures from the normal distribution?</li>
</ul>
</section>
</section>
<section id="logarithmic-transformations" class="level2">
<h2 class="anchored" data-anchor-id="logarithmic-transformations">Logarithmic Transformations</h2>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-29-contents" aria-controls="callout-29" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Difficulty: Moderate.
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-29" class="callout-29-contents callout-collapse collapse">
<div class="callout-body-container callout-body">

</div>
</div>
</div>
<p>To create a new series in the data frame containing the natural log of the original value it’s a similar process to what we’ve done before, but since pandas doesn’t provide a log-transform operator (i.e.&nbsp;you can’t call <code>df['MedianIncome'].log()</code> ) we need to use the <code>numpy</code> package since pandas data series are just numpy arrays with some fancy window dressing that makes them even <em>more</em> useful.</p>
<p>Let’s perform the transform then compare to the un-transformed data. Comment the code below to ensure that you understand what it is doing.</p>
<section id="apply-and-plot" class="level3">
<h3 class="anchored" data-anchor-id="apply-and-plot">Apply and Plot</h3>
<div class="sourceCode" id="cb100"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1"></a>cols <span class="op">=</span> [<span class="st">'Median-2012'</span>,<span class="st">'Total Mean hh Income'</span>]</span>
<span id="cb100-2"><a href="#cb100-2"></a></span>
<span id="cb100-3"><a href="#cb100-3"></a><span class="cf">for</span> m <span class="kw">in</span> cols:</span>
<span id="cb100-4"><a href="#cb100-4"></a>    s  <span class="op">=</span> df_train[m] <span class="co"># s == series</span></span>
<span id="cb100-5"><a href="#cb100-5"></a>    ts <span class="op">=</span> ???.???(s)   <span class="co"># ts == transformed series</span></span>
<span id="cb100-6"><a href="#cb100-6"></a>    </span>
<span id="cb100-7"><a href="#cb100-7"></a>    ax <span class="op">=</span> sns.kdeplot(s)</span>
<span id="cb100-8"><a href="#cb100-8"></a>    sns.kdeplot(normal_from_dist(s), color<span class="op">=</span><span class="st">'r'</span>, fill<span class="op">=</span><span class="va">True</span>, ax<span class="op">=</span>ax)</span>
<span id="cb100-9"><a href="#cb100-9"></a>    plt.legend(loc<span class="op">=</span><span class="st">'upper right'</span>, labels<span class="op">=</span>[<span class="st">'Observed'</span>, <span class="st">'Normal'</span>]) <span class="co"># title also an option</span></span>
<span id="cb100-10"><a href="#cb100-10"></a>    plt.title(<span class="st">"Original Data"</span>)</span>
<span id="cb100-11"><a href="#cb100-11"></a>    </span>
<span id="cb100-12"><a href="#cb100-12"></a>    <span class="co">### USEFUL FORMATTING TRICKS </span><span class="al">###</span></span>
<span id="cb100-13"><a href="#cb100-13"></a>    <span class="co"># This turns off scientific notation in the ticklabels</span></span>
<span id="cb100-14"><a href="#cb100-14"></a>    ax.ticklabel_format(useOffset<span class="op">=</span><span class="va">False</span>, style<span class="op">=</span><span class="st">'plain'</span>)</span>
<span id="cb100-15"><a href="#cb100-15"></a>    <span class="co"># Notice this snippet of code</span></span>
<span id="cb100-16"><a href="#cb100-16"></a>    ax.set_xlabel(ax.get_xlabel() <span class="op">+</span> <span class="st">" (Raw Distribution)"</span>)</span>
<span id="cb100-17"><a href="#cb100-17"></a>    <span class="co"># Notice this little code snippet too</span></span>
<span id="cb100-18"><a href="#cb100-18"></a>    <span class="cf">if</span> ax.get_xlim()[<span class="dv">1</span>] <span class="op">&gt;</span> <span class="dv">999999</span>:</span>
<span id="cb100-19"><a href="#cb100-19"></a>        plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb100-20"><a href="#cb100-20"></a>    </span>
<span id="cb100-21"><a href="#cb100-21"></a>    plt.show()</span>
<span id="cb100-22"><a href="#cb100-22"></a>    </span>
<span id="cb100-23"><a href="#cb100-23"></a>    ax <span class="op">=</span> sns.kdeplot(ts)</span>
<span id="cb100-24"><a href="#cb100-24"></a>    sns.kdeplot(normal_from_dist(ts), color<span class="op">=</span><span class="st">'r'</span>, fill<span class="op">=</span><span class="va">True</span>, ax<span class="op">=</span>ax)</span>
<span id="cb100-25"><a href="#cb100-25"></a>    plt.legend(loc<span class="op">=</span><span class="st">'upper right'</span>, labels<span class="op">=</span>[<span class="st">'Observed'</span>, <span class="st">'Normal'</span>])</span>
<span id="cb100-26"><a href="#cb100-26"></a>    ax.ticklabel_format(useOffset<span class="op">=</span><span class="va">False</span>, style<span class="op">=</span><span class="st">'plain'</span>)</span>
<span id="cb100-27"><a href="#cb100-27"></a>    ax.set_xlabel(ax.get_xlabel() <span class="op">+</span> <span class="st">" (Logged Distribution)"</span>)</span>
<span id="cb100-28"><a href="#cb100-28"></a>    <span class="cf">if</span> ax.get_xlim()[<span class="dv">1</span>] <span class="op">&gt;</span> <span class="dv">999999</span>:</span>
<span id="cb100-29"><a href="#cb100-29"></a>        plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb100-30"><a href="#cb100-30"></a>    plt.title(<span class="st">"Log-Transformed Data"</span>)</span>
<span id="cb100-31"><a href="#cb100-31"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Hopefully, you can see that the transformed data do indeed look ‘more normal’; the peak of the red and blue lines are closer together and the blue line at the lower extreme is also closer to the red line, but we can check this by seeing what has happened to the z-scores.</p>
</section>
</section>
<section id="power-transformations" class="level2">
<h2 class="anchored" data-anchor-id="power-transformations">Power Transformations</h2>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-30-contents" aria-controls="callout-30" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Difficulty: Moderate.
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-30" class="callout-30-contents callout-collapse collapse">
<div class="callout-body-container callout-body">

</div>
</div>
</div>
<div class="sourceCode" id="cb101"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1"></a>cols <span class="op">=</span> [<span class="st">'Median-2012'</span>,<span class="st">'Total Mean hh Income'</span>]</span>
<span id="cb101-2"><a href="#cb101-2"></a>pt <span class="op">=</span> ???(method<span class="op">=</span><span class="st">'yeo-johnson'</span>)</span>
<span id="cb101-3"><a href="#cb101-3"></a></span>
<span id="cb101-4"><a href="#cb101-4"></a><span class="cf">for</span> m <span class="kw">in</span> cols:</span>
<span id="cb101-5"><a href="#cb101-5"></a>    s  <span class="op">=</span> df_train[m] <span class="co"># s == series</span></span>
<span id="cb101-6"><a href="#cb101-6"></a>    ts <span class="op">=</span> pt.fit_transform(s.values.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb101-7"><a href="#cb101-7"></a>    <span class="bu">print</span>(<span class="ss">f"Using lambda (transform 'exponent') of </span><span class="sc">{</span>pt<span class="sc">.</span>lambdas_[<span class="dv">0</span>]<span class="sc">:0.5f}</span><span class="ss">"</span>)</span>
<span id="cb101-8"><a href="#cb101-8"></a>    </span>
<span id="cb101-9"><a href="#cb101-9"></a>    ax <span class="op">=</span> sns.kdeplot(ts.reshape(<span class="op">-</span><span class="dv">1</span>,))</span>
<span id="cb101-10"><a href="#cb101-10"></a>    </span>
<span id="cb101-11"><a href="#cb101-11"></a>    sns.kdeplot(normal_from_dist(???), color<span class="op">=</span><span class="st">'r'</span>, fill<span class="op">=</span><span class="va">True</span>, ax<span class="op">=</span>ax)</span>
<span id="cb101-12"><a href="#cb101-12"></a>    plt.legend(loc<span class="op">=</span><span class="st">'upper right'</span>, labels<span class="op">=</span>[<span class="st">'Observed'</span>, <span class="st">'Normal'</span>])</span>
<span id="cb101-13"><a href="#cb101-13"></a>    ax.ticklabel_format(useOffset<span class="op">=</span><span class="va">False</span>, style<span class="op">=</span><span class="st">'plain'</span>)</span>
<span id="cb101-14"><a href="#cb101-14"></a>    ax.set_xlabel(m <span class="op">+</span> <span class="st">" (Transformed Distribution)"</span>)</span>
<span id="cb101-15"><a href="#cb101-15"></a>    <span class="cf">if</span> ax.get_xlim()[<span class="dv">1</span>] <span class="op">&gt;</span> <span class="dv">999999</span>: <span class="co"># &lt;-- What does this do?</span></span>
<span id="cb101-16"><a href="#cb101-16"></a>        plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb101-17"><a href="#cb101-17"></a>    plt.title(<span class="st">"Power-Transformed Data"</span>)</span>
<span id="cb101-18"><a href="#cb101-18"></a>    plt.show()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="principal-components-analysis" class="level1">
<h1>Principal Components Analysis</h1>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>**&amp;#128279; Connections**: This is all about _dimensionality_ and the different ways that we can reduce dimensionality in our data in order to improve our models' robustness and gain a better understanding of whether (or not) there is structure in our data. We'll start with linear decomposition and then look at non-linear decomposition, which we also demonstrated with UMAP last week.</code></pre>
</div>
</div>
<p>Now we’re going to ask the question: how can we represent our data using a smaller number of components that capture the variance in the original data. You should have covered PCA in Quantitative Methods.</p>
<section id="optional-reload" class="level3">
<h3 class="anchored" data-anchor-id="optional-reload">Optional Reload</h3>
<p>Use this is your data gets messy…</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1"></a>gdf <span class="op">=</span> gpd.read_parquet(os.path.join(<span class="st">'data'</span>,<span class="st">'geo'</span>,<span class="st">'MSOA_Atlas.geoparquet'</span>)).set_index(<span class="st">'MSOA Code'</span>)</span>
<span id="cb103-2"><a href="#cb103-2"></a><span class="bu">print</span>(gdf.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb104"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1"></a>categoricals <span class="op">=</span> [<span class="st">'Borough'</span>,<span class="st">'Subregion'</span>]</span>
<span id="cb104-2"><a href="#cb104-2"></a><span class="cf">for</span> c <span class="kw">in</span> categoricals:</span>
<span id="cb104-3"><a href="#cb104-3"></a>    gdf[c] <span class="op">=</span> gdf[c].astype(<span class="st">'category'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="calculating-shares" class="level2">
<h2 class="anchored" data-anchor-id="calculating-shares">Calculating Shares</h2>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-32-contents" aria-controls="callout-32" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Difficulty: Hard.
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-32" class="callout-32-contents callout-collapse collapse">
<div class="callout-body-container callout-body">

</div>
</div>
</div>
<p>Sadly, there’s no transformer to work this out for you automatically, but let’s start by converting the raw population and household figures to shares so that our later dimensionality reduction steps aren’t impacted by the size of the MSOA.</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1"></a>gdf[[<span class="st">'Age-All Ages'</span>,<span class="st">'Households-All Households'</span>]].head(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="specify-totals-columns" class="level3">
<h3 class="anchored" data-anchor-id="specify-totals-columns">Specify Totals Columns</h3>
<div class="sourceCode" id="cb106"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1"></a>total_pop <span class="op">=</span> gdf[<span class="st">'Age-All Ages'</span>]</span>
<span id="cb106-2"><a href="#cb106-2"></a>total_hh  <span class="op">=</span> gdf[<span class="st">'Households-All Households'</span>]</span>
<span id="cb106-3"><a href="#cb106-3"></a>total_vec <span class="op">=</span> gdf[<span class="st">'Vehicles-Sum of all cars or vans in the area'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="specify-columns-for-pop-or-hh-normalisation" class="level3">
<h3 class="anchored" data-anchor-id="specify-columns-for-pop-or-hh-normalisation">Specify Columns for Pop or HH Normalisation</h3>
<div class="sourceCode" id="cb107"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1"></a>pop_cols  <span class="op">=</span> [<span class="st">'Age-'</span>, <span class="st">'Composition-'</span>, <span class="st">'Qualifications-'</span>, <span class="st">'Economic Activity-'</span>, <span class="st">'White'</span>, <span class="st">'Mixed/multiple'</span>,</span>
<span id="cb107-2"><a href="#cb107-2"></a>             <span class="st">'Asian/Asian British'</span>, <span class="st">'Black/African'</span>, <span class="st">'BAME'</span>, <span class="st">'Other ethnic'</span>,</span>
<span id="cb107-3"><a href="#cb107-3"></a>             <span class="st">'Country of Birth-'</span>]</span>
<span id="cb107-4"><a href="#cb107-4"></a>hh_cols   <span class="op">=</span> [???, ???, ???, <span class="st">'Detached'</span>, <span class="st">'Semi-detached'</span>, <span class="st">'Terraced'</span>, <span class="st">'Flat, '</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb108"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1"></a>popre <span class="op">=</span> re.<span class="bu">compile</span>(<span class="vs">r'^(?:'</span> <span class="op">+</span> <span class="st">"|"</span>.join(pop_cols) <span class="op">+</span> <span class="vs">r')'</span>)</span>
<span id="cb108-2"><a href="#cb108-2"></a>hhre  <span class="op">=</span> re.<span class="bu">compile</span>(<span class="vs">r'^(?:'</span> <span class="op">+</span> <span class="st">"|"</span>.join(???) <span class="op">+</span> <span class="vs">r')'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="apply-to-columns" class="level3">
<h3 class="anchored" data-anchor-id="apply-to-columns">Apply to Columns</h3>
<div class="sourceCode" id="cb109"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1"></a>tr_gdf <span class="op">=</span> gdf.copy()</span>
<span id="cb109-2"><a href="#cb109-2"></a>tr_gdf[<span class="st">'Mean hh size'</span>] <span class="op">=</span> tr_gdf[<span class="st">'Age-All Ages'</span>]<span class="op">/</span>tr_gdf[<span class="st">'Households-All Households'</span>]</span>
<span id="cb109-3"><a href="#cb109-3"></a></span>
<span id="cb109-4"><a href="#cb109-4"></a><span class="cf">for</span> c <span class="kw">in</span> gdf.columns:</span>
<span id="cb109-5"><a href="#cb109-5"></a>    <span class="bu">print</span>(c)</span>
<span id="cb109-6"><a href="#cb109-6"></a>    <span class="cf">if</span> popre.match(c):</span>
<span id="cb109-7"><a href="#cb109-7"></a>        <span class="bu">print</span>(<span class="st">"  Normalising by total population."</span>)</span>
<span id="cb109-8"><a href="#cb109-8"></a>        tr_gdf[c] <span class="op">=</span> gdf[c]<span class="op">/</span>???</span>
<span id="cb109-9"><a href="#cb109-9"></a>    <span class="cf">elif</span> ???.match(???):</span>
<span id="cb109-10"><a href="#cb109-10"></a>        <span class="bu">print</span>(<span class="st">"  Normalising by total households."</span>)</span>
<span id="cb109-11"><a href="#cb109-11"></a>        tr_gdf[c] <span class="op">=</span> gdf[c]<span class="op">/</span>???</span>
<span id="cb109-12"><a href="#cb109-12"></a>    <span class="cf">elif</span> c.startswith(<span class="st">'Vehicles-'</span>) <span class="kw">and</span> <span class="kw">not</span> c.startswith(<span class="st">'Vehicles-Cars per hh'</span>):</span>
<span id="cb109-13"><a href="#cb109-13"></a>        <span class="bu">print</span>(<span class="st">"  Normalising by total vehicles."</span>)</span>
<span id="cb109-14"><a href="#cb109-14"></a>        tr_gdf[c] <span class="op">=</span> gdf[c]<span class="op">/</span>???</span>
<span id="cb109-15"><a href="#cb109-15"></a>    <span class="cf">else</span>:</span>
<span id="cb109-16"><a href="#cb109-16"></a>        <span class="bu">print</span>(<span class="st">"  Passing through."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="removing-columns" class="level2">
<h2 class="anchored" data-anchor-id="removing-columns">Removing Columns</h2>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-33-contents" aria-controls="callout-33" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Difficulty: Moderate.
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-33" class="callout-33-contents callout-collapse collapse">
<div class="callout-body-container callout-body">

</div>
</div>
</div>
<p>To perform dimensionality we can only have numeric data. In theory, categorical data can be converted to numeric and retained, but there are two issues:</p>
<ol type="1">
<li>Nominal data has no <em>innate</em> order so we <em>can’t</em> convert &gt; 2 categories to numbers and have to convert them to One-Hot Encoded values.</li>
<li>A binary (i.e.&nbsp;One-Hot Encoded) variable will account for a <em>lot</em> of variance in the data because it’s only two values they are 0 and 1!</li>
</ol>
<p>So in practice, it’s probably a good idea to drop categorical data if you’re planning to use PCA.</p>
<section id="drop-totals-columns" class="level3">
<h3 class="anchored" data-anchor-id="drop-totals-columns">Drop Totals Columns</h3>
<div class="sourceCode" id="cb110"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1"></a>pcadf <span class="op">=</span> tr_gdf.drop(columns<span class="op">=</span>[<span class="st">'Age-All Ages'</span>, <span class="st">'Households-All Households'</span>,</span>
<span id="cb110-2"><a href="#cb110-2"></a>                             <span class="st">'Vehicles-Sum of all cars or vans in the area'</span>])</span>
<span id="cb110-3"><a href="#cb110-3"></a>pcadf <span class="op">=</span> pcadf.set_index(<span class="st">'MSOA Code'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="drop-non-numeric-columns" class="level3">
<h3 class="anchored" data-anchor-id="drop-non-numeric-columns">Drop Non-Numeric Columns</h3>
<div class="sourceCode" id="cb111"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1"></a>pcadf.select_dtypes([<span class="st">'category'</span>,<span class="st">'object'</span>]).columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb112"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1"></a>pcadf.drop(columns<span class="op">=</span>pcadf.select_dtypes([<span class="st">'category'</span>,<span class="st">'object'</span>]).columns.to_list(), inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb112-2"><a href="#cb112-2"></a>pcadf.drop(columns<span class="op">=</span>[<span class="st">'BNG_E'</span>,<span class="st">'BNG_N'</span>,<span class="st">'geometry'</span>, <span class="st">'LONG'</span>, <span class="st">'LAT'</span>,<span class="st">'Shape__Are'</span>, <span class="st">'Shape__Len'</span>], inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb113"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1"></a>pcadf.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="rescale-reduce" class="level2">
<h2 class="anchored" data-anchor-id="rescale-reduce">Rescale &amp; Reduce</h2>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-34-contents" aria-controls="callout-34" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Difficulty: Moderate.
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-34" class="callout-34-contents callout-collapse collapse">
<div class="callout-body-container callout-body">

</div>
</div>
</div>
<p>In order to ensure that our results aren’t dominated by a single scale (e.g.&nbsp;House Prices!) we need to rescale all of our data. You could easily try different scalers as well as a different parameters to see what effect this has on your results.</p>
<section id="robustly-rescale" class="level3">
<h3 class="anchored" data-anchor-id="robustly-rescale">Robustly Rescale</h3>
<p>Set up the Robust Rescaler for inter-decile standardisation: 10th and 90th quantiles.</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1"></a>rs <span class="op">=</span> ???</span>
<span id="cb114-2"><a href="#cb114-2"></a></span>
<span id="cb114-3"><a href="#cb114-3"></a><span class="cf">for</span> c <span class="kw">in</span> pcadf.columns.values:</span>
<span id="cb114-4"><a href="#cb114-4"></a>    pcadf[c] <span class="op">=</span> rs.fit_transform(pcadf[c].values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="pca-reduce" class="level3">
<h3 class="anchored" data-anchor-id="pca-reduce">PCA Reduce</h3>
<div class="sourceCode" id="cb115"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1"></a><span class="im">from</span> sklearn.decomposition <span class="im">import</span> PCA </span>
<span id="cb115-2"><a href="#cb115-2"></a></span>
<span id="cb115-3"><a href="#cb115-3"></a>pca <span class="op">=</span> PCA(n_components<span class="op">=</span><span class="dv">50</span>, whiten<span class="op">=</span><span class="va">True</span>) </span>
<span id="cb115-4"><a href="#cb115-4"></a></span>
<span id="cb115-5"><a href="#cb115-5"></a>pca.fit(pcadf)</span>
<span id="cb115-6"><a href="#cb115-6"></a></span>
<span id="cb115-7"><a href="#cb115-7"></a>explained_variance <span class="op">=</span> pca.explained_variance_ratio_</span>
<span id="cb115-8"><a href="#cb115-8"></a>singular_values <span class="op">=</span> pca.singular_values_</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="examine-explained-variance" class="level3">
<h3 class="anchored" data-anchor-id="examine-explained-variance">Examine Explained Variance</h3>
<div class="sourceCode" id="cb116"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1"></a>x <span class="op">=</span> np.arange(<span class="dv">1</span>,???)</span>
<span id="cb116-2"><a href="#cb116-2"></a>plt.plot(x, explained_variance)</span>
<span id="cb116-3"><a href="#cb116-3"></a>plt.ylabel(<span class="st">'Share of Variance Explained'</span>)</span>
<span id="cb116-4"><a href="#cb116-4"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb117"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="dv">20</span>):</span>
<span id="cb117-2"><a href="#cb117-2"></a>    <span class="bu">print</span>(<span class="ss">f"Component </span><span class="sc">{</span>i<span class="sc">:&gt;2}</span><span class="ss"> accounts for </span><span class="sc">{</span>explained_variance[i]<span class="op">*</span><span class="dv">100</span><span class="sc">:&gt;2.2f}</span><span class="ss">% of variance"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You should get that Component 0 accounts for 31.35% of the variance and Component 19 accounts for 0.37%.</p>
<p>###: How Many Components?</p>
<p>There are a number of ways that we could set a threshold for dimensionality reduction: - The most common is to look for the ‘knee’ in the Explained Variance plot above. That would put us at about 5 retained components. - Another is to just keep all components contributing more than 1% of the variance. That would put us at about 10 components. - You can also (<a href="https://medium.com/@nikolay.oskolkov/hi-jon-reades-my-sincere-apologies-for-this-very-late-reply-444f57054d14">I discovered</a>) look to shuffle the data and repeatedly perform PCA to build confidence intervals. I have not implemented this (yet).</p>
<p>In order to <em>do</em> anything with these components we need to somehow reattach them to the MSOAs. So that entails taking the transformed results (<code>X_train</code> and <code>X_test</code>)</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1"></a>kn <span class="op">=</span> knee_locator.KneeLocator(x, explained_variance, </span>
<span id="cb118-2"><a href="#cb118-2"></a>                              curve<span class="op">=</span><span class="st">'convex'</span>, direction<span class="op">=</span><span class="st">'decreasing'</span>, </span>
<span id="cb118-3"><a href="#cb118-3"></a>                              interp_method<span class="op">=</span><span class="st">'interp1d'</span>)</span>
<span id="cb118-4"><a href="#cb118-4"></a><span class="bu">print</span>(<span class="ss">f"Knee detected at: </span><span class="sc">{</span>kn<span class="sc">.</span>knee<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb118-5"><a href="#cb118-5"></a>kn.plot_knee()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb119"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1"></a>keep_n_components <span class="op">=</span> <span class="dv">7</span></span>
<span id="cb119-2"><a href="#cb119-2"></a></span>
<span id="cb119-3"><a href="#cb119-3"></a><span class="co"># If we weren't changing the number of components we</span></span>
<span id="cb119-4"><a href="#cb119-4"></a><span class="co"># could re-use the pca object created above. </span></span>
<span id="cb119-5"><a href="#cb119-5"></a>pca <span class="op">=</span> PCA(n_components<span class="op">=</span>keep_n_components, whiten<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb119-6"><a href="#cb119-6"></a></span>
<span id="cb119-7"><a href="#cb119-7"></a>X_train <span class="op">=</span> pca.fit_transform(???)</span>
<span id="cb119-8"><a href="#cb119-8"></a></span>
<span id="cb119-9"><a href="#cb119-9"></a><span class="co"># Notice that we get the _same_ values out,</span></span>
<span id="cb119-10"><a href="#cb119-10"></a><span class="co"># so this is a *deterministic* process that</span></span>
<span id="cb119-11"><a href="#cb119-11"></a><span class="co"># is fully replicable (allowing for algorithmic</span></span>
<span id="cb119-12"><a href="#cb119-12"></a><span class="co">#&nbsp;and programming language differences).</span></span>
<span id="cb119-13"><a href="#cb119-13"></a><span class="bu">print</span>(<span class="ss">f"Total explained variance: </span><span class="sc">{</span>pca<span class="sc">.</span>explained_variance_ratio_<span class="sc">.</span><span class="bu">sum</span>()<span class="op">*</span><span class="dv">100</span><span class="sc">:2.2f}</span><span class="ss">%"</span>)</span>
<span id="cb119-14"><a href="#cb119-14"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, keep_n_components):</span>
<span id="cb119-15"><a href="#cb119-15"></a>    <span class="bu">print</span>(<span class="ss">f"  Component </span><span class="sc">{</span>i<span class="sc">:&gt;2}</span><span class="ss"> accounts for </span><span class="sc">{</span>pca<span class="sc">.</span>explained_variance_ratio_[i]<span class="op">*</span><span class="dv">100</span><span class="sc">:&gt;5.2f}</span><span class="ss">% of variance"</span>)</span>
<span id="cb119-16"><a href="#cb119-16"></a></span>
<span id="cb119-17"><a href="#cb119-17"></a><span class="co"># Notice...</span></span>
<span id="cb119-18"><a href="#cb119-18"></a><span class="bu">print</span>(<span class="ss">f"X-train shape: </span><span class="sc">{</span><span class="bu">len</span>(X_train)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb119-19"><a href="#cb119-19"></a><span class="bu">print</span>(<span class="ss">f"PCA df shape: </span><span class="sc">{</span>pcadf<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb119-20"><a href="#cb119-20"></a><span class="co"># So each observation has a row in X_train and there is </span></span>
<span id="cb119-21"><a href="#cb119-21"></a><span class="co"># 1 column for each component. This defines the mapping</span></span>
<span id="cb119-22"><a href="#cb119-22"></a><span class="co"># of the original data space into the reduced one</span></span>
<span id="cb119-23"><a href="#cb119-23"></a><span class="bu">print</span>(<span class="ss">f"Row 0 of X-train contains </span><span class="sc">{</span><span class="bu">len</span>(X_train[<span class="dv">0</span>])<span class="sc">}</span><span class="ss"> elements."</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="components-to-columns" class="level2">
<h2 class="anchored" data-anchor-id="components-to-columns">Components to Columns</h2>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-35-contents" aria-controls="callout-35" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Difficulty: Moderate.
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-35" class="callout-35-contents callout-collapse collapse">
<div class="callout-body-container callout-body">

</div>
</div>
</div>
<p>You could actually do this more quickly (but less clearly) using <code>X_train.T</code> to transpose the matrix!</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>,keep_n_components):</span>
<span id="cb120-2"><a href="#cb120-2"></a>    s <span class="op">=</span> pd.Series(X_train[:,???], index<span class="op">=</span>pcadf.???)</span>
<span id="cb120-3"><a href="#cb120-3"></a>    pcadf[<span class="ss">f"Component </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> s</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb121"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1"></a>pcadf.sample(<span class="dv">3</span>).iloc[:,<span class="op">-</span><span class="dv">10</span>:<span class="op">-</span><span class="dv">4</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="reattaching-geodata" class="level2">
<h2 class="anchored" data-anchor-id="reattaching-geodata">(Re)Attaching GeoData</h2>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-36-contents" aria-controls="callout-36" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Difficulty: Moderate.
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-36" class="callout-36-contents callout-collapse collapse">
<div class="callout-body-container callout-body">

</div>
</div>
</div>
<div class="sourceCode" id="cb122"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1"></a>msoas <span class="op">=</span> gpd.read_file(os.path.join(<span class="st">'data'</span>,<span class="st">'geo'</span>,<span class="st">'Middle_Layer_Super_Output_Areas__December_2011__EW_BGC_V2-shp.zip'</span>), driver<span class="op">=</span><span class="st">'ESRI Shapefile'</span>)</span>
<span id="cb122-2"><a href="#cb122-2"></a>msoas <span class="op">=</span> msoas.set_index(<span class="st">'MSOA11CD'</span>)</span>
<span id="cb122-3"><a href="#cb122-3"></a><span class="bu">print</span>(msoas.columns)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb123"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1"></a>msoas.head(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb124"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1"></a>pcadf.head(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb125"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1"></a>gpcadf <span class="op">=</span> pd.merge(msoas.set_index([<span class="st">'MSOA11CD'</span>], drop<span class="op">=</span><span class="va">True</span>), pcadf, left_index<span class="op">=</span><span class="va">True</span>, right_index<span class="op">=</span><span class="va">True</span>, how<span class="op">=</span><span class="st">'inner'</span>)</span>
<span id="cb125-2"><a href="#cb125-2"></a><span class="bu">print</span>(<span class="ss">f"Geo-PCA df has shape </span><span class="sc">{</span>gpcadf<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> x </span><span class="sc">{</span>gpcadf<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You should get <code>PCA df has shape 983 x 89</code>.</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1"></a>gpcadf[<span class="st">'Borough'</span>] <span class="op">=</span> gpcadf.MSOA11NM.<span class="bu">apply</span>(???)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="map-the-first-n-components" class="level2">
<h2 class="anchored" data-anchor-id="map-the-first-n-components">Map the First <em>n</em> Components</h2>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-37-contents" aria-controls="callout-37" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Difficulty: Moderate.
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-37" class="callout-37-contents callout-collapse collapse">
<div class="callout-body-container callout-body">

</div>
</div>
</div>
<p>How would you automate this so that the loop creates one plot for each of the first 3 components? How do you interpret these?</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1"></a><span class="cf">for</span> comp <span class="kw">in</span> [<span class="ss">f"Component </span><span class="sc">{</span>x<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">3</span>)]:</span>
<span id="cb127-2"><a href="#cb127-2"></a>    ax <span class="op">=</span> gpcadf.plot(column<span class="op">=</span>???, cmap<span class="op">=</span><span class="st">'plasma'</span>, </span>
<span id="cb127-3"><a href="#cb127-3"></a>         scheme<span class="op">=</span><span class="st">'FisherJenks'</span>, k<span class="op">=</span><span class="dv">7</span>, edgecolor<span class="op">=</span><span class="st">'None'</span>, legend<span class="op">=</span><span class="va">True</span>, figsize<span class="op">=</span>(<span class="dv">9</span>,<span class="dv">7</span>))<span class="op">;</span></span>
<span id="cb127-4"><a href="#cb127-4"></a>    boros.plot(ax<span class="op">=</span>ax, edgecolor<span class="op">=</span><span class="st">'w'</span>, facecolor<span class="op">=</span><span class="st">'none'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb127-5"><a href="#cb127-5"></a>    ax.set_title(<span class="ss">f'PCA </span><span class="sc">{</span>comp<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Your first component map should look something like this:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="https://github.com/jreades/fsds/raw/master/practicals/img/PCA-Component-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="PCA Component 1"><img src="https://github.com/jreades/fsds/raw/master/practicals/img/PCA-Component-1.png" class="img-fluid figure-img" alt="PCA Component 1"></a></p>
<figcaption>PCA Component 1</figcaption>
</figure>
</div>
</section>
</section>
<section id="umap" class="level1">
<h1>UMAP</h1>
<p>UMAP is a non-linear dimensionality reduction technique. Technically, it’s called <em>manifold</em> learning: imagine being able to roll a piece of paper up in more than just the 3rd dimension…). As a way to see if there is structure in your data this is a <em>much</em> better technique than one you might encounter in many tutorials: <em>t-SNE</em>. It has to do with how the two techniques ‘learn’ the manifold to use with your data.</p>
<section id="umap-on-raw-data" class="level2">
<h2 class="anchored" data-anchor-id="umap-on-raw-data">UMAP on Raw Data</h2>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-38-contents" aria-controls="callout-38" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Difficulty: Hard.
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-38" class="callout-38-contents callout-collapse collapse">
<div class="callout-body-container callout-body">

</div>
</div>
</div>
<div class="sourceCode" id="cb128"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1"></a><span class="im">from</span> umap <span class="im">import</span> UMAP</span>
<span id="cb128-2"><a href="#cb128-2"></a></span>
<span id="cb128-3"><a href="#cb128-3"></a><span class="co"># You might want to experiment with all</span></span>
<span id="cb128-4"><a href="#cb128-4"></a><span class="co"># 3 of these values -- it may make sense </span></span>
<span id="cb128-5"><a href="#cb128-5"></a><span class="co"># to package a lot of this up into a function!</span></span>
<span id="cb128-6"><a href="#cb128-6"></a>keep_dims<span class="op">=</span><span class="dv">2</span></span>
<span id="cb128-7"><a href="#cb128-7"></a>rs<span class="op">=</span><span class="dv">42</span></span>
<span id="cb128-8"><a href="#cb128-8"></a></span>
<span id="cb128-9"><a href="#cb128-9"></a>u <span class="op">=</span> UMAP(</span>
<span id="cb128-10"><a href="#cb128-10"></a>    n_neighbors<span class="op">=</span><span class="dv">25</span>,</span>
<span id="cb128-11"><a href="#cb128-11"></a>    min_dist<span class="op">=</span><span class="fl">0.01</span>,</span>
<span id="cb128-12"><a href="#cb128-12"></a>    n_components<span class="op">=</span>keep_dims,</span>
<span id="cb128-13"><a href="#cb128-13"></a>    random_state<span class="op">=</span>rs)</span>
<span id="cb128-14"><a href="#cb128-14"></a></span>
<span id="cb128-15"><a href="#cb128-15"></a>X_embedded <span class="op">=</span> u.fit_transform(???)</span>
<span id="cb128-16"><a href="#cb128-16"></a><span class="bu">print</span>(X_embedded.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="write-to-data-frame" class="level2">
<h2 class="anchored" data-anchor-id="write-to-data-frame">Write to Data Frame</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-39-contents" aria-controls="callout-39" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Difficulty: Low.
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-39" class="callout-39-contents callout-collapse collapse">
<div class="callout-body-container callout-body">

</div>
</div>
</div>
<p>Can probably also be solved using <code>X_embedded.T</code>.</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1"></a><span class="cf">for</span> ix <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>,X_embedded.shape[<span class="dv">1</span>]):</span>
<span id="cb129-2"><a href="#cb129-2"></a>    <span class="bu">print</span>(ix)</span>
<span id="cb129-3"><a href="#cb129-3"></a>    s <span class="op">=</span> pd.Series(X_embedded[:,???], index<span class="op">=</span>pcadf.???)</span>
<span id="cb129-4"><a href="#cb129-4"></a>    gpcadf[<span class="ss">f"Dimension </span><span class="sc">{</span>ix<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> s</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="visualise" class="level2">
<h2 class="anchored" data-anchor-id="visualise">Visualise!</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-40-contents" aria-controls="callout-40" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Difficulty: Low.
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-40" class="callout-40-contents callout-collapse collapse">
<div class="callout-body-container callout-body">

</div>
</div>
</div>
<div class="sourceCode" id="cb130"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1"></a>rddf <span class="op">=</span> gpcadf.copy() <span class="co"># Reduced Dimension Data Frame</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="simple-scatter" class="level3">
<h3 class="anchored" data-anchor-id="simple-scatter">Simple Scatter</h3>
<div class="sourceCode" id="cb131"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1"></a>f,ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>,<span class="dv">1</span>,figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">6</span>))</span>
<span id="cb131-2"><a href="#cb131-2"></a>sns.scatterplot(x<span class="op">=</span>rddf[???], y<span class="op">=</span>rddf[???], hue<span class="op">=</span>rddf[<span class="st">'Borough'</span>], legend<span class="op">=</span><span class="va">False</span>, ax<span class="op">=</span>ax)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="seaborn-jointplot" class="level3">
<h3 class="anchored" data-anchor-id="seaborn-jointplot">Seaborn Jointplot</h3>
<p>That is <em>suggestive</em> of there being struccture in the data, but with 983 data points and 33 colours it’s hard to make sense of what the structure <em>might</em> imply. Let’s try this again using the Subregion instead and taking advantage of the Seaborn visualisation library’s <code>jointplot</code> (joint distribution plot):</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1"></a>rddf[<span class="st">'Subregion'</span>] <span class="op">=</span> rddf.Borough.<span class="bu">apply</span>(<span class="kw">lambda</span> x: mapping[x])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb133"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1"></a><span class="co"># Sets some handy 'keywords' to tweak the Seaborn plot</span></span>
<span id="cb133-2"><a href="#cb133-2"></a>kwds <span class="op">=</span> <span class="bu">dict</span>(s<span class="op">=</span><span class="dv">7</span>,alpha<span class="op">=</span><span class="fl">0.95</span>,edgecolor<span class="op">=</span><span class="st">"none"</span>)</span>
<span id="cb133-3"><a href="#cb133-3"></a><span class="co"># Set the *hue order* so that all plots have some colouring by Subregion</span></span>
<span id="cb133-4"><a href="#cb133-4"></a>ho <span class="op">=</span> [<span class="st">'Inner East'</span>,<span class="st">'Inner West'</span>,<span class="st">'Outer West and North West'</span>,<span class="st">'Outer South'</span>,<span class="st">'Outer East and North East'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb134"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1"></a>g <span class="op">=</span> sns.jointplot(data<span class="op">=</span>rddf, x<span class="op">=</span>???, y<span class="op">=</span>???, height<span class="op">=</span><span class="dv">8</span>, </span>
<span id="cb134-2"><a href="#cb134-2"></a>                  hue<span class="op">=</span>???, hue_order<span class="op">=</span>ho, joint_kws<span class="op">=</span>kwds)</span>
<span id="cb134-3"><a href="#cb134-3"></a>g.ax_joint.legend(loc<span class="op">=</span><span class="st">'upper right'</span>, prop<span class="op">=</span>{<span class="st">'size'</span>: <span class="dv">8</span>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Your jointplot should look like this:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="https://github.com/jreades/fsds/raw/master/practicals/img/UMAP-Jointplot.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3" title="UMAP Jointplot"><img src="https://github.com/jreades/fsds/raw/master/practicals/img/UMAP-Jointplot.png" class="img-fluid figure-img" alt="UMAP Jointplot"></a></p>
<figcaption>UMAP Jointplot</figcaption>
</figure>
</div>
<p>What do you make of this?</p>
<p>Maybe let’s give this one last go splitting the plot out by subregion so that we can see how these vary:</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1"></a><span class="cf">for</span> r <span class="kw">in</span> rddf.Subregion.unique():</span>
<span id="cb135-2"><a href="#cb135-2"></a>    g <span class="op">=</span> sns.jointplot(data<span class="op">=</span>rddf[rddf.Subregion<span class="op">==</span>r], x<span class="op">=</span><span class="st">'Dimension 1'</span>, y<span class="op">=</span><span class="st">'Dimension 2'</span>, </span>
<span id="cb135-3"><a href="#cb135-3"></a>                  hue<span class="op">=</span><span class="st">'Borough'</span>, joint_kws<span class="op">=</span>kwds)</span>
<span id="cb135-4"><a href="#cb135-4"></a>    g.ax_joint.legend(loc<span class="op">=</span><span class="st">'upper right'</span>, prop<span class="op">=</span>{<span class="st">'size'</span>: <span class="dv">8</span>})<span class="op">;</span></span>
<span id="cb135-5"><a href="#cb135-5"></a>    g.ax_joint.set_ylim(<span class="dv">0</span>,<span class="dv">15</span>)</span>
<span id="cb135-6"><a href="#cb135-6"></a>    g.ax_joint.set_xlim(<span class="dv">0</span>,<span class="dv">15</span>)</span>
<span id="cb135-7"><a href="#cb135-7"></a>    plt.suptitle(r)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We can’t unfortunately do any clustering at this point to create groups from the data (that’s next week!) so for now note that there are several large-ish groups (in terms of membership) and few small ones picked up by t-SNE. Alos note that there is strong evidence of some incipient structure: Inner East and West largely clump together, while Outher East and Outer South also seem to group together, with Outer West being more distinctive. If you look back at the PCA Components (especially #1) you might be able to speculate about some reasons for this! Please note: this is <em>only</em> speculation at this time!</p>
<p>Next week we’ll also add the listings data back in as part of the picture!</p>
</section>
</section>
<section id="map-the-n-dimensions" class="level2">
<h2 class="anchored" data-anchor-id="map-the-n-dimensions">Map the <em>n</em> Dimensions</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-41-contents" aria-controls="callout-41" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Difficulty: Low.
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-41" class="callout-41-contents callout-collapse collapse">
<div class="callout-body-container callout-body">

</div>
</div>
</div>
<div class="sourceCode" id="cb136"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1"></a><span class="cf">for</span> comp <span class="kw">in</span> [<span class="ss">f"Dimension </span><span class="sc">{</span>x<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">3</span>)]:</span>
<span id="cb136-2"><a href="#cb136-2"></a>    f, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>,<span class="dv">1</span>,figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">8</span>))</span>
<span id="cb136-3"><a href="#cb136-3"></a>    rddf.plot(???)<span class="op">;</span></span>
<span id="cb136-4"><a href="#cb136-4"></a>    boros.plot(edgecolor<span class="op">=</span><span class="st">'w'</span>, facecolor<span class="op">=</span><span class="st">'none'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, ax<span class="op">=</span>ax)</span>
<span id="cb136-5"><a href="#cb136-5"></a>    ax.set_title(<span class="ss">f'UMAP </span><span class="sc">{</span>comp<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Your first dimension map should look something like this:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="https://github.com/jreades/fsds/raw/master/practicals/img/UMAP-Dimension-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4" title="UMAP Dimension 1"><img src="https://github.com/jreades/fsds/raw/master/practicals/img/UMAP-Dimension-1.png" class="img-fluid figure-img" alt="UMAP Dimension 1"></a></p>
<figcaption>UMAP Dimension 1</figcaption>
</figure>
</div>
</section>
<section id="and-save-1" class="level2">
<h2 class="anchored" data-anchor-id="and-save-1">And Save</h2>
<div class="sourceCode" id="cb137"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1"></a>rddf.to_parquet(os.path.join(<span class="st">'data'</span>,<span class="st">'clean'</span>,<span class="st">'Reduced_Dimension_Data.geoparquet'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="questions-7" class="level3">
<h3 class="anchored" data-anchor-id="questions-7">Questions</h3>
<ul>
<li>How would you compare/contrast PCA components with UMAP dimensions? Why do they not seem to show the same thing even though <em>both</em> seem to show <em>something</em>?</li>
<li>What might you do with the output of either the PCA or UMAP processes?</li>
</ul>
</section>
</section>
<section id="credits" class="level2">
<h2 class="anchored" data-anchor-id="credits">Credits!</h2>
<section id="contributors" class="level4">
<h4 class="anchored" data-anchor-id="contributors">Contributors:</h4>
<p>The following individuals have contributed to these teaching materials: Jon Reades (j.reades@ucl.ac.uk).</p>
</section>
<section id="license" class="level4">
<h4 class="anchored" data-anchor-id="license">License</h4>
<p>These teaching materials are licensed under a mix of <a href="https://opensource.org/licenses/mit-license.php">The MIT License</a> and the <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 license</a>.</p>
</section>
<section id="potential-dependencies" class="level4">
<h4 class="anchored" data-anchor-id="potential-dependencies">Potential Dependencies:</h4>
<p>This notebook may depend on the following libraries: pandas, geopandas, sklearn, matplotlib, seaborn</p>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 2022–2025, Jon Reades</p>
</div>   
    <div class="nav-footer-center">
<p><img src="../img/logo/logo_only_sm.png" height="25"> Foundations of Spatial Data Science</p>
<div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/jreades/fsds/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/jreades/fsds">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://bsky.app/profile/jreades.bsky.social/">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>