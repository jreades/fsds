<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Practical 8: Selecting Data – Foundations of Spatial Data Science</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="..//img/favicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<meta property="og:title" content="Practical 8: Selecting Data – Foundations of Spatial Data Science">
<meta property="og:description" content="Selecting &amp; Joining Data">
<meta property="og:image" content="img/CASA_Logo_no_text.png">
<meta property="og:site_name" content="Foundations">
<meta property="og:locale" content="en_GB">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-md " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../img/CASA_Logo_no_text.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Foundations of Spatial Data Science</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Welcome</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../setup/index.html"> 
<span class="menu-text">Setup</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-week-by-week" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Week-by-Week</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-week-by-week">    
        <li>
    <a class="dropdown-item" href="../sessions/index.html">
 <span class="dropdown-text">Overview</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">Part 1: Foundations</li>
        <li>
    <a class="dropdown-item" href="../sessions/week1.html">
 <span class="dropdown-text">1. Setting Up</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../sessions/week2.html">
 <span class="dropdown-text">2. Foundations (Pt.1)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../sessions/week3.html">
 <span class="dropdown-text">3. Foundations (Pt.2)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../sessions/week4.html">
 <span class="dropdown-text">4. Objects</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">Part 2: Data</li>
        <li>
    <a class="dropdown-item" href="../sessions/week5.html">
 <span class="dropdown-text">5. Numeric Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../sessions/reading_week.html">
 <span class="dropdown-text">Reading Week</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../sessions/week6.html">
 <span class="dropdown-text">6. Spatial Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../sessions/week7.html">
 <span class="dropdown-text">7. Textual Data</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">Part 3: Analysis</li>
        <li>
    <a class="dropdown-item" href="../sessions/week8.html">
 <span class="dropdown-text">8. Selecting Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../sessions/week9.html">
 <span class="dropdown-text">9. Presenting Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../sessions/week10.html">
 <span class="dropdown-text">10. Wrap Up + Lookahead</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">Part 4: Bonus</li>
        <li>
    <a class="dropdown-item" href="../sessions/week11.html">
 <span class="dropdown-text">11. Dimensions in Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../sessions/week12.html">
 <span class="dropdown-text">12. Grouping Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../references.html">
 <span class="dropdown-text">Bibliography</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-assessments" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Assessments</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-assessments">    
        <li>
    <a class="dropdown-item" href="../assessments/index.html">
 <span class="dropdown-text">Overview</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">Elements</li>
        <li>
    <a class="dropdown-item" href="../assessments/exam.html">
 <span class="dropdown-text">Timed Open Book Exam</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../assessments/group.html">
 <span class="dropdown-text">Group Work</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../assessments/peer.html">
 <span class="dropdown-text">Group Self-Evaluation</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../help.html"> 
<span class="menu-text">Getting Help</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#preamble" id="toc-preamble" class="nav-link active" data-scroll-target="#preamble">Preamble</a></li>
  <li><a href="#selecting-data" id="toc-selecting-data" class="nav-link" data-scroll-target="#selecting-data">Selecting Data</a></li>
  <li><a href="#sec-nonspatial" id="toc-sec-nonspatial" class="nav-link" data-scroll-target="#sec-nonspatial">Non-Spatial Joins</a></li>
  <li><a href="#sec-spatial" id="toc-sec-spatial" class="nav-link" data-scroll-target="#sec-spatial">Spatial Joins</a></li>
  <li><a href="#worked-example" id="toc-worked-example" class="nav-link" data-scroll-target="#worked-example">Worked Example</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/jreades/fsds/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div><div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="Practical-08-Selecting_Data.ipynb" download="Practical-08-Selecting_Data.ipynb"><i class="bi bi-journal-code"></i>Jupyter</a></li><li><a href="Practical-08-Selecting_Data.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Practical 8: Selecting Data</h1>
<p class="subtitle lead">Selecting &amp; Joining Data</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<table class="caption-top table">
<colgroup>
<col style="width: 13%">
<col style="width: 32%">
<col style="width: 20%">
<col style="width: 27%">
<col style="width: 5%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Complete</th>
<th style="text-align: left;">Part 1: Foundations</th>
<th style="text-align: left;">Part 2: Data</th>
<th style="text-align: left;">Part 3: Analysis</th>
<th style="text-align: right;"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">90%</td>
<td style="text-align: left;">▓▓▓▓▓▓▓▓</td>
<td style="text-align: left;">▓▓▓▓▓▓</td>
<td style="text-align: left;">▓▓▓░░░</td>
<td style="text-align: right;">8/10</td>
</tr>
</tbody>
</table>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>This practical focusses on two key bits of <em>implementation</em>: visualisation and data linkage! You will have seen quite a bit of each of these across the preceding three to four weeks, but they were picked up in an <em>ad-hoc</em> way, here we try to systematise things a bit.</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
🔗 Connections
</div>
</div>
<div class="callout-body-container callout-body">
<p>Here we’re trying to tidy up the loose ends. You’ve already worked with basic data visualisations in Seaborn and Matplotlib (including (geo)panda’s <code>plot</code> function), but we want you to have a better sense of how that <em>works</em> as part of a coherent – if altogether rather complex and overwhelming – approach to managing a data visualisation. You’ve also already seen examples of joins and spatial joins before but, again, we just want to review them more formally now.</p>
</div>
</div>
<section id="preamble" class="level1">
<h1>Preamble</h1>
<div id="399d073a" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>host <span class="op">=</span> <span class="st">'http://orca.casa.ucl.ac.uk'</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> <span class="st">'~jreades/data'</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>ymd  <span class="op">=</span> <span class="st">'2023-09-06'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="79bdecf7" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.cm <span class="im">as</span> cm</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="018dc28d" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> requests <span class="im">import</span> get</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> urllib.parse <span class="im">import</span> urlparse</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cache_data(src:<span class="bu">str</span>, dest:<span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Downloads and caches a remote file locally.</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co">    The function sits between the 'read' step of a pandas or geopandas</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co">    data frame and downloading the file from a remote location. The idea</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co">    is that it will save it locally so that you don't need to remember to</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co">    do so yourself. Subsequent re-reads of the file will return instantly</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co">    rather than downloading the entire file for a second or n-th itme.</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="co">    src : str</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co">        The remote *source* for the file, any valid URL should work.</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="co">    dest : str</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="co">        The *destination* location to save the downloaded file.</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co">    str</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="co">        A string representing the local location of the file.</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    url <span class="op">=</span> urlparse(src) <span class="co"># We assume that this is some kind of valid URL </span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    fn  <span class="op">=</span> os.path.split(url.path)[<span class="op">-</span><span class="dv">1</span>] <span class="co"># Extract the filename</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    dfn <span class="op">=</span> os.path.join(dest,fn) <span class="co">#&nbsp;Destination filename</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if dest+filename does *not* exist -- </span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># that would mean we have to download it!</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.isfile(dfn) <span class="kw">or</span> os.path.getsize(dfn) <span class="op">&lt;</span> <span class="dv">1</span>:</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>dfn<span class="sc">}</span><span class="ss"> not found, downloading!"</span>)</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert the path back into a list (without)</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># the filename -- we need to check that directories</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># exist first.</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>        path <span class="op">=</span> os.path.split(dest)</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create any missing directories in dest(ination) path</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># -- os.path.join is the reverse of split (as you saw above)</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># but it doesn't work with lists... so I had to google how</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># to use the 'splat' operator! os.makedirs creates missing</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>        <span class="co"># directories in a path automatically.</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(path) <span class="op">&gt;=</span> <span class="dv">1</span> <span class="kw">and</span> path[<span class="dv">0</span>] <span class="op">!=</span> <span class="st">''</span>:</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>            os.makedirs(os.path.join(<span class="op">*</span>path), exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Download and write the file</span></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(dfn, <span class="st">"wb"</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>            response <span class="op">=</span> get(src)</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>            <span class="bu">file</span>.write(response.content)</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Done downloading...'</span>)</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Found </span><span class="sc">{</span>dfn<span class="sc">}</span><span class="ss"> locally!"</span>)</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> dfn</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fa24265c" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>ddir <span class="op">=</span> os.path.join(<span class="st">'data'</span>,<span class="st">'geo'</span>) <span class="co"># destination directory</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>pqt  <span class="op">=</span> cache_data(<span class="ss">f'</span><span class="sc">{</span>host<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>ymd<span class="sc">}</span><span class="ss">-listings.geoparquet'</span>, ddir)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Found data/geo/2023-09-06-listings.geoparquet locally!</code></pre>
</div>
</div>
</section>
<section id="selecting-data" class="level1">
<h1>Selecting Data</h1>
<section id="in-pandas" class="level2">
<h2 class="anchored" data-anchor-id="in-pandas">In Pandas</h2>
<section id="recap-a-first-query" class="level3">
<h3 class="anchored" data-anchor-id="recap-a-first-query">Recap: A First Query</h3>
<div id="dd728315" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>pd.read_parquet(<span class="ss">f'</span><span class="sc">{</span>pqt<span class="sc">}</span><span class="ss">'</span>).head(<span class="dv">3</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">listing_url</th>
<th data-quarto-table-cell-role="th">last_scraped</th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">description</th>
<th data-quarto-table-cell-role="th">host_id</th>
<th data-quarto-table-cell-role="th">host_name</th>
<th data-quarto-table-cell-role="th">host_since</th>
<th data-quarto-table-cell-role="th">host_location</th>
<th data-quarto-table-cell-role="th">host_is_superhost</th>
<th data-quarto-table-cell-role="th">host_listings_count</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">minimum_nights</th>
<th data-quarto-table-cell-role="th">maximum_nights</th>
<th data-quarto-table-cell-role="th">availability_365</th>
<th data-quarto-table-cell-role="th">number_of_reviews</th>
<th data-quarto-table-cell-role="th">first_review</th>
<th data-quarto-table-cell-role="th">last_review</th>
<th data-quarto-table-cell-role="th">review_scores_rating</th>
<th data-quarto-table-cell-role="th">reviews_per_month</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">92644</td>
<td>https://www.airbnb.com/rooms/92644</td>
<td>2023-09-06</td>
<td>Rental unit in Earlsfield · ★4.57 · 1 bedroom ...</td>
<td>&lt;b&gt;The space&lt;/b&gt;&lt;br /&gt;Hi everyone! I have 2 ro...</td>
<td>498201</td>
<td>Dee Dee</td>
<td>2011-04-10</td>
<td>London, United Kingdom</td>
<td>False</td>
<td>1</td>
<td>...</td>
<td>42.0</td>
<td>2</td>
<td>730</td>
<td>217</td>
<td>216</td>
<td>2011-06-21</td>
<td>2022-10-29</td>
<td>4.57</td>
<td>1.45</td>
<td>b'\x01\x01\x00\x00\x00\xeax\xcc@e\xfc\xc7\xbf\...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">93015</td>
<td>https://www.airbnb.com/rooms/93015</td>
<td>2023-09-06</td>
<td>Rental unit in Hammersmith · ★4.82 · 2 bedroom...</td>
<td>Gorgeous 2 bed ground floor apartment with per...</td>
<td>499704</td>
<td>Sarah</td>
<td>2011-04-11</td>
<td>London, United Kingdom</td>
<td>False</td>
<td>1</td>
<td>...</td>
<td>175.0</td>
<td>5</td>
<td>240</td>
<td>40</td>
<td>38</td>
<td>2012-02-01</td>
<td>2022-09-30</td>
<td>4.82</td>
<td>0.27</td>
<td>b'\x01\x01\x00\x00\x00\r\xabx#\xf3\xc8\xcb\xbf...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">13913</td>
<td>https://www.airbnb.com/rooms/13913</td>
<td>2023-09-06</td>
<td>Rental unit in Islington · ★4.80 · 1 bedroom ·...</td>
<td>My bright double bedroom with a large window h...</td>
<td>54730</td>
<td>Alina</td>
<td>2009-11-16</td>
<td>London, United Kingdom</td>
<td>False</td>
<td>3</td>
<td>...</td>
<td>79.0</td>
<td>1</td>
<td>29</td>
<td>360</td>
<td>41</td>
<td>2010-08-18</td>
<td>2022-12-11</td>
<td>4.80</td>
<td>0.26</td>
<td>b'\x01\x01\x00\x00\x00\xeeZB&gt;\xe8\xd9\xbc\xbf\...</td>
</tr>
</tbody>
</table>

<p>3 rows × 31 columns</p>
</div>
</div>
</div>
<p>This should (I hope) be trivial to read now: we are loading a parquet file using pandas and taking advantage of Python’s ‘chaining’ functionality (<code>&lt;object&gt;.&lt;method&gt;().&lt;method&gt;()...</code>) to return the first three rows using <code>head</code>. It is worth noticing that we’re not even bothering to save the result of this command to a data frame (thus the lack of a <code>df =</code> in the code) and We’re doing this here solely so that you can compare pandas and SQL/DuckDB syntax across each of the following steps.</p>
</section>
<section id="recap-selecting-some-columns" class="level3">
<h3 class="anchored" data-anchor-id="recap-selecting-some-columns">Recap: Selecting some columns</h3>
<p>To load a columnar subset of the data we have two options:</p>
<ol type="1">
<li>Load all the data and <em>then</em> subset (which always happens with CSV files but is optional with other formats)</li>
<li>Load only the columns we care about (which is possible with parquet files)</li>
</ol>
<p>And in code these are:</p>
<section id="load-then-filter" class="level4">
<h4 class="anchored" data-anchor-id="load-then-filter">Load <em>then</em> filter</h4>
<div id="510528e5" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>pd.read_parquet(<span class="ss">f'</span><span class="sc">{</span>pqt<span class="sc">}</span><span class="ss">'</span>)[[<span class="st">'listing_url'</span>, <span class="st">'price'</span>, <span class="st">'number_of_reviews'</span>, <span class="st">'property_type'</span>, <span class="st">'host_name'</span>]].head(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 139 ms, sys: 48.5 ms, total: 187 ms
Wall time: 143 ms</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">listing_url</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">number_of_reviews</th>
<th data-quarto-table-cell-role="th">property_type</th>
<th data-quarto-table-cell-role="th">host_name</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">92644</td>
<td>https://www.airbnb.com/rooms/92644</td>
<td>42.0</td>
<td>216</td>
<td>Private room in rental unit</td>
<td>Dee Dee</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">93015</td>
<td>https://www.airbnb.com/rooms/93015</td>
<td>175.0</td>
<td>38</td>
<td>Entire rental unit</td>
<td>Sarah</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">13913</td>
<td>https://www.airbnb.com/rooms/13913</td>
<td>79.0</td>
<td>41</td>
<td>Private room in rental unit</td>
<td>Alina</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15400</td>
<td>https://www.airbnb.com/rooms/15400</td>
<td>150.0</td>
<td>94</td>
<td>Entire rental unit</td>
<td>Philippa</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">93734</td>
<td>https://www.airbnb.com/rooms/93734</td>
<td>46.0</td>
<td>180</td>
<td>Private room in condo</td>
<td>William</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="filter-then-load" class="level4">
<h4 class="anchored" data-anchor-id="filter-then-load">Filter <em>then</em> load</h4>
<div id="fcb21618" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>pd.read_parquet(<span class="ss">f'</span><span class="sc">{</span>pqt<span class="sc">}</span><span class="ss">'</span>, columns<span class="op">=</span>[<span class="st">'listing_url'</span>, <span class="st">'price'</span>, <span class="st">'number_of_reviews'</span>, <span class="st">'property_type'</span>, <span class="st">'host_name'</span>]).head(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 14.6 ms, sys: 1.84 ms, total: 16.5 ms
Wall time: 13.1 ms</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">listing_url</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">number_of_reviews</th>
<th data-quarto-table-cell-role="th">property_type</th>
<th data-quarto-table-cell-role="th">host_name</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">92644</td>
<td>https://www.airbnb.com/rooms/92644</td>
<td>42.0</td>
<td>216</td>
<td>Private room in rental unit</td>
<td>Dee Dee</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">93015</td>
<td>https://www.airbnb.com/rooms/93015</td>
<td>175.0</td>
<td>38</td>
<td>Entire rental unit</td>
<td>Sarah</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">13913</td>
<td>https://www.airbnb.com/rooms/13913</td>
<td>79.0</td>
<td>41</td>
<td>Private room in rental unit</td>
<td>Alina</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15400</td>
<td>https://www.airbnb.com/rooms/15400</td>
<td>150.0</td>
<td>94</td>
<td>Entire rental unit</td>
<td>Philippa</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">93734</td>
<td>https://www.airbnb.com/rooms/93734</td>
<td>46.0</td>
<td>180</td>
<td>Private room in condo</td>
<td>William</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Notice the difference in time!!!</p>
</section>
</section>
<section id="recap-adding-a-constraint" class="level3">
<h3 class="anchored" data-anchor-id="recap-adding-a-constraint">Recap: Adding a constraint</h3>
<div id="7ad73c3b" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_parquet(<span class="ss">f'</span><span class="sc">{</span>pqt<span class="sc">}</span><span class="ss">'</span>, columns<span class="op">=</span>[<span class="st">'listing_url'</span>, <span class="st">'price'</span>, <span class="st">'number_of_reviews'</span>, <span class="st">'property_type'</span>, <span class="st">'host_name'</span>])</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>df[(df.price <span class="op">&lt;</span> <span class="dv">250</span>) <span class="op">&amp;</span> (df.number_of_reviews <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">&amp;</span> (df.property_type<span class="op">==</span><span class="st">'Entire home/apt'</span>)].head(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">listing_url</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">number_of_reviews</th>
<th data-quarto-table-cell-role="th">property_type</th>
<th data-quarto-table-cell-role="th">host_name</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">20296839</td>
<td>https://www.airbnb.com/rooms/20296839</td>
<td>96.0</td>
<td>7</td>
<td>Entire home/apt</td>
<td>Lira</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">20349067</td>
<td>https://www.airbnb.com/rooms/20349067</td>
<td>99.0</td>
<td>1</td>
<td>Entire home/apt</td>
<td>M</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">22959348</td>
<td>https://www.airbnb.com/rooms/22959348</td>
<td>100.0</td>
<td>3</td>
<td>Entire home/apt</td>
<td>Robert</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">42969992</td>
<td>https://www.airbnb.com/rooms/42969992</td>
<td>173.0</td>
<td>1</td>
<td>Entire home/apt</td>
<td>Duda</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">649784743352942848</td>
<td>https://www.airbnb.com/rooms/649784743352942906</td>
<td>91.0</td>
<td>9</td>
<td>Entire home/apt</td>
<td>Travelnest</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>For improved legibility you can also write this as:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_parquet(<span class="ss">f'</span><span class="sc">{</span>pqt<span class="sc">}</span><span class="ss">'</span>, columns<span class="op">=</span>[<span class="st">'listing_url'</span>, <span class="st">'price'</span>, <span class="st">'number_of_reviews'</span>, <span class="st">'last_review'</span>, <span class="st">'host_name'</span>])</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>df[</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    (df.price <span class="op">&lt;</span> <span class="dv">250</span>) <span class="op">&amp;</span> </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    (df.number_of_reviews <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">&amp;</span> </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    (df.property_type<span class="op">==</span><span class="st">'Entire home/apt'</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>].head(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Notice here that we are using three conditions to filter the data <em>as well as</em> a column filter on loading to minimise the amount of data loaded into memory. Applying the filters simultaneously will also make it easy to see what you’ve done (you aren’t applying each one separately) and to adjust the overall cleaning process.</p>
<p>This filter is fairly straightforward, but things get more complicated when you want to aggregate the return…</p>
</section>
<section id="aggregating-the-return" class="level3">
<h3 class="anchored" data-anchor-id="aggregating-the-return">Aggregating the return</h3>
<p>There is a <em>lot</em> to unpack here, and notice that it takes three steps to achieve our goal of selecting, grouping, aggregating, sorting, and printing out the ten most frequent combinations of room and property type.</p>
<div id="e99e6a58" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_parquet(<span class="ss">f'</span><span class="sc">{</span>pqt<span class="sc">}</span><span class="ss">'</span>, columns<span class="op">=</span>[<span class="st">'property_type'</span>,<span class="st">'room_type'</span>,<span class="st">'number_of_reviews'</span>,<span class="st">'price'</span>])</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    (df.price <span class="op">&lt;</span> <span class="dv">1050</span>) <span class="op">&amp;</span> </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    (df.number_of_reviews <span class="op">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>df.groupby(</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        by<span class="op">=</span>[<span class="st">'room_type'</span>,<span class="st">'property_type'</span>],</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>        observed<span class="op">=</span><span class="va">True</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    ).agg(</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>        freq <span class="op">=</span> (<span class="st">"property_type"</span>, <span class="st">"count"</span>),</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>        median_price <span class="op">=</span> (<span class="st">"price"</span>, <span class="st">"median"</span>),</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>).reset_index().sort_values(</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>        by<span class="op">=</span>[<span class="st">'freq'</span>,<span class="st">'room_type'</span>,<span class="st">'property_type'</span>], ascending<span class="op">=</span>[<span class="va">False</span>,<span class="va">True</span>,<span class="va">True</span>]</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    ).head(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">room_type</th>
<th data-quarto-table-cell-role="th">property_type</th>
<th data-quarto-table-cell-role="th">freq</th>
<th data-quarto-table-cell-role="th">median_price</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>Entire home/apt</td>
<td>Entire rental unit</td>
<td>24665</td>
<td>136.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">68</td>
<td>Private room</td>
<td>Private room in rental unit</td>
<td>9763</td>
<td>52.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">59</td>
<td>Private room</td>
<td>Private room in home</td>
<td>7800</td>
<td>49.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">10</td>
<td>Entire home/apt</td>
<td>Entire condo</td>
<td>7543</td>
<td>156.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>Entire home/apt</td>
<td>Entire home</td>
<td>5243</td>
<td>200.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">52</td>
<td>Private room</td>
<td>Private room in condo</td>
<td>2883</td>
<td>67.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">19</td>
<td>Entire home/apt</td>
<td>Entire serviced apartment</td>
<td>1565</td>
<td>200.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">72</td>
<td>Private room</td>
<td>Private room in townhouse</td>
<td>1205</td>
<td>55.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20</td>
<td>Entire home/apt</td>
<td>Entire townhouse</td>
<td>967</td>
<td>235.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">45</td>
<td>Private room</td>
<td>Private room in bed and breakfast</td>
<td>412</td>
<td>78.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Hopefully the first two steps are fairly clear, so let’s focus on the final one:</p>
<section id="group-by" class="level4">
<h4 class="anchored" data-anchor-id="group-by">Group By</h4>
<p>This is a <em>reasonably</em> intelligible step in which we group the data loaded by room and property:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>dfg <span class="op">=</span> df.groupby(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>        by<span class="op">=</span>[<span class="st">'room_type'</span>,<span class="st">'property_type'</span>],</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>        observed<span class="op">=</span><span class="va">True</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>dfg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <em>order</em> here matters: <code>groupby(by=[&lt;A&gt;,&lt;B&gt;])</code> does not return the same result as <code>groupby(by=[&lt;B&gt;,&lt;A&gt;])</code>. Try it:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>df.groupby(</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>        by<span class="op">=</span>[<span class="st">'property_type'</span>,<span class="st">'room_type'</span>],</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>        observed<span class="op">=</span><span class="va">True</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The other thing to note here is the <code>observed=True</code>. This is a nice bit of additional functionality that, if you set it to <code>False</code> will return a number for all possible combinations, inserting a zero if that combintaion is <em>not</em> observed in the data.</p>
</section>
<section id="agg" class="level4">
<h4 class="anchored" data-anchor-id="agg">Agg</h4>
<p>The <code>agg</code> step aggregates the data specified in the functions:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>dfg.agg(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>        freq <span class="op">=</span> (<span class="st">"property_type"</span>, <span class="st">"count"</span>),</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>        median_price <span class="op">=</span> (<span class="st">"price"</span>, <span class="st">"median"</span>),</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Pandas offers a <em>lot</em> of different ways to do this, but the above approach is perhaps the most flexible since we are telling Pandas to apply the <code>count</code> function to the <code>property_type</code> field and assign it to a column called <code>freq</code>, and to apply the <code>median</code> function to the <code>price</code> field and assign that to a column called <code>median_price</code>.</p>
</section>
<section id="degroup" class="level4">
<h4 class="anchored" data-anchor-id="degroup">‘Degroup’</h4>
<p>In order to work with the aggregated data you will <em>almost</em> always want to convert your <code>GroupedDataFrame</code> back to a regular <code>DataFrame</code> and that means resetting the index <code>reset_index()</code> – this is just one of those things to learn about grouped data in Pandas.</p>
</section>
<section id="sort" class="level4">
<h4 class="anchored" data-anchor-id="sort">Sort</h4>
<p>Finally, to sort the <em>data</em> (which is usually what you want) you need to <code>sort_values</code>, where <code>by</code> specifies the fields you want to sort on and <code>ascending</code> is a matching (optional) list that specifies the sort order for each sort column. If you just want to sort everything in ascending order then you don’t need to specify the <code>ascending</code> values, and if you wanted to sort <em>everything</em> in descending order then it’s just <code>ascending=False</code>.</p>
</section>
</section>
</section>
<section id="in-sql" class="level2">
<h2 class="anchored" data-anchor-id="in-sql">In SQL</h2>
<p>That last example may have left you despairing of every being able to select/filter/aggregate/derive your data, but there <em>is</em> another way that is often far simpler <em>if</em> you are: a) willing to learn a different language, and b) willing to work with data in different formats. And that’s all thanks to Parquet and DuckDB.</p>
<section id="parquet-and-duckdb" class="level3">
<h3 class="anchored" data-anchor-id="parquet-and-duckdb">Parquet and DuckDB</h3>
<p>One of the recent technical <em>revolutions</em> that has fundamentally reshaped my workflow is the combination of parquet files and in-memory databases. Parquet and Apache Arrow are <a href="https://stackoverflow.com/a/56481636">closely related</a> but, in short, when you want to save large data sets in an easy-to-access format then Parquet should be your default choice. DuckDB gives you a way to treat Parquet files <em>as</em> a database <strong>table</strong> and run queries against it using standard SQL. You can <a href="https://duckdb.org/#quickinstall">install DuckDB</a> on the command-line, but you can also query it from within Python using the appropriate module.</p>
</section>
<section id="a-first-query" class="level3">
<h3 class="anchored" data-anchor-id="a-first-query">A First Query</h3>
<p>Let’s see a quick demonstration:</p>
<div id="2ab39f30" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> duckdb <span class="im">as</span> db</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f'''</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="ss">SELECT *</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="ss">FROM read_parquet('</span><span class="sc">{</span>pqt<span class="sc">}</span><span class="ss">') </span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="ss">LIMIT 3;</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="ss">'''</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>db.sql(query).to_df()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">listing_url</th>
<th data-quarto-table-cell-role="th">last_scraped</th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">description</th>
<th data-quarto-table-cell-role="th">host_id</th>
<th data-quarto-table-cell-role="th">host_name</th>
<th data-quarto-table-cell-role="th">host_since</th>
<th data-quarto-table-cell-role="th">host_location</th>
<th data-quarto-table-cell-role="th">host_is_superhost</th>
<th data-quarto-table-cell-role="th">host_listings_count</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">minimum_nights</th>
<th data-quarto-table-cell-role="th">maximum_nights</th>
<th data-quarto-table-cell-role="th">availability_365</th>
<th data-quarto-table-cell-role="th">number_of_reviews</th>
<th data-quarto-table-cell-role="th">first_review</th>
<th data-quarto-table-cell-role="th">last_review</th>
<th data-quarto-table-cell-role="th">review_scores_rating</th>
<th data-quarto-table-cell-role="th">reviews_per_month</th>
<th data-quarto-table-cell-role="th">geometry</th>
<th data-quarto-table-cell-role="th">id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>https://www.airbnb.com/rooms/92644</td>
<td>2023-09-06</td>
<td>Rental unit in Earlsfield · ★4.57 · 1 bedroom ...</td>
<td>&lt;b&gt;The space&lt;/b&gt;&lt;br /&gt;Hi everyone! I have 2 ro...</td>
<td>498201</td>
<td>Dee Dee</td>
<td>2011-04-10</td>
<td>London, United Kingdom</td>
<td>False</td>
<td>1</td>
<td>...</td>
<td>2</td>
<td>730</td>
<td>217</td>
<td>216</td>
<td>2011-06-21</td>
<td>2022-10-29</td>
<td>4.57</td>
<td>1.45</td>
<td>[1, 1, 0, 0, 0, 234, 120, 204, 64, 101, 252, 1...</td>
<td>92644</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>https://www.airbnb.com/rooms/93015</td>
<td>2023-09-06</td>
<td>Rental unit in Hammersmith · ★4.82 · 2 bedroom...</td>
<td>Gorgeous 2 bed ground floor apartment with per...</td>
<td>499704</td>
<td>Sarah</td>
<td>2011-04-11</td>
<td>London, United Kingdom</td>
<td>False</td>
<td>1</td>
<td>...</td>
<td>5</td>
<td>240</td>
<td>40</td>
<td>38</td>
<td>2012-02-01</td>
<td>2022-09-30</td>
<td>4.82</td>
<td>0.27</td>
<td>[1, 1, 0, 0, 0, 13, 171, 120, 35, 243, 200, 20...</td>
<td>93015</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>https://www.airbnb.com/rooms/13913</td>
<td>2023-09-06</td>
<td>Rental unit in Islington · ★4.80 · 1 bedroom ·...</td>
<td>My bright double bedroom with a large window h...</td>
<td>54730</td>
<td>Alina</td>
<td>2009-11-16</td>
<td>London, United Kingdom</td>
<td>False</td>
<td>3</td>
<td>...</td>
<td>1</td>
<td>29</td>
<td>360</td>
<td>41</td>
<td>2010-08-18</td>
<td>2022-12-11</td>
<td>4.80</td>
<td>0.26</td>
<td>[1, 1, 0, 0, 0, 238, 90, 66, 62, 232, 217, 188...</td>
<td>13913</td>
</tr>
</tbody>
</table>

<p>3 rows × 32 columns</p>
</div>
</div>
</div>
<p>And now let’s unpack this:</p>
<ol type="1">
<li>We import the <code>duckdb</code> library as <code>db</code>.</li>
<li>We set up a SQL <code>query</code> using a multi-line f-string</li>
<li>We use DuckDb to execute the query and return a pandas dataframe (<code>df</code>)</li>
</ol>
<p>What’s particularly elegant here (and quite different from trying to talk to a Postres or MySQL database) is that there’s no connect-execute-collect pattern; we just build the query and execute it!</p>
</section>
<section id="deciphering-sql" class="level3">
<h3 class="anchored" data-anchor-id="deciphering-sql">Deciphering SQL</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
I <em>do</em> declare…
</div>
</div>
<div class="callout-body-container callout-body">
<p>Now let’s take a look at the SQL query… SQL is what’s called a <a href="https://en.wikipedia.org/wiki/Declarative_programming">declarative language</a>, meaning that it is about the logic we want the program to follow rather than the ‘flow’ of execution. Python supports <em>some</em> declarative elements but is more commonly seen as an imperative language supporting procedural or functional approaches. This is a long way of saying: SQL won’t look like Python even though we’re executing SQL from <em>within</em> Python.</p>
</div>
</div>
<p>So our query (with added line numbers for clarity) looked liked this:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb18-1"><a href="#cb18-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="kw">FROM</span> read_parquet(<span class="st">'{pqt}'</span>) </span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="kw">LIMIT</span> <span class="dv">3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Line-by-line this means:</p>
<ol type="1">
<li>Select all columns (<code>SELECT &lt;* == everything&gt;</code>)</li>
<li>From the parquet file (<code>FROM &lt;table location&gt;</code>)</li>
<li>Limit the return to 3 rows (<code>LIMIT &lt;row count&gt;</code>)</li>
</ol>
<p>Let’s look at some variations…</p>
</section>
<section id="choosing-some-columns" class="level3">
<h3 class="anchored" data-anchor-id="choosing-some-columns">Choosing some columns</h3>
<div id="15d441a9" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f'''</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="ss">SELECT listing_url, price, number_of_reviews, last_review, host_name </span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="ss">FROM read_parquet('</span><span class="sc">{</span>pqt<span class="sc">}</span><span class="ss">') </span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="ss">LIMIT 5;</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="ss">'''</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>db.sql(query).to_df()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">listing_url</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">number_of_reviews</th>
<th data-quarto-table-cell-role="th">last_review</th>
<th data-quarto-table-cell-role="th">host_name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>https://www.airbnb.com/rooms/92644</td>
<td>42.0</td>
<td>216</td>
<td>2022-10-29</td>
<td>Dee Dee</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>https://www.airbnb.com/rooms/93015</td>
<td>175.0</td>
<td>38</td>
<td>2022-09-30</td>
<td>Sarah</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>https://www.airbnb.com/rooms/13913</td>
<td>79.0</td>
<td>41</td>
<td>2022-12-11</td>
<td>Alina</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>https://www.airbnb.com/rooms/15400</td>
<td>150.0</td>
<td>94</td>
<td>2023-05-01</td>
<td>Philippa</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>https://www.airbnb.com/rooms/93734</td>
<td>46.0</td>
<td>180</td>
<td>2023-09-02</td>
<td>William</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="sourceCode" id="cb20"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb20-1"><a href="#cb20-1"></a><span class="kw">SELECT</span> listing_url, price, number_of_reviews, last_review, host_name </span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="kw">FROM</span> read_parquet(<span class="st">'{pqt}'</span>) </span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="kw">LIMIT</span> <span class="dv">5</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>It should be fairly easy to see how the query has changed from last time, but line-by-line this means:</p>
<ol type="1">
<li>Select a set of columns from the table in the order specified (<code>SELECT &lt;column 1&gt;, &lt;column 30&gt;, &lt;column 5&gt;...</code>)</li>
<li>From the parquet file (<code>FROM &lt;table location&gt;</code>)</li>
<li>Limit the return to 5 rows (<code>LIMIT &lt;row count&gt;</code>)</li>
</ol>
</section>
<section id="adding-a-constraint" class="level3">
<h3 class="anchored" data-anchor-id="adding-a-constraint">Adding a constraint</h3>
<div id="1e8f4a7c" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f'''</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="ss">SELECT listing_url, price, number_of_reviews, last_review, host_name </span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="ss">FROM read_parquet('</span><span class="sc">{</span>pqt<span class="sc">}</span><span class="ss">') </span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="ss">WHERE price &lt; 250 </span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="ss">AND number_of_reviews &gt; 0</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="ss">AND property_type='Entire home/apt'</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="ss">LIMIT 5;</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="ss">'''</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>db.sql(query).to_df()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">listing_url</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">number_of_reviews</th>
<th data-quarto-table-cell-role="th">last_review</th>
<th data-quarto-table-cell-role="th">host_name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>https://www.airbnb.com/rooms/20296839</td>
<td>96.0</td>
<td>7</td>
<td>2017-10-01</td>
<td>Lira</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>https://www.airbnb.com/rooms/20349067</td>
<td>99.0</td>
<td>1</td>
<td>2017-11-12</td>
<td>M</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>https://www.airbnb.com/rooms/22959348</td>
<td>100.0</td>
<td>3</td>
<td>2018-02-04</td>
<td>Robert</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>https://www.airbnb.com/rooms/42969992</td>
<td>173.0</td>
<td>1</td>
<td>2021-10-24</td>
<td>Duda</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>https://www.airbnb.com/rooms/649784743352942906</td>
<td>91.0</td>
<td>9</td>
<td>2023-03-22</td>
<td>Travelnest</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>In this query we’ve added <em>three</em> constraints using a <code>WHERE</code>, which is asking DuckDB to find all of the rows <em>where</em> the following things are true:</p>
<ol start="4" type="1">
<li>The <code>price</code> must be less than ($)250/night</li>
<li>The <code>number_of_reviews</code> must be more than 0</li>
<li>The <code>property_type</code> must be <code>Entire home/apt</code></li>
</ol>
</section>
<section id="aggregating-the-return-1" class="level3">
<h3 class="anchored" data-anchor-id="aggregating-the-return-1">Aggregating the return</h3>
<p>So far, we’ve seen a few ways (and hopefully enough to get you started) to <em>select</em> data, but databases also ‘excel’ at aggregating data in various ways. We aren’t going to get into things like windowing functions or stored procedures here, but even simple aggregates done in DuckDB can vastly improve on the performance of pandas.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>When you aggregate data you need to retrieve <em>every</em> column in the <code>SELECT</code> portion that you <code>GROUP BY</code> in the <code>WHERE</code> portion of the query. This will make sense when you see the examples below… (and should also make sense based on the Pandas equivalent above)</p>
</div>
</div>
<div id="c31dafdf" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f'''</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="ss">SELECT property_type, room_type, COUNT(*) AS frequency, MEDIAN(price) </span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="ss">FROM read_parquet('</span><span class="sc">{</span>pqt<span class="sc">}</span><span class="ss">') </span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="ss">WHERE price &lt; 1000 </span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="ss">AND number_of_reviews &gt; 0</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="ss">GROUP BY room_type, property_type</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="ss">ORDER BY frequency DESC, room_type, property_type</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="ss">LIMIT 10;</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="ss">'''</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>db.sql(query).to_df()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">property_type</th>
<th data-quarto-table-cell-role="th">room_type</th>
<th data-quarto-table-cell-role="th">frequency</th>
<th data-quarto-table-cell-role="th">median(price)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Entire rental unit</td>
<td>Entire home/apt</td>
<td>24637</td>
<td>136.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Private room in rental unit</td>
<td>Private room</td>
<td>9754</td>
<td>52.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Private room in home</td>
<td>Private room</td>
<td>7797</td>
<td>49.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Entire condo</td>
<td>Entire home/apt</td>
<td>7533</td>
<td>155.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Entire home</td>
<td>Entire home/apt</td>
<td>5228</td>
<td>200.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>Private room in condo</td>
<td>Private room</td>
<td>2880</td>
<td>67.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Entire serviced apartment</td>
<td>Entire home/apt</td>
<td>1565</td>
<td>200.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>Private room in townhouse</td>
<td>Private room</td>
<td>1204</td>
<td>55.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>Entire townhouse</td>
<td>Entire home/apt</td>
<td>964</td>
<td>234.5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>Private room in bed and breakfast</td>
<td>Private room</td>
<td>412</td>
<td>78.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>There are quite a few changes to the query here so it’s worth reviewing them in more detail:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb23-1"><a href="#cb23-1"></a><span class="kw">SELECT</span> property_type, room_type, <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> frequency, <span class="fu">MEDIAN</span>(price) </span>
<span id="cb23-2"><a href="#cb23-2"></a><span class="kw">FROM</span> read_parquet(<span class="st">'{pqt}'</span>) </span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="kw">WHERE</span> price <span class="op">&lt;</span> <span class="dv">1000</span> </span>
<span id="cb23-4"><a href="#cb23-4"></a><span class="kw">AND</span> number_of_reviews <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb23-5"><a href="#cb23-5"></a><span class="kw">GROUP</span> <span class="kw">BY</span> room_type, property_type</span>
<span id="cb23-6"><a href="#cb23-6"></a><span class="kw">ORDER</span> <span class="kw">BY</span> frequency <span class="kw">DESC</span>, room_type, property_type</span>
<span id="cb23-7"><a href="#cb23-7"></a><span class="kw">LIMIT</span> <span class="dv">10</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Key things to note:</p>
<ol type="1">
<li>We have two new aggregate <em>functions</em>:
<ul>
<li><code>COUNT(*)</code> returns a count of the number of rows in each group specified in the <code>GROUP BY</code> clause.</li>
<li><code>MEDIAN(price)</code> returns, unsurprisingly, the median value of the <code>price</code> column for each group specified in the <code>GROUP BY</code> clause.</li>
<li><em>Note</em> also the <code>AS frequency</code> which ‘renames’ the column returned by the query; it’s the same concept as the <code>import x as y</code> in Python.</li>
</ul></li>
<li><code>GROUP BY</code> is where the aggregation happens, and here we’re asking DuckDB to take all of the rows selected (<code>WHERE price &lt; 1000 AND number_of_reviews &gt; 0</code>) and group them using the <code>room_type</code> and <code>property_type</code> fields.</li>
<li><code>ORDER BY</code> orders the returned records by the columns we specify, and they can be either <code>ASC</code>ending (the default) or <code>DESC</code>ending (descending).</li>
</ol>
<p>What you should also be noting here is that:</p>
<ul>
<li>This query returns <em>very</em> quickly compared to the pandas equivalent.</li>
<li>We have been able to express our selection, grouping, and organising criteria very succinctly.</li>
</ul>
<p>In terms of both speed and intelligibility, there can be quite substantial advantages to moving <em>some</em> of your workflow into a database or a database-like format such as Parquet and then querying that from Python. Databases are <em>designed</em> for the kind of application that Pandas struggles with, and if you get to windowing functions and stored procedures you’ll see how there are situations where something is far easier to express in Python/Pandas than in SQL.</p>
<p>So the trick here is to recognise when you are facing a problem that: a) will benefit from being expressed/tackled in a different language; and b) won’t create undue overhead on your technology ‘stack’. In working with environmental and built environment data I was able to cut the processing time by 80% when I moved the bulk of the data linkage work from Pandas into Parquet+DuckDB. <em>But</em>, by the same token, what’s the point of using Postgres and managing a spatial database to perform a single step in a much longer workflow <em>unless</em> the performance considerations are so massive they outweigh any other issue.</p>
</section>
</section>
</section>
<section id="sec-nonspatial" class="level1">
<h1>Non-Spatial Joins</h1>
<p>We’re going to look at joining data by attributes <em>first</em> and then look at spatial joins so that you get a sense of how they behave and differ.</p>
<p>For non-spatial joins we only need two data sets relating to MSOAs:</p>
<div id="a7ce90c4" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>msoa_names_url <span class="op">=</span> <span class="st">'https://houseofcommonslibrary.github.io/msoanames/MSOA-Names-1.20.csv'</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>msoa_popst_url <span class="op">=</span> <span class="st">'https://orca.casa.ucl.ac.uk/~jreades/data/sapemsoaquinaryagetablefinal.xlsx'</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>msoa_df <span class="op">=</span> pd.read_excel(msoa_popst_url, sheet_name<span class="op">=</span><span class="st">"Mid-2022 MSOA 2021"</span>, header<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>msoa_nms <span class="op">=</span> pd.read_csv( cache_data(msoa_names_url, <span class="st">'data'</span>) )</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="co"># For DuckDB</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(<span class="st">'data/MSOA_population_estimates.parquet'</span>):</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    msoa_df.to_parquet(<span class="st">'data/MSOA_population_estimates.parquet'</span>)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"msoa_df  has </span><span class="sc">{</span>msoa_df<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss"> rows and </span><span class="sc">{</span>msoa_df<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">:,}</span><span class="ss"> columns."</span>)</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"msoa_nms has </span><span class="sc">{</span>msoa_nms<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss"> rows and </span><span class="sc">{</span>msoa_nms<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">:,}</span><span class="ss"> columns."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Found data/MSOA-Names-1.20.csv locally!
msoa_df  has 7,264 rows and 43 columns.
msoa_nms has 7,201 rows and 6 columns.</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The preferred solution
</div>
</div>
<div class="callout-body-container callout-body">
<p>To keep it simple: you should assume that non-spatial joins are <em>always</em> going to be faster than spatial ones, even in a performant spatial database. Asking if one number is less than another, or if a piece of text is found in another piece of text, is <em>much</em> simpler than asking if one object falls within the boundaries of another. Spatial databases are fast and very cool, but if you can express your problem non-spatially it will be faster to solve it that way too.</p>
</div>
</div>
<section id="in-pandas-1" class="level2">
<h2 class="anchored" data-anchor-id="in-pandas-1">In Pandas</h2>
<p>Pandas distinguishes between several types of what SQL would call a ‘join’: the process of linking two data sets. Depending on what you want to do, this will fall into one of the <a href="https://pandas.pydata.org/docs/user_guide/merging.html">merge, join, concatenate, or compare</a> functions:</p>
<ul>
<li><code>concat</code> simply appends one data frame to another and won’t be discussed further, but keep in mind that you can concatenate horizontally and vertically (across and down), and that having named indexes can cause consternation. You would find it most useful for appending columns to a data set (appending rows should be approached differently) or extending a data set for year <span class="math inline">\(n\)</span> with data from year <span class="math inline">\(n+1\)</span>…</li>
<li><code>merge</code> is what we normally want when we want to do something similar to a SQL join. You should refer back to the lecture for the differences between ‘one-to-one’, ‘one-to-many’, and ‘many-to-many’. Note too that merging is a function of the pandas library and <em>not</em> a method of a data frame.</li>
</ul>
<section id="joining-by-attribute" class="level3">
<h3 class="anchored" data-anchor-id="joining-by-attribute">Joining by attribute</h3>
<p>So in our case, to join the two MSOA data sets we’re going to need to match the MSOA codes which have (slightly) different names in the two datasets:</p>
<div id="7f46b171" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>rs <span class="op">=</span> pd.merge(msoa_df, msoa_nms[[<span class="st">'msoa11cd'</span>,<span class="st">'msoa11hclnm'</span>,<span class="st">'Laname'</span>]], left_on<span class="op">=</span><span class="st">'MSOA 2021 Code'</span>, right_on<span class="op">=</span><span class="st">'msoa11cd'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Result set has </span><span class="sc">{</span>rs<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss"> rows and </span><span class="sc">{</span>rs<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">:,}</span><span class="ss"> columns."</span>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>rs.head(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Result set has 7,264 rows and 46 columns.
CPU times: user 2.5 ms, sys: 386 µs, total: 2.89 ms
Wall time: 2.82 ms</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="15">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">LAD 2021 Code</th>
<th data-quarto-table-cell-role="th">LAD 2021 Name</th>
<th data-quarto-table-cell-role="th">MSOA 2021 Code</th>
<th data-quarto-table-cell-role="th">MSOA 2021 Name</th>
<th data-quarto-table-cell-role="th">Total</th>
<th data-quarto-table-cell-role="th">F0 to 4</th>
<th data-quarto-table-cell-role="th">F5 to 9</th>
<th data-quarto-table-cell-role="th">F10 to 14</th>
<th data-quarto-table-cell-role="th">F15 to 19</th>
<th data-quarto-table-cell-role="th">F20 to 24</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">M60 to 64</th>
<th data-quarto-table-cell-role="th">M65 to 69</th>
<th data-quarto-table-cell-role="th">M70 to 74</th>
<th data-quarto-table-cell-role="th">M75 to 79</th>
<th data-quarto-table-cell-role="th">M80 to 84</th>
<th data-quarto-table-cell-role="th">M85 to 89</th>
<th data-quarto-table-cell-role="th">M90 and over</th>
<th data-quarto-table-cell-role="th">msoa11cd</th>
<th data-quarto-table-cell-role="th">msoa11hclnm</th>
<th data-quarto-table-cell-role="th">Laname</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>E06000001</td>
<td>Hartlepool</td>
<td>E02002483</td>
<td>Hartlepool 001</td>
<td>10323</td>
<td>265</td>
<td>296</td>
<td>356</td>
<td>302</td>
<td>238</td>
<td>...</td>
<td>281</td>
<td>254</td>
<td>210</td>
<td>180</td>
<td>93</td>
<td>82</td>
<td>28</td>
<td>E02002483</td>
<td>Clavering</td>
<td>Hartlepool</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>E06000001</td>
<td>Hartlepool</td>
<td>E02002484</td>
<td>Hartlepool 002</td>
<td>10460</td>
<td>325</td>
<td>349</td>
<td>295</td>
<td>340</td>
<td>283</td>
<td>...</td>
<td>363</td>
<td>276</td>
<td>248</td>
<td>175</td>
<td>86</td>
<td>49</td>
<td>28</td>
<td>E02002484</td>
<td>Headland &amp; West View</td>
<td>Hartlepool</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>E06000001</td>
<td>Hartlepool</td>
<td>E02002485</td>
<td>Hartlepool 003</td>
<td>8040</td>
<td>238</td>
<td>287</td>
<td>295</td>
<td>262</td>
<td>225</td>
<td>...</td>
<td>272</td>
<td>198</td>
<td>159</td>
<td>143</td>
<td>61</td>
<td>31</td>
<td>12</td>
<td>E02002485</td>
<td>Jesmond</td>
<td>Hartlepool</td>
</tr>
</tbody>
</table>

<p>3 rows × 46 columns</p>
</div>
</div>
</div>
<p><strong>But wait!</strong> There’s an issue lurking in the data!</p>
<div id="527bd1a7" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"There are </span><span class="sc">{</span>rs<span class="sc">.</span>msoa11hclnm<span class="sc">.</span>isna()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> missing MSOA Names!"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>There are 184 missing MSOA Names!</code></pre>
</div>
</div>
<p>Can you work out why this has happened? There is a clue in the column names!</p>
<p>There’s no way to solve this problem except by changing the code to use <a href="https://houseofcommonslibrary.github.io/msoanames/MSOA-Names-Latest2.csv">this URL instead</a> for the MSOA Names.</p>
<p>We can also try to constrain the result set to one LA thanks to data in the MSOA Names database:</p>
<div id="15881833" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time </span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>la_nm <span class="op">=</span> <span class="st">'Waltham Forest'</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>sdf   <span class="op">=</span> msoa_nms[msoa_nms.Laname<span class="op">==</span>la_nm][[<span class="st">'msoa11cd'</span>,<span class="st">'msoa11hclnm'</span>,<span class="st">'Laname'</span>]].copy()</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>rs <span class="op">=</span> pd.merge(msoa_df, sdf, left_on<span class="op">=</span><span class="st">'MSOA 2021 Code'</span>, right_on<span class="op">=</span><span class="st">'msoa11cd'</span>, how<span class="op">=</span><span class="st">'inner'</span>)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Result set has </span><span class="sc">{</span>rs<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss"> rows and </span><span class="sc">{</span>rs<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">:,}</span><span class="ss"> columns."</span>)</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>rs.head(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Result set has 28 rows and 46 columns.
CPU times: user 1.73 ms, sys: 219 µs, total: 1.95 ms
Wall time: 1.85 ms</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="17">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">LAD 2021 Code</th>
<th data-quarto-table-cell-role="th">LAD 2021 Name</th>
<th data-quarto-table-cell-role="th">MSOA 2021 Code</th>
<th data-quarto-table-cell-role="th">MSOA 2021 Name</th>
<th data-quarto-table-cell-role="th">Total</th>
<th data-quarto-table-cell-role="th">F0 to 4</th>
<th data-quarto-table-cell-role="th">F5 to 9</th>
<th data-quarto-table-cell-role="th">F10 to 14</th>
<th data-quarto-table-cell-role="th">F15 to 19</th>
<th data-quarto-table-cell-role="th">F20 to 24</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">M60 to 64</th>
<th data-quarto-table-cell-role="th">M65 to 69</th>
<th data-quarto-table-cell-role="th">M70 to 74</th>
<th data-quarto-table-cell-role="th">M75 to 79</th>
<th data-quarto-table-cell-role="th">M80 to 84</th>
<th data-quarto-table-cell-role="th">M85 to 89</th>
<th data-quarto-table-cell-role="th">M90 and over</th>
<th data-quarto-table-cell-role="th">msoa11cd</th>
<th data-quarto-table-cell-role="th">msoa11hclnm</th>
<th data-quarto-table-cell-role="th">Laname</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>E09000031</td>
<td>Waltham Forest</td>
<td>E02000895</td>
<td>Waltham Forest 001</td>
<td>8363</td>
<td>208</td>
<td>233</td>
<td>250</td>
<td>228</td>
<td>215</td>
<td>...</td>
<td>242</td>
<td>209</td>
<td>153</td>
<td>194</td>
<td>137</td>
<td>93</td>
<td>45</td>
<td>E02000895</td>
<td>Chingford Green West</td>
<td>Waltham Forest</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>E09000031</td>
<td>Waltham Forest</td>
<td>E02000896</td>
<td>Waltham Forest 002</td>
<td>9322</td>
<td>256</td>
<td>278</td>
<td>264</td>
<td>230</td>
<td>241</td>
<td>...</td>
<td>257</td>
<td>218</td>
<td>216</td>
<td>190</td>
<td>111</td>
<td>111</td>
<td>54</td>
<td>E02000896</td>
<td>Chingford Green East</td>
<td>Waltham Forest</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>E09000031</td>
<td>Waltham Forest</td>
<td>E02000897</td>
<td>Waltham Forest 003</td>
<td>8438</td>
<td>233</td>
<td>262</td>
<td>276</td>
<td>212</td>
<td>209</td>
<td>...</td>
<td>205</td>
<td>162</td>
<td>136</td>
<td>98</td>
<td>104</td>
<td>87</td>
<td>24</td>
<td>E02000897</td>
<td>Friday Hill</td>
<td>Waltham Forest</td>
</tr>
</tbody>
</table>

<p>3 rows × 46 columns</p>
</div>
</div>
</div>
<p>Without the <code>how=inner</code>, the result set would still have all of the rows but some of the columns would be nearly completely empty.</p>
</section>
</section>
<section id="in-sql-1" class="level2">
<h2 class="anchored" data-anchor-id="in-sql-1">In SQL</h2>
<p>SQL-based joins use very similar keywords (since Pandas is copying SQL), but how we put together the query is quite different.</p>
<section id="joining-by-attribute-1" class="level3">
<h3 class="anchored" data-anchor-id="joining-by-attribute-1">Joining by attribute</h3>
<div id="995dc632" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f'''</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="ss">SELECT * </span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="ss">FROM </span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="ss">    read_parquet('data/MSOA_population_estimates.parquet') as n </span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="ss">LEFT JOIN </span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="ss">    read_csv('</span><span class="sc">{</span>cache_data(msoa_names_url, <span class="st">'data'</span>)<span class="sc">}</span><span class="ss">', header=true) as m</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="ss">ON </span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="ss">    n."MSOA 2021 Code"=m.msoa11cd;</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="ss">'''</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>db.sql(query).to_df().head(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Found data/MSOA-Names-1.20.csv locally!
CPU times: user 32.1 ms, sys: 3.17 ms, total: 35.3 ms
Wall time: 29.8 ms</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="18">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">LAD 2021 Code</th>
<th data-quarto-table-cell-role="th">LAD 2021 Name</th>
<th data-quarto-table-cell-role="th">MSOA 2021 Code</th>
<th data-quarto-table-cell-role="th">MSOA 2021 Name</th>
<th data-quarto-table-cell-role="th">Total</th>
<th data-quarto-table-cell-role="th">F0 to 4</th>
<th data-quarto-table-cell-role="th">F5 to 9</th>
<th data-quarto-table-cell-role="th">F10 to 14</th>
<th data-quarto-table-cell-role="th">F15 to 19</th>
<th data-quarto-table-cell-role="th">F20 to 24</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">M75 to 79</th>
<th data-quarto-table-cell-role="th">M80 to 84</th>
<th data-quarto-table-cell-role="th">M85 to 89</th>
<th data-quarto-table-cell-role="th">M90 and over</th>
<th data-quarto-table-cell-role="th">msoa11cd</th>
<th data-quarto-table-cell-role="th">msoa11nm</th>
<th data-quarto-table-cell-role="th">msoa11nmw</th>
<th data-quarto-table-cell-role="th">msoa11hclnm</th>
<th data-quarto-table-cell-role="th">msoa11hclnmw</th>
<th data-quarto-table-cell-role="th">Laname</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>E09000001</td>
<td>City of London</td>
<td>E02000001</td>
<td>City of London 001</td>
<td>10847</td>
<td>105</td>
<td>78</td>
<td>69</td>
<td>191</td>
<td>699</td>
<td>...</td>
<td>143</td>
<td>86</td>
<td>36</td>
<td>22</td>
<td>E02000001</td>
<td>City of London 001</td>
<td>City of London 001</td>
<td>City of London</td>
<td>None</td>
<td>City of London</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>E09000002</td>
<td>Barking and Dagenham</td>
<td>E02000002</td>
<td>Barking and Dagenham 001</td>
<td>8384</td>
<td>350</td>
<td>346</td>
<td>392</td>
<td>322</td>
<td>211</td>
<td>...</td>
<td>108</td>
<td>71</td>
<td>29</td>
<td>29</td>
<td>E02000002</td>
<td>Barking and Dagenham 001</td>
<td>Barking and Dagenham 001</td>
<td>Marks Gate</td>
<td>None</td>
<td>Barking and Dagenham</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>E09000002</td>
<td>Barking and Dagenham</td>
<td>E02000003</td>
<td>Barking and Dagenham 002</td>
<td>11803</td>
<td>494</td>
<td>431</td>
<td>359</td>
<td>330</td>
<td>372</td>
<td>...</td>
<td>125</td>
<td>91</td>
<td>40</td>
<td>19</td>
<td>E02000003</td>
<td>Barking and Dagenham 002</td>
<td>Barking and Dagenham 002</td>
<td>Chadwell Heath East</td>
<td>None</td>
<td>Barking and Dagenham</td>
</tr>
</tbody>
</table>

<p>3 rows × 49 columns</p>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Slower???
</div>
</div>
<div class="callout-body-container callout-body">
<p><em>Without</em> the data caching function, the query above may <em>appear</em> slower than the Pandas one but if you look at the timing information you’ll see that the actual time spent processing the data was less. How can that be? Notice that above we’re reading the CSV file from the House of Commons library as <em>part</em> of the join, so most of that delay is spent waiting for the CSV file to download!</p>
<p>That’s why I prefer to download a file <em>once</em> and save it locally rather than downloading the same file again and again. Plus it’s friendlier (and cheaper!) to the person or organisation providing the data to you.</p>
</div>
</div>
<p>Let’s take a look at the SQL:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb34-1"><a href="#cb34-1"></a><span class="kw">SELECT</span> <span class="op">*</span> </span>
<span id="cb34-2"><a href="#cb34-2"></a><span class="kw">FROM</span> </span>
<span id="cb34-3"><a href="#cb34-3"></a>    read_parquet(<span class="st">'data/MSOA_population_estimates.parquet'</span>) <span class="kw">as</span> n </span>
<span id="cb34-4"><a href="#cb34-4"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span> </span>
<span id="cb34-5"><a href="#cb34-5"></a>    read_csv(msoa_names_url, <span class="kw">header</span><span class="op">=</span><span class="kw">true</span>) <span class="kw">as</span> m</span>
<span id="cb34-6"><a href="#cb34-6"></a><span class="kw">ON</span> </span>
<span id="cb34-7"><a href="#cb34-7"></a>    n.<span class="ot">"MSOA 2021 Code"</span><span class="op">=</span>m.msoa11cd;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Line-by-line:</p>
<ol type="1">
<li><code>SELECT</code> every column (this is the <code>*</code>, change this if you want to only pull a subset of columns)</li>
<li><code>FROM</code> the following tables (it doesn’t really matter if the tables are on this line or the next for legibility)</li>
<li><code>&lt;table 1 from parquet&gt; as n</code> (we now refer to the data from this table using the prefix <code>n.</code>; e.g.&nbsp;<code>n.Total</code>)</li>
<li><code>LEFT JOIN</code> is the SQL way of saying to keep all of the rows in the first table (<code>n</code>, which is the first, and therefore ‘left’ table)</li>
<li><code>&lt;table 2 from csv&gt; as m</code> (we now refer to the data from this table using the prefix <code>m.</code>; e.g.&nbsp;<code>m.geometry</code>)</li>
<li><code>ON &lt;left table matching column&gt; = &lt;right table matching column&gt;</code> (here, the unusual thin is the double-quotes around the column name required to deal with the fact that the label contains spaces).</li>
</ol>
<p><em>Notice</em> how there are parallels between even quite different languages here: if you have spaces or special characters or whatever in your column name then you’re going to need to handle that a little differently, and if you have two tables to join you have a left (aka first) one and a right (aka second) one and the order matters.</p>
<p>Now, running the same query to get the Waltham Forest data can be done two ways:</p>
<div id="5d1b5933" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>boro <span class="op">=</span> <span class="st">'Waltham Forest'</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f'''</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="ss">SELECT * </span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="ss">FROM </span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="ss">    read_parquet('data/MSOA_population_estimates.parquet') as n </span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="ss">INNER JOIN </span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="ss">    read_csv('</span><span class="sc">{</span>cache_data(msoa_names_url, <span class="st">'data'</span>)<span class="sc">}</span><span class="ss">', header=true) as m</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="ss">ON </span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="ss">    n."MSOA 2021 Code"=m.msoa11cd</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="ss">WHERE </span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a><span class="ss">    m.Laname='</span><span class="sc">{</span>boro<span class="sc">}</span><span class="ss">';</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a><span class="ss">'''</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>db.sql(query).to_df().head(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Found data/MSOA-Names-1.20.csv locally!
CPU times: user 22.6 ms, sys: 2.28 ms, total: 24.8 ms
Wall time: 24.4 ms</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="19">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">LAD 2021 Code</th>
<th data-quarto-table-cell-role="th">LAD 2021 Name</th>
<th data-quarto-table-cell-role="th">MSOA 2021 Code</th>
<th data-quarto-table-cell-role="th">MSOA 2021 Name</th>
<th data-quarto-table-cell-role="th">Total</th>
<th data-quarto-table-cell-role="th">F0 to 4</th>
<th data-quarto-table-cell-role="th">F5 to 9</th>
<th data-quarto-table-cell-role="th">F10 to 14</th>
<th data-quarto-table-cell-role="th">F15 to 19</th>
<th data-quarto-table-cell-role="th">F20 to 24</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">M75 to 79</th>
<th data-quarto-table-cell-role="th">M80 to 84</th>
<th data-quarto-table-cell-role="th">M85 to 89</th>
<th data-quarto-table-cell-role="th">M90 and over</th>
<th data-quarto-table-cell-role="th">msoa11cd</th>
<th data-quarto-table-cell-role="th">msoa11nm</th>
<th data-quarto-table-cell-role="th">msoa11nmw</th>
<th data-quarto-table-cell-role="th">msoa11hclnm</th>
<th data-quarto-table-cell-role="th">msoa11hclnmw</th>
<th data-quarto-table-cell-role="th">Laname</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>E09000031</td>
<td>Waltham Forest</td>
<td>E02000895</td>
<td>Waltham Forest 001</td>
<td>8363</td>
<td>208</td>
<td>233</td>
<td>250</td>
<td>228</td>
<td>215</td>
<td>...</td>
<td>194</td>
<td>137</td>
<td>93</td>
<td>45</td>
<td>E02000895</td>
<td>Waltham Forest 001</td>
<td>Waltham Forest 001</td>
<td>Chingford Green West</td>
<td>None</td>
<td>Waltham Forest</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>E09000031</td>
<td>Waltham Forest</td>
<td>E02000896</td>
<td>Waltham Forest 002</td>
<td>9322</td>
<td>256</td>
<td>278</td>
<td>264</td>
<td>230</td>
<td>241</td>
<td>...</td>
<td>190</td>
<td>111</td>
<td>111</td>
<td>54</td>
<td>E02000896</td>
<td>Waltham Forest 002</td>
<td>Waltham Forest 002</td>
<td>Chingford Green East</td>
<td>None</td>
<td>Waltham Forest</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>E09000031</td>
<td>Waltham Forest</td>
<td>E02000897</td>
<td>Waltham Forest 003</td>
<td>8438</td>
<td>233</td>
<td>262</td>
<td>276</td>
<td>212</td>
<td>209</td>
<td>...</td>
<td>98</td>
<td>104</td>
<td>87</td>
<td>24</td>
<td>E02000897</td>
<td>Waltham Forest 003</td>
<td>Waltham Forest 003</td>
<td>Friday Hill</td>
<td>None</td>
<td>Waltham Forest</td>
</tr>
</tbody>
</table>

<p>3 rows × 49 columns</p>
</div>
</div>
</div>
<p>Everything here is <em>basically</em> the same except for:</p>
<ol type="1">
<li>We changed the <code>LEFT JOIN</code> to an <code>INNER JOIN</code> – this should make sense to you if you’ve watched the lectures.</li>
<li>We added a <code>WHERE m.Laname=&lt;borough name&gt;</code> which restricts the match to only those rows where the Local Authority name is Waltham Forest.</li>
</ol>
<p><em>However</em>, note that this query can <em>also</em> be written this way:</p>
<div id="e67168b2" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>boro <span class="op">=</span> <span class="st">'Waltham Forest'</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f'''</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="ss">SELECT * </span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="ss">FROM </span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="ss">    read_parquet('data/MSOA_population_estimates.parquet') as n, </span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="ss">    read_csv('</span><span class="sc">{</span>cache_data(msoa_names_url, <span class="st">'data'</span>)<span class="sc">}</span><span class="ss">', header=true) as m</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="ss">WHERE m.Laname='</span><span class="sc">{</span>boro<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="ss">AND n."MSOA 2021 Code"=m.msoa11cd;</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="ss">'''</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>db.sql(query).to_df().head(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Found data/MSOA-Names-1.20.csv locally!
CPU times: user 22.5 ms, sys: 1.93 ms, total: 24.5 ms
Wall time: 23.8 ms</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="20">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">LAD 2021 Code</th>
<th data-quarto-table-cell-role="th">LAD 2021 Name</th>
<th data-quarto-table-cell-role="th">MSOA 2021 Code</th>
<th data-quarto-table-cell-role="th">MSOA 2021 Name</th>
<th data-quarto-table-cell-role="th">Total</th>
<th data-quarto-table-cell-role="th">F0 to 4</th>
<th data-quarto-table-cell-role="th">F5 to 9</th>
<th data-quarto-table-cell-role="th">F10 to 14</th>
<th data-quarto-table-cell-role="th">F15 to 19</th>
<th data-quarto-table-cell-role="th">F20 to 24</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">M75 to 79</th>
<th data-quarto-table-cell-role="th">M80 to 84</th>
<th data-quarto-table-cell-role="th">M85 to 89</th>
<th data-quarto-table-cell-role="th">M90 and over</th>
<th data-quarto-table-cell-role="th">msoa11cd</th>
<th data-quarto-table-cell-role="th">msoa11nm</th>
<th data-quarto-table-cell-role="th">msoa11nmw</th>
<th data-quarto-table-cell-role="th">msoa11hclnm</th>
<th data-quarto-table-cell-role="th">msoa11hclnmw</th>
<th data-quarto-table-cell-role="th">Laname</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>E09000031</td>
<td>Waltham Forest</td>
<td>E02000895</td>
<td>Waltham Forest 001</td>
<td>8363</td>
<td>208</td>
<td>233</td>
<td>250</td>
<td>228</td>
<td>215</td>
<td>...</td>
<td>194</td>
<td>137</td>
<td>93</td>
<td>45</td>
<td>E02000895</td>
<td>Waltham Forest 001</td>
<td>Waltham Forest 001</td>
<td>Chingford Green West</td>
<td>None</td>
<td>Waltham Forest</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>E09000031</td>
<td>Waltham Forest</td>
<td>E02000896</td>
<td>Waltham Forest 002</td>
<td>9322</td>
<td>256</td>
<td>278</td>
<td>264</td>
<td>230</td>
<td>241</td>
<td>...</td>
<td>190</td>
<td>111</td>
<td>111</td>
<td>54</td>
<td>E02000896</td>
<td>Waltham Forest 002</td>
<td>Waltham Forest 002</td>
<td>Chingford Green East</td>
<td>None</td>
<td>Waltham Forest</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>E09000031</td>
<td>Waltham Forest</td>
<td>E02000897</td>
<td>Waltham Forest 003</td>
<td>8438</td>
<td>233</td>
<td>262</td>
<td>276</td>
<td>212</td>
<td>209</td>
<td>...</td>
<td>98</td>
<td>104</td>
<td>87</td>
<td>24</td>
<td>E02000897</td>
<td>Waltham Forest 003</td>
<td>Waltham Forest 003</td>
<td>Friday Hill</td>
<td>None</td>
<td>Waltham Forest</td>
</tr>
</tbody>
</table>

<p>3 rows × 49 columns</p>
</div>
</div>
</div>
<p>The second way is a little easier to read, but it <em>only</em> allows you to do <strong>inner joins</strong> where attributes need to match in both tables for a row to be kept. This situation is such a common ‘use case’ that it makes sense to have this simpler syntax, but the previous code will work for inner, left, right, and outer joins.</p>
</section>
</section>
</section>
<section id="sec-spatial" class="level1">
<h1>Spatial Joins</h1>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Spatial DuckDB
</div>
</div>
<div class="callout-body-container callout-body">
<p>DuckDB also now supports spatial queries via the <a href="https://duckdb.org/docs/extensions/spatial.html"><code>SPATIAL</code> extension</a>. Performance is <em>not</em> that of a tuned Postgres+PostGIS database, but the overhead of <em>creating</em> such a tuned database often exceeds the benefit for ad-hoc querying. Basically, Postgres+PostGIS is great if you’re a company such as Booking.com, Airbnb, or OpenStreetMap, but it’s most likely overkill for offline read-oriented applications.</p>
</div>
</div>
<section id="why-obvious-is-not-always-right-part-432" class="level2">
<h2 class="anchored" data-anchor-id="why-obvious-is-not-always-right-part-432">Why obvious is not always right (Part 432)</h2>
<p>Building on what I said above in <a href="#sec-nonspatial" class="quarto-xref">Section&nbsp;3</a>, even where you <em>do</em> have a spatial challenge, it can be worth it to convert it to a non-spatial solution to improve the overall performance of your code. For instance, say you have data from LSOAs and want to be able to aggregate it up to MSOAs and Boroughs to perform various analyses.</p>
<div class="columns">
<div class="column" style="width:30%;">
<section id="lsoa-table" class="level4">
<h4 class="anchored" data-anchor-id="lsoa-table">LSOA Table</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: right;">LSOA Code</th>
<th style="text-align: right;">Polygon</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">LSOA1</td>
<td style="text-align: right;">WKT(…)</td>
</tr>
<tr class="even">
<td style="text-align: right;">LSOA2</td>
<td style="text-align: right;">WKT(…)</td>
</tr>
<tr class="odd">
<td style="text-align: right;">LSOA3</td>
<td style="text-align: right;">WKT(…)</td>
</tr>
</tbody>
</table>
</section>
</div><div class="column" style="width:5%;">

</div><div class="column" style="width:30%;">
<section id="msoa-table" class="level4">
<h4 class="anchored" data-anchor-id="msoa-table">MSOA Table</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: right;">MSOA Code</th>
<th style="text-align: right;">Polygon</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">MSOA1</td>
<td style="text-align: right;">WKT(…)</td>
</tr>
<tr class="even">
<td style="text-align: right;">MSOA2</td>
<td style="text-align: right;">WKT(…)</td>
</tr>
<tr class="odd">
<td style="text-align: right;">MSOA3</td>
<td style="text-align: right;">WKT(…)</td>
</tr>
</tbody>
</table>
</section>
</div><div class="column" style="width:5%;">

</div><div class="column" style="width:30%;">
<section id="borough-table" class="level4">
<h4 class="anchored" data-anchor-id="borough-table">Borough Table</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: right;">Borough Code</th>
<th style="text-align: right;">Polygon</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">BORO1</td>
<td style="text-align: right;">WKT(…)</td>
</tr>
<tr class="even">
<td style="text-align: right;">BORO2</td>
<td style="text-align: right;">WKT(…)</td>
</tr>
<tr class="odd">
<td style="text-align: right;">BORO3</td>
<td style="text-align: right;">WKT(…)</td>
</tr>
</tbody>
</table>
</section>
</div>
</div>
<p>The <em>obvious</em> way to do this is as a spatial join: <code>select all LSOAs within an MSOA and aggregate them</code>. And you would then run this same query for every dimension you want to aggregate. <strong>This is <em>not</em> the right way to tackle this problem</strong> even though you can write the query to give you the correct answer.</p>
<p>The <em>right</em> way when you are going to repeatedly run an expensive spatial query is to work out if you can ‘cache’ the result to save time in the future. In this case the answer is to create a ‘lookup table’ which uses the LSOA and MSOA and Borough codes to tell you if a LSOA falls inside a borough or MSOA. You perform the hard spatial query <em>just once</em> to create the lookup table, and thereafter you are using a fast non-spatial query.</p>
<p>In this case your lookup table will be this…</p>
<section id="lookup-table" class="level4">
<h4 class="anchored" data-anchor-id="lookup-table">Lookup Table</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: right;">LSOA Code</th>
<th style="text-align: right;">MSOA Code</th>
<th style="text-align: right;">Borough Code</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">LSOA1</td>
<td style="text-align: right;">MSOA1</td>
<td style="text-align: right;">BORO1</td>
</tr>
<tr class="even">
<td style="text-align: right;">LSOA2</td>
<td style="text-align: right;">MSOA1</td>
<td style="text-align: right;">BORO1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">LSOA3</td>
<td style="text-align: right;">MSOA2</td>
<td style="text-align: right;">BORO1</td>
</tr>
</tbody>
</table>
<p>Now you can do any kind of <em>spatial aggregation</em> you want without having to incur the costs of running a <em>spatial query</em> using something like:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb39-1"><a href="#cb39-1"></a><span class="kw">SELECT</span> m.<span class="ot">"MSOA Code"</span>, <span class="fu">SUM</span>(<span class="op">&lt;</span><span class="kw">attribute</span><span class="op">&gt;</span>) <span class="kw">as</span> feature_sum, <span class="fu">COUNT</span>(<span class="op">&lt;</span><span class="kw">attribute</span> <span class="dv">2</span><span class="op">&gt;</span>) <span class="kw">as</span> feature_count  </span>
<span id="cb39-2"><a href="#cb39-2"></a><span class="kw">FROM</span> <span class="op">&lt;</span>lsoa <span class="kw">data</span> <span class="kw">table</span><span class="op">&gt;</span> <span class="kw">as</span> l, <span class="op">&lt;</span>lookup <span class="kw">table</span><span class="op">&gt;</span> <span class="kw">as</span> lkp  </span>
<span id="cb39-3"><a href="#cb39-3"></a><span class="kw">WHERE</span> l.<span class="ot">"LSOA Code"</span> <span class="op">=</span> lkp.<span class="ot">"LSOA Code"</span> </span>
<span id="cb39-4"><a href="#cb39-4"></a><span class="kw">GROUP</span> <span class="kw">BY</span> lkp.<span class="ot">"MSOA Code"</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>See, no need for a spatial query and you can run the same query easily for many features. You can also use this as a foundation for creating a <code>VIEW</code> or a <code>MATERIALIZED VIEW</code>, but that’s an advanced topic for managing your data more efficiently in an operational environment rather than a research-oriented one.</p>
<p>But first, we need some actual geodata to work with:</p>
<div id="053f63ba" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>msoa_gpkg <span class="op">=</span> gpd.read_file( cache_data(<span class="ss">f'</span><span class="sc">{</span>host<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>path<span class="sc">}</span><span class="ss">/MSOA-2011.gpkg'</span>, ddir) ).to_crs(<span class="st">'epsg:27700'</span>)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>listings  <span class="op">=</span> gpd.read_parquet( cache_data(<span class="ss">f'</span><span class="sc">{</span>host<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>ymd<span class="sc">}</span><span class="ss">-listings.geoparquet'</span>, ddir) ).to_crs(<span class="st">'epsg:27700'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Found data/geo/MSOA-2011.gpkg locally!
Found data/geo/2023-09-06-listings.geoparquet locally!</code></pre>
</div>
</div>
</section>
</section>
<section id="in-geopandas" class="level2">
<h2 class="anchored" data-anchor-id="in-geopandas">In Geopandas</h2>
<p>Let’s try to find all of the listings that fall within the borough of Waltham Forest, so that implies two steps:</p>
<ol type="1">
<li>Subset the MSOA geo-data so that it only includes the Waltham Forest MSOAs.</li>
<li>Run a spatial query to find the listings that are within those MSOAs (we could, optionally, <code>union</code> the MSOAs to get the outline of the borough)</li>
</ol>
<div id="f6930f1b" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>boro <span class="op">=</span> <span class="st">'Waltham Forest'</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>boro_gdf <span class="op">=</span> msoa_gpkg[msoa_gpkg.LAD11NM<span class="op">==</span>boro].copy()</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Do the spatial join</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>boro_listings <span class="op">=</span> gpd.sjoin(listings, boro_gdf, predicate<span class="op">=</span><span class="st">'within'</span>, rsuffix<span class="op">=</span><span class="st">'_r'</span>)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Layer the plots</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>f, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>,<span class="dv">1</span>,figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">5</span>))</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>boro_gdf.plot(color<span class="op">=</span><span class="st">"white"</span>, edgecolor<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>, ax<span class="op">=</span>ax)</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>boro_listings.plot(column<span class="op">=</span><span class="st">'price'</span>, cmap<span class="op">=</span><span class="st">'viridis'</span>, legend<span class="op">=</span><span class="va">True</span>, s<span class="op">=</span><span class="fl">1.5</span>, aspect<span class="op">=</span><span class="dv">1</span>, ax<span class="op">=</span>ax)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Practical-08-Selecting_Data_files/figure-html/cell-23-output-1.png" width="375" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you get <code>ValueError: aspect must be finite and positive</code> when you try to make a plot (this seems fairly common with GeoPackages (<code>.gpkg</code> files) then you will need to specify <code>aspect=1</code> in the <code>plot(...)</code> command.</p>
</div>
</div>
</section>
<section id="in-sql-2" class="level2">
<h2 class="anchored" data-anchor-id="in-sql-2">In SQL</h2>
<p>After quite a bit of faff my conclusion is that, while you <em>can</em> do spatial queries in DuckDB it is a lot of work and <em>probably</em> not worth the effort <em>at this time</em>. The ‘issue’ is that spatial support (as well as Excel supprt) is provided via the <code>GDAL</code> framework and this takes quite a different approach. After working it out, spatial queries do work <em>fairly</em> well if you do them <em>entirely</em> within DuckDB (reading, merging, and writing the data) and then load the results in a separate step using GeoPandas; however, you <em>cannot</em> get a GeoDataFrame back via <code>db.query(&lt;query&gt;).to_df()</code> since that only returns a Pandas data frame and the geometry column is unreadable. In addition, geoparquet support seems limited while GeoPackage performance is <em>poor</em>, so you’re basically losing all the advantages of a parquet-based workflow.</p>
<p>So the examples below are provided for reference only and, on the whole, right now I’d recommend using GeoPandas and geoparquet files directly.</p>
<div id="37f5f41a" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>boro <span class="op">=</span> <span class="st">'Waltham Forest'</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f'''</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="ss">LOAD SPATIAL;</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="ss">COPY(</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="ss">  SELECT m.MSOA11CD, n.msoa11nm, n.Laname, m.geom </span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="ss">  FROM </span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="ss">      (SELECT MSOA11CD, geom FROM ST_Read("</span><span class="sc">{</span>cache_data(<span class="ss">f'</span><span class="sc">{</span>host<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>path<span class="sc">}</span><span class="ss">/MSOA-2011.gpkg'</span>, ddir)<span class="sc">}</span><span class="ss">")) AS m,</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="ss">      read_csv("</span><span class="sc">{</span>cache_data(msoa_names_url, <span class="st">'data'</span>)<span class="sc">}</span><span class="ss">") AS n</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a><span class="ss">  WHERE m.MSOA11CD=n.msoa11cd</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="ss">  AND n.Laname='</span><span class="sc">{</span>boro<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a><span class="ss">) TO 'data/geo/merged.gpkg' WITH (FORMAT GDAL, DRIVER 'GPKG', LAYER_CREATION_OPTIONS 'WRITE_BBOX=YES');</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a><span class="ss">'''</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>db.sql(query)</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>rs <span class="op">=</span> gpd.read_file(<span class="st">'data/geo/merged.gpkg'</span>)</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Result set has </span><span class="sc">{</span>rs<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss"> rows and </span><span class="sc">{</span>rs<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">:,}</span><span class="ss"> columns."</span>)</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>rs.head(<span class="dv">5</span>)</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>rs.plot(aspect<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Found data/geo/MSOA-2011.gpkg locally!
Found data/MSOA-Names-1.20.csv locally!
Result set has 28 rows and 4 columns.
CPU times: user 308 ms, sys: 38.1 ms, total: 346 ms
Wall time: 94.4 ms</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Practical-08-Selecting_Data_files/figure-html/cell-24-output-2.png" width="291" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="worked-example" class="level1">
<h1>Worked Example</h1>
<p>With that background material, let’s now work through a practical example.</p>
<section id="load-geodata" class="level2">
<h2 class="anchored" data-anchor-id="load-geodata">Load Geodata</h2>
<p>A lot of useful geo-data can be accessed from the <a href="https://geoportal.statistics.gov.uk/">GeoPortal</a>. And see also <a href="https://jreades.github.io/fsds/sessions/week8.html">my discussion</a> on <a href="https://geoportal.statistics.gov.uk/datasets/postcode-to-output-area-to-lower-layer-super-output-area-to-middle-layer-super-output-area-to-local-authority-district-november-2018-lookup-in-the-uk-2/about">lookup tables</a>.</p>
<div id="6927028e" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>spath <span class="op">=</span> <span class="st">'https://github.com/jreades/fsds/blob/master/data/src/'</span> <span class="co"># source path</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>water <span class="op">=</span> gpd.read_file( cache_data(spath<span class="op">+</span><span class="st">'Water.gpkg?raw=true'</span>, ddir) )</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>boros <span class="op">=</span> gpd.read_file( cache_data(spath<span class="op">+</span><span class="st">'Boroughs.gpkg?raw=true'</span>, ddir) )</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>green <span class="op">=</span> gpd.read_file( cache_data(spath<span class="op">+</span><span class="st">'Greenspace.gpkg?raw=true'</span>, ddir) )</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>msoas <span class="op">=</span> gpd.read_file( cache_data(<span class="ss">f'</span><span class="sc">{</span>host<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>path<span class="sc">}</span><span class="ss">/MSOA-2011.gpkg'</span>, ddir) ).to_crs(<span class="st">'epsg:27700'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Found data/geo/Water.gpkg locally!
Found data/geo/Boroughs.gpkg locally!
Found data/geo/Greenspace.gpkg locally!
Found data/geo/MSOA-2011.gpkg locally!</code></pre>
</div>
</div>
</section>
<section id="select-london-msoas" class="level2">
<h2 class="anchored" data-anchor-id="select-london-msoas">Select London MSOAs</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
🔗 Connections
</div>
</div>
<div class="callout-body-container callout-body">
<p>One thing to remember here is that computers are <em>exact</em>. So if you say that the selection should only be of MSOAs <em>within</em> London then you actually need to think about whether a shared border qualifies as ‘within’. Watch <a href="https://jreades.github.io/fsds/sessions/week10.html#lectures">the lectures</a> again if you’re unsure, but that’s why here we take this slightly clunk approach of buffering the London boundary <em>before</em> doing the selection.</p>
</div>
</div>
<section id="union" class="level3">
<h3 class="anchored" data-anchor-id="union">Union</h3>
<p>As we don’t have a boundary file for London, we can <em>generate</em> use using the <code>unary_union</code> operator (as we do here) or using the <a href="https://geopandas.org/en/stable/docs/user_guide/aggregation_with_dissolve.html">dissolve()</a> approach. Consider the pros and cons of each approach in terms of performance, output format, and leigibility.</p>
<p>So here’s approach 1, which is a method call returning a GeoDataFrame (which is why we can call <code>plot</code>):</p>
<div id="c77bf835" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>boros.dissolve().plot()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Practical-08-Selecting_Data_files/figure-html/cell-26-output-1.png" width="558" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>And here’s approach 2, which is an <em>attribute</em> and returns a raw polygon (so no reason to call <code>plot</code>, but it’s come back without the rest of the data frame!):</p>
<div id="235a7852" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>boros.unary_union</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<div>
<figure class="figure">
<p><img src="Practical-08-Selecting_Data_files/figure-html/cell-27-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
🔗 Connections
</div>
</div>
<div class="callout-body-container callout-body">
<p>Notice how we’re also demonstrating some additional ways of plotting ‘on the fly’ (without generating a data frame) as well as (below) showing you how to zoom in/out.</p>
</div>
</div>
<div id="923529af" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>ldn <span class="op">=</span> gpd.GeoDataFrame(gpd.GeoSeries(data<span class="op">=</span>boros.unary_union)).rename(columns<span class="op">=</span>{<span class="dv">0</span>:<span class="st">'geometry'</span>}).set_geometry(<span class="st">"geometry"</span>)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>ldn <span class="op">=</span> ldn.set_crs(epsg<span class="op">=</span><span class="dv">27700</span>)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>ax  <span class="op">=</span> ldn.plot(facecolor<span class="op">=</span>(<span class="fl">.5</span>, <span class="fl">.5</span>, <span class="fl">.9</span>, <span class="fl">.5</span>))</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>msoas.plot(ax<span class="op">=</span>ax, facecolor<span class="op">=</span><span class="st">'none'</span>, edgecolor<span class="op">=</span>(<span class="fl">.6</span>, <span class="fl">.6</span>, <span class="fl">.6</span>, <span class="fl">.6</span>))</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(<span class="dv">500000</span>, <span class="dv">515000</span>)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(<span class="dv">180000</span>, <span class="dv">195000</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Practical-08-Selecting_Data_files/figure-html/cell-28-output-1.png" width="450" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="a-bad-first-join" class="level3">
<h3 class="anchored" data-anchor-id="a-bad-first-join">A (Bad) First Join</h3>
<div id="75ff07e9" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>ldn_msoas <span class="op">=</span> gpd.sjoin(msoas, ldn, predicate<span class="op">=</span><span class="st">'within'</span>, how<span class="op">=</span><span class="st">'inner'</span>)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> ldn.plot(facecolor<span class="op">=</span>(<span class="fl">.5</span>, <span class="fl">.5</span>, <span class="fl">.9</span>, <span class="fl">.5</span>))</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>ldn_msoas.plot(ax<span class="op">=</span>ax, facecolor<span class="op">=</span><span class="st">'none'</span>, edgecolor<span class="op">=</span>(<span class="fl">.8</span>, <span class="fl">.4</span>, <span class="fl">.4</span>), linewidth<span class="op">=</span><span class="fl">0.75</span>)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(<span class="dv">500000</span>, <span class="dv">515000</span>)</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(<span class="dv">180000</span>, <span class="dv">195000</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Practical-08-Selecting_Data_files/figure-html/cell-29-output-1.png" width="450" height="411" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What has gone wrong???
</div>
</div>
<div class="callout-body-container callout-body">
<p>Before you move on to the solution, stop and actually <em>think</em> about what this hasn’t done what you would have expected? THis is another reason that you need to pay attention to the differences between spatial and non-spatial joins.</p>
</div>
</div>
</section>
<section id="buffer-and-join" class="level3">
<h3 class="anchored" data-anchor-id="buffer-and-join">Buffer and Join</h3>
<p>In order to ensure that we get all the MSOAs <em>within</em> London we need to buffer the boundary by some amount to ensure that <code>within</code> returns what we want. If <em>cover</em> were easier to use then that option might be preferable.</p>
<section class="level4 qna-question">
<h4 class="qna-question anchored" data-anchor-id="">Question</h4>
<div class="cell">
<div class="sourceCode" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>ldn[<span class="st">'buffered'</span>] <span class="op">=</span> ldn.geometry.???(???)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>ldn <span class="op">=</span> ldn.set_geometry(<span class="st">'buffered'</span>).set_crs(epsg<span class="op">=</span><span class="dv">27700</span>)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>ax  <span class="op">=</span> ldn.plot(facecolor<span class="op">=</span>(<span class="fl">.5</span>, <span class="fl">.5</span>, <span class="fl">.9</span>, <span class="fl">.5</span>))</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>msoas.plot(ax<span class="op">=</span>ax, facecolor<span class="op">=</span><span class="st">'none'</span>, edgecolor<span class="op">=</span>(<span class="fl">.6</span>, <span class="fl">.6</span>, <span class="fl">.6</span>, <span class="fl">.6</span>))</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(<span class="dv">500000</span>, <span class="dv">515000</span>)</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(<span class="dv">180000</span>, <span class="dv">195000</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>By default we want do an <em>inner</em> join because we want to drop everything that doesn’t line up between the two data sets (i.e.&nbsp;don’t keep the thousands of <em>other</em> non-London MSOAs).</p>
</section>
<section class="level4 qna-question">
<h4 class="qna-question anchored" data-anchor-id="">Question</h4>
<div class="cell">
<div class="sourceCode" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>ldn_msoas <span class="op">=</span> gpd.sjoin(msoas, ldn, predicate<span class="op">=</span><span class="st">'???'</span>, how<span class="op">=</span><span class="st">'inner'</span>)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>ldn_msoas.plot()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section class="level4 qna-question">
<h4 class="qna-question anchored" data-anchor-id="">Question</h4>
<p>Hmmmm, not quite what you were expecting? See if you can figure out from the list of columns and the documentation for <code>set_geometry</code> what is going wrong? This might also help:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">", "</span>.join(ldn_msoas.columns.to_list()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MSOA11CD, MSOA11NM, LAD11CD, LAD11NM, RGN11CD, RGN11NM, USUALRES, HHOLDRES, COMESTRES, POPDEN, HHOLDS, AVHHOLDSZ, geometry_left, index_right, geometry_right</code></pre>
</div>
</div>
<p>The issue arises because we’ve joined two geo-data frames but the join function comes from pandas, which doesn’t know anything about spatial data and we have therefore ‘lost track’ of the column in which the geometry is stored. <em>Worse</em>, there are actually two geometry columns now, so we need to tell Geopandas which one to use!</p>
<p>The easiest way to do this is to simply rename the geometry we <em>want</em> and then set is as the active geometry:</p>
<div id="6f4c6e86" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>ldn_msoas <span class="op">=</span> ldn_msoas.rename(columns<span class="op">=</span>{<span class="st">'geometry_left'</span>:<span class="st">'geometry'</span>}).set_geometry(<span class="st">'geometry'</span>)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>ldn_msoas.drop(columns<span class="op">=</span><span class="st">'geometry_right'</span>, inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We also no longer really need to keep the full MSOA data set hanging about.</p>
<div id="07620487" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">del</span>(msoas)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">NameError</span>:</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"msoas already deleted."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section class="level4 qna-question">
<h4 class="qna-question anchored" data-anchor-id="">Question</h4>
<ul>
<li>Can you explain <em>why</em> the outputs of the <code>dissolve</code> and <code>unary_union</code> <em>look</em> differnet? And use that as the basis for explaining why they <em>are</em> different?</li>
</ul>
<blockquote class="blockquote">
<p>Answer 1</p>
</blockquote>
<ul>
<li>How do you know that the units for the buffering operation are metres? 250 could be <em>anything</em> right?</li>
</ul>
<blockquote class="blockquote">
<p>Answer 2</p>
</blockquote>
<ul>
<li>Why do we need to buffer the London geometry <em>before</em> performing the <em>within</em> spatial join?</li>
</ul>
<blockquote class="blockquote">
<p>Answer 3</p>
</blockquote>
</section>
</section>
</section>
<section id="append-or-derive-names" class="level2">
<h2 class="anchored" data-anchor-id="append-or-derive-names">Append or Derive Names</h2>
<p>We don’t actually make use of these in this session, but <em>both</em> operations could be relevant to your final reports:</p>
<ol type="1">
<li>The Borough-to-Subregion mapping could help you to group your data into larger sets so that your resulst become more reobust. it also connects us to long-run patterns of socio-economic development in London.</li>
<li>The MSOA Names data set (which you used above) gives you something that you could use to label one or more ‘neighbourhoods’ on a map with names that are <em>relevant</em>. So rather than talking about “As you can see, Sutton 003, is…”, you can write “The Wrythe neighbourhood [or area] of Sutton is significantly different from the surrounding areas…”</li>
</ol>
<p>They also usefully test your understanding of regular expressions and a few other aspects covered in previous weeks.</p>
<section id="replace" class="level3">
<h3 class="anchored" data-anchor-id="replace">Replace</h3>
<p>You’ve done this before: notice that the MSOA Name <em>contains</em> the Borough name <strong>with a space and some digits at the end</strong>. Use a regex (in <code>str.replace()</code>) to extract the LA name from the MSOA name. See if you do this <em>without</em> having to find your previous answer!</p>
<section class="level4 qna-question">
<h4 class="qna-question anchored" data-anchor-id="">Question</h4>
<div class="cell">
<div class="sourceCode" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>ldn_msoas[<span class="st">'Borough'</span>] <span class="op">=</span> ldn_msoas.MSOA11NM.<span class="bu">str</span>.replace(<span class="vs">r'???'</span>,<span class="st">''</span>,regex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Just check results look plausible; you should have:</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="co"># - 33 boroughs</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="co"># - A df shape of 983 x 13</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(ldn_msoas.Borough.unique())</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"There are </span><span class="sc">{</span><span class="bu">len</span>(ldn_msoas.Borough.unique())<span class="sc">}</span><span class="ss"> boroughs."</span>)</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Overall shape of data frame is </span><span class="sc">{</span><span class="st">' x '</span><span class="sc">.</span>join([<span class="bu">str</span>(x) <span class="cf">for</span> x <span class="kw">in</span> ldn_msoas.shape])<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="map" class="level3">
<h3 class="anchored" data-anchor-id="map">Map</h3>
<p>Now that we’ve got the borough names we can set up a <code>mapping</code> dict here so that we can apply it as part of the <code>groupby</code> operation below (you should have 33 keys when done):</p>
<div id="f80318a1" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>mapping <span class="op">=</span> {}</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> b <span class="kw">in</span> [<span class="st">'Enfield'</span>,<span class="st">'Waltham Forest'</span>,<span class="st">'Redbridge'</span>,<span class="st">'Barking and Dagenham'</span>,<span class="st">'Havering'</span>,<span class="st">'Greenwich'</span>,<span class="st">'Bexley'</span>]:</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    mapping[b]<span class="op">=</span><span class="st">'Outer East and North East'</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> b <span class="kw">in</span> [<span class="st">'Haringey'</span>,<span class="st">'Islington'</span>,<span class="st">'Hackney'</span>,<span class="st">'Tower Hamlets'</span>,<span class="st">'Newham'</span>,<span class="st">'Lambeth'</span>,<span class="st">'Southwark'</span>,<span class="st">'Lewisham'</span>]:</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>    mapping[b]<span class="op">=</span><span class="st">'Inner East'</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> b <span class="kw">in</span> [<span class="st">'Bromley'</span>,<span class="st">'Croydon'</span>,<span class="st">'Sutton'</span>,<span class="st">'Merton'</span>,<span class="st">'Kingston upon Thames'</span>]:</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    mapping[b]<span class="op">=</span><span class="st">'Outer South'</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> b <span class="kw">in</span> [<span class="st">'Wandsworth'</span>,<span class="st">'Kensington and Chelsea'</span>,<span class="st">'Hammersmith and Fulham'</span>,<span class="st">'Westminster'</span>,<span class="st">'Camden'</span>]:</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>    mapping[b]<span class="op">=</span><span class="st">'Inner West'</span></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> b <span class="kw">in</span> [<span class="st">'Richmond upon Thames'</span>,<span class="st">'Hounslow'</span>,<span class="st">'Ealing'</span>,<span class="st">'Hillingdon'</span>,<span class="st">'Brent'</span>,<span class="st">'Harrow'</span>,<span class="st">'Barnet'</span>,<span class="st">'City of London'</span>]:</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>    mapping[b]<span class="op">=</span><span class="st">'Outer West and North West'</span></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">len</span>(mapping.keys()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>33</code></pre>
</div>
</div>
<section class="level4 qna-question">
<h4 class="qna-question anchored" data-anchor-id="">Question</h4>
<div class="cell">
<div class="sourceCode" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>ldn_msoas[<span class="st">'Subregion'</span>] <span class="op">=</span> ldn_msoas.Borough.<span class="bu">map</span>(???)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="and-save" class="level3">
<h3 class="anchored" data-anchor-id="and-save">And Save</h3>
<div id="244a7de5" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>ldn_msoas.to_parquet(os.path.join(<span class="st">'data'</span>,<span class="st">'geo'</span>,<span class="st">'London_MSOA_Names.geoparquet'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="load-insideairbnb-data" class="level2">
<h2 class="anchored" data-anchor-id="load-insideairbnb-data">Load InsideAirbnb Data</h2>
<div id="d10bafd0" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>listings <span class="op">=</span> gpd.read_parquet( cache_data(<span class="ss">f'</span><span class="sc">{</span>host<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>ymd<span class="sc">}</span><span class="ss">-listings.geoparquet'</span>, ddir) ).to_crs(epsg<span class="op">=</span><span class="dv">27700</span>)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Data frame is </span><span class="sc">{</span>listings<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss"> x </span><span class="sc">{</span>listings<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Found data/geo/2023-09-06-listings.geoparquet locally!
Data frame is 85,134 x 31</code></pre>
</div>
</div>
<section id="spatial-join" class="level3">
<h3 class="anchored" data-anchor-id="spatial-join">Spatial Join</h3>
<p>Associate LA (Local Authority) names to the listings using a spatial join, but <strong>notice</strong> the <code>how</code> here:</p>
<section class="level4 qna-question">
<h4 class="qna-question anchored" data-anchor-id="">Question</h4>
<div class="cell">
<div class="sourceCode" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>gdf_la <span class="op">=</span> gpd.sjoin(listings, ???, predicate<span class="op">=</span><span class="st">'???'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(gdf_la.columns.to_list())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="tidy-up" class="level3">
<h3 class="anchored" data-anchor-id="tidy-up">Tidy Up</h3>
<div id="ed0e6640" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>gdf_la.drop(columns<span class="op">=</span>[<span class="st">'index_right'</span>,<span class="st">'HECTARES'</span>,<span class="st">'NONLD_AREA'</span>,<span class="st">'ONS_INNER'</span>], inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You’ll need to look closely to check that the <code>value_counts</code> output squares with your expectations. If you don’t get <code>33</code> then there’s an issue and you’ll need to run the code in <a href="#sec-problems" class="quarto-xref">Section&nbsp;5.4.3</a>:</p>
<div id="e7090ea1" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(gdf_la.NAME.unique()) <span class="op">==</span> <span class="dv">33</span>:</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"All good..."</span>)</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Need to run the next section of code..."</span>)</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Now there are... </span><span class="sc">{</span><span class="bu">len</span>(gdf_la.NAME.unique())<span class="sc">}</span><span class="ss"> boroughs?"</span>)</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>    gdf_la.NAME.value_counts(dropna<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>All good...</code></pre>
</div>
</div>
</section>
<section id="sec-problems" class="level3">
<h3 class="anchored" data-anchor-id="sec-problems">Find Problematic Listings</h3>
<p>If you were told that you need to run the next sectin of code then see if you can work out what happened…</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(gdf_la[gdf_la.NAME.isna()].sample(<span class="dv">2</span>)[[<span class="st">'name'</span>, <span class="st">'NAME'</span>]])</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> gdf_la[gdf_la.NAME.isna()].plot(figsize<span class="op">=</span>(<span class="dv">9</span>,<span class="dv">6</span>), markersize<span class="op">=</span><span class="dv">5</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    boros.plot(ax<span class="op">=</span>ax, edgecolor<span class="op">=</span><span class="st">'r'</span>, facecolor<span class="op">=</span><span class="st">'None'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)<span class="op">;</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ValueError</span> <span class="im">as</span> e:</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>   <span class="cf">pass</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In short: in some cases there may be records that fall outside of London because of Airbnb’s shuffling approach:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>gdf_la.drop(index<span class="op">=</span>gdf_la[gdf_la.NAME.isna()].index, axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Data frame is </span><span class="sc">{</span>gdf_la<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss"> x </span><span class="sc">{</span>gdf_la<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="check-and-save" class="level3">
<h3 class="anchored" data-anchor-id="check-and-save">Check and Save</h3>
<div class="sourceCode" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> gdf_la.plot(column<span class="op">=</span><span class="st">'NAME'</span>, markersize<span class="op">=</span><span class="fl">0.5</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, figsize<span class="op">=</span>(<span class="dv">9</span>,<span class="dv">7</span>))</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>boros.plot(ax<span class="op">=</span>ax, edgecolor<span class="op">=</span><span class="st">'r'</span>, facecolor<span class="op">=</span><span class="st">'None'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You should get the following:</p>
<div id="d0236c16" class="cell" data-execution_count="43">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Practical-08-Selecting_Data_files/figure-html/cell-44-output-1.png" width="749" height="559" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div class="sourceCode" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>gdf_la.to_parquet(os.path.join(<span class="st">'data'</span>,<span class="st">'geo'</span>,<span class="st">'Listings_with_LA.geoparquet'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section class="level4 qna-question">
<h4 class="qna-question anchored" data-anchor-id="">Question</h4>
<ul>
<li>Do you understand the difference between <code>how='inner'</code> and <code>how='left'</code>?</li>
</ul>
<blockquote class="blockquote">

</blockquote>
</section>
</section>
</section>
<section id="create-la-data" class="level2">
<h2 class="anchored" data-anchor-id="create-la-data">Create LA Data</h2>
<p>Now that we’ve assigned every listing to a borough, we can derive aggregate values for different groups of zones.</p>
<section id="select-la" class="level3">
<h3 class="anchored" data-anchor-id="select-la">Select LA</h3>
<p>Select a LA that is relevant to <em>you</em> to explore further…</p>
<div id="f36ba997" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>LA <span class="op">=</span> <span class="st">'Waltham Forest'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="spatial-join-1" class="level3">
<h3 class="anchored" data-anchor-id="spatial-join-1">Spatial Join</h3>
<p>The first thing we want to do is join MSOA identifiers to each listing. In both cases we want to constrain the data to only be for ‘our’ LA of interest since that will speed up the process substantially:</p>
<div id="8594345e" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>gdf_msoa <span class="op">=</span> gpd.sjoin(</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>            gdf_la[gdf_la.NAME<span class="op">==</span>LA].reset_index(), </span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>            ldn_msoas[ldn_msoas.Borough<span class="op">==</span>LA][[<span class="st">'MSOA11CD'</span>,<span class="st">'MSOA11NM'</span>,<span class="st">'USUALRES'</span>,<span class="st">'HHOLDS'</span>,<span class="st">'Subregion'</span>,<span class="st">'geometry'</span>]], predicate<span class="op">=</span><span class="st">'within'</span>)</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>gdf_msoa.head(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="45">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">listing_url</th>
<th data-quarto-table-cell-role="th">last_scraped</th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">description</th>
<th data-quarto-table-cell-role="th">host_id</th>
<th data-quarto-table-cell-role="th">host_name</th>
<th data-quarto-table-cell-role="th">host_since</th>
<th data-quarto-table-cell-role="th">host_location</th>
<th data-quarto-table-cell-role="th">host_is_superhost</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">reviews_per_month</th>
<th data-quarto-table-cell-role="th">geometry</th>
<th data-quarto-table-cell-role="th">NAME</th>
<th data-quarto-table-cell-role="th">GSS_CODE</th>
<th data-quarto-table-cell-role="th">index_right</th>
<th data-quarto-table-cell-role="th">MSOA11CD</th>
<th data-quarto-table-cell-role="th">MSOA11NM</th>
<th data-quarto-table-cell-role="th">USUALRES</th>
<th data-quarto-table-cell-role="th">HHOLDS</th>
<th data-quarto-table-cell-role="th">Subregion</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>41870</td>
<td>https://www.airbnb.com/rooms/41870</td>
<td>2023-09-07</td>
<td>Home in Walthamstow · 2 bedrooms · 1 bed · 2.5...</td>
<td>Lovely friendly house, close to central line u...</td>
<td>182993</td>
<td>Bimpe</td>
<td>2010-07-27</td>
<td>London, United Kingdom</td>
<td>False</td>
<td>...</td>
<td>0.01</td>
<td>POINT (538919.280 186290.652)</td>
<td>Waltham Forest</td>
<td>E09000031</td>
<td>888</td>
<td>E02000921</td>
<td>Waltham Forest 027</td>
<td>11001</td>
<td>3966</td>
<td>Outer East and North East</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>78606</td>
<td>https://www.airbnb.com/rooms/78606</td>
<td>2023-09-07</td>
<td>Rental unit in Walthamstow · 1 bedroom · 1 pri...</td>
<td>Comfortable, modern home with a friendly host ...</td>
<td>422362</td>
<td>Nicola</td>
<td>2011-03-04</td>
<td>London, United Kingdom</td>
<td>False</td>
<td>...</td>
<td>0.04</td>
<td>POINT (539419.512 187953.652)</td>
<td>Waltham Forest</td>
<td>E09000031</td>
<td>882</td>
<td>E02000915</td>
<td>Waltham Forest 021</td>
<td>8643</td>
<td>3305</td>
<td>Outer East and North East</td>
</tr>
</tbody>
</table>

<p>2 rows × 40 columns</p>
</div>
</div>
</div>
</section>
<section id="aggregate" class="level3">
<h3 class="anchored" data-anchor-id="aggregate">Aggregate</h3>
<p>Now aggregate the data by MSOA, deriving median price and a count of the listings:</p>
<div id="f321cd09" class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>grdf_msoa <span class="op">=</span> gdf_msoa.groupby(<span class="st">'MSOA11NM'</span>).agg(</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>    listing_count <span class="op">=</span> (<span class="st">'price'</span>,<span class="st">'count'</span>),</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>    median_price <span class="op">=</span> (<span class="st">'price'</span>,<span class="st">'median'</span>)</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>).reset_index()</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Have </span><span class="sc">{</span>grdf_msoa<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss"> rows and </span><span class="sc">{</span>grdf_msoa<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">:,}</span><span class="ss"> columns"</span>)</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>grdf_msoa.head(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Have 28 rows and 3 columns</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="46">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">MSOA11NM</th>
<th data-quarto-table-cell-role="th">listing_count</th>
<th data-quarto-table-cell-role="th">median_price</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Waltham Forest 001</td>
<td>17</td>
<td>97.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Waltham Forest 002</td>
<td>14</td>
<td>58.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="join-again" class="level3">
<h3 class="anchored" data-anchor-id="join-again">Join (Again)</h3>
<p>Here we see the <strong>difference between merge and join</strong>. You’ll notice that <code>join</code> operates by taking one data frame as the implicit ‘<em>left</em>’ table (the one which <em>calls</em> join) while the one that is passed to the join function is, implicitly, the ‘<em>right</em>’ table. Join operates only using indexes, so you’ll need to insert the code to specify the same index on both data frames, but this can be done <strong>on-the-fly</strong> as part of the joining operation:</p>
<div id="e79ef444" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>msoa_gdf <span class="op">=</span> grdf_msoa.set_index(<span class="st">'MSOA11NM'</span>).join(</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>                ldn_msoas[ldn_msoas.Borough<span class="op">==</span>LA].set_index(<span class="st">'MSOA11NM'</span>), </span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>                rsuffix<span class="op">=</span><span class="st">'_r'</span>).set_geometry(<span class="st">'geometry'</span>)</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>msoa_gdf.head(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">listing_count</th>
<th data-quarto-table-cell-role="th">median_price</th>
<th data-quarto-table-cell-role="th">MSOA11CD</th>
<th data-quarto-table-cell-role="th">LAD11CD</th>
<th data-quarto-table-cell-role="th">LAD11NM</th>
<th data-quarto-table-cell-role="th">RGN11CD</th>
<th data-quarto-table-cell-role="th">RGN11NM</th>
<th data-quarto-table-cell-role="th">USUALRES</th>
<th data-quarto-table-cell-role="th">HHOLDRES</th>
<th data-quarto-table-cell-role="th">COMESTRES</th>
<th data-quarto-table-cell-role="th">POPDEN</th>
<th data-quarto-table-cell-role="th">HHOLDS</th>
<th data-quarto-table-cell-role="th">AVHHOLDSZ</th>
<th data-quarto-table-cell-role="th">geometry</th>
<th data-quarto-table-cell-role="th">index_right</th>
<th data-quarto-table-cell-role="th">Borough</th>
<th data-quarto-table-cell-role="th">Subregion</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">MSOA11NM</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Waltham Forest 001</td>
<td>17</td>
<td>97.0</td>
<td>E02000895</td>
<td>E09000031</td>
<td>Waltham Forest</td>
<td>E12000007</td>
<td>London</td>
<td>7979</td>
<td>7962</td>
<td>17</td>
<td>36.4</td>
<td>3271</td>
<td>2.4</td>
<td>MULTIPOLYGON (((537919.442 195742.428, 538051....</td>
<td>0</td>
<td>Waltham Forest</td>
<td>Outer East and North East</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Waltham Forest 002</td>
<td>14</td>
<td>58.0</td>
<td>E02000896</td>
<td>E09000031</td>
<td>Waltham Forest</td>
<td>E12000007</td>
<td>London</td>
<td>8814</td>
<td>8719</td>
<td>95</td>
<td>31.3</td>
<td>3758</td>
<td>2.3</td>
<td>MULTIPOLYGON (((539172.688 195540.000, 539696....</td>
<td>0</td>
<td>Waltham Forest</td>
<td>Outer East and North East</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Waltham Forest 003</td>
<td>7</td>
<td>89.0</td>
<td>E02000897</td>
<td>E09000031</td>
<td>Waltham Forest</td>
<td>E12000007</td>
<td>London</td>
<td>8077</td>
<td>7991</td>
<td>86</td>
<td>42.9</td>
<td>3345</td>
<td>2.4</td>
<td>MULTIPOLYGON (((538862.624 194017.438, 539001....</td>
<td>0</td>
<td>Waltham Forest</td>
<td>Outer East and North East</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="sourceCode" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>msoa_gdf.plot(column<span class="op">=</span><span class="st">'median_price'</span>, legend<span class="op">=</span><span class="va">True</span>, figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You should get something like:</p>
<div id="470ede2c" class="cell" data-execution_count="48">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Practical-08-Selecting_Data_files/figure-html/cell-49-output-1.png" width="492" height="633" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="save" class="level3">
<h3 class="anchored" data-anchor-id="save">Save</h3>
<p>Just so that we can pick up here without having to re-run all the preceding cells.</p>
<div id="eb5b897e" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>msoa_gdf.to_parquet(os.path.join(<span class="st">'data'</span>,<span class="st">'geo'</span>,<span class="ss">f'</span><span class="sc">{</span>LA<span class="sc">}</span><span class="ss">-MSOA_data.geoparquet'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section class="level4 qna-question">
<h4 class="qna-question anchored" data-anchor-id="">Question</h4>
<ul>
<li>Do you understand the differences between <code>pd.merge</code> and <code>df.join</code>? and <code>gpd.sjoin</code>?</li>
</ul>
<blockquote class="blockquote">

</blockquote>
<ul>
<li>Do you understand why it may be necessary to <code>set_geometry</code> in some cases?</li>
</ul>
<blockquote class="blockquote">

</blockquote>


</section>
</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 2022, Jon Reades</p>
</div>   
    <div class="nav-footer-center">
<p><img src="../img/favicon-16x16.png" class="height:10px img-fluid"> Foundations of Spatial Data Science</p>
<div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/jreades/fsds/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/jreades/fsds">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/jreades">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>